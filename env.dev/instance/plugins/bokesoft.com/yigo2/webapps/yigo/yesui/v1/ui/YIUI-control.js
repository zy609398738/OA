var YIUI=YIUI||{};var UI=UI||{};var Svr=Svr||{};(function(){var b=0;YIUI.allotId=function(){b++;return"c-"+b;};var a=false;YIUI.extend=function(d,f){if(typeof(d)==="object"){f=d;d=null;}function e(){if(!a){if(d){this.baseprototype=d.prototype;}this.init.apply(this,arguments);}}if(d){a=true;e.prototype=new d();e.prototype.constructor=e;a=false;}for(var c in f){if(f.hasOwnProperty(c)){if(d&&typeof(f[c])==="function"&&typeof(e.prototype[c])==="function"){e.prototype[c]=(function(g,h){return function(){this.base=d.prototype[g];return h.apply(this,arguments);};})(c,f[c]);}else{e.prototype[c]=f[c];}}}return e;};})();(function(b,c){var a=navigator.userAgent.toLowerCase();b.extend(b,{browser:{isIE:/msie/.test(navigator.userAgent.toLowerCase())||/rv:([\d.]+)\) like gecko/.test(navigator.userAgent.toLowerCase()),isSafari:/webkit/.test(a),opera:/opera/.test(a),isMozilla:/mozilla/.test(a)&&!/(compatible|webkit)/.test(a),version:(navigator.userAgent.toLowerCase().match(/.+(?:msie|firefox|opera|chrome|netscape)[/: ]([\d.]+)/)||[])[1]},isDefined:function(d){return typeof d!="undefined";},isObject:function(d){return d&&typeof d=="object";},isString:function(d){return d&&typeof d=="string";},isPercentage:function(d){return d&&/^(\d{1,2}%)$|^(100%)$/.test(d);},getReal:function(f,e){if(!b.isDefined(f)||f==null||f<=0){return"auto";}var g;if(b.isNumeric(f)&&f>1){g=f;}else{if(b.isNumeric(f)&&f<=1){var d=parseFloat(f,10);g=e*d;}else{if(b.isPercentage(f)){var d=parseFloat(f,10)/100;g=e*d;}else{g=parseInt(f,10);}}}return Math.floor(g);},getBody:function(){return b(document.body||document.documentElement);},escapeRe:function(d){return d.replace(/([-.*+?^${}()|[\]\/\\])/g,"\\$1");},destroy:function(e){for(var d in e){delete e[d];}},trim:function(d){return d.replace(/(^\s*)|(\s*$)/g,"");},capitalizeFirst:function(d){return d.charAt(0).toUpperCase()+d.slice(1);},lowerFirst:function(d){return d.charAt(0).toLowerCase()+d.slice(1);},getZindex:function(e){var d,f;while(e.length&&e[0]!==document){d=e.css("position");if(d==="absolute"||d==="relative"||d==="fixed"){f=parseInt(e.css("zIndex"),10);if(!isNaN(f)&&f!==0){return f;}}e=e.parent();}return 0;},checkFile:function(d,j,i){if(!j||j==-1){return true;}var k;var n=0;if(b.browser.isIE){var e=d[0].value;var l=new ActiveXObject("Scripting.FileSystemObject");var h=l.GetFile(e);n=h.Size/1024;var g=h.Name;k=g.substring(g.lastIndexOf(".")+1);}else{n=d[0].files[0].size/1024;var m=d.val().toLowerCase();k=m.substring(m.lastIndexOf(".")+1);}if(n>j){b.error("超出指定大小！! ("+j+"KB)");return false;}if(i&&b.inArray(k,i)==-1){b.error("非指定文件类型！！ ("+i+")");return false;}return true;},getUrlParam:function(d){var e=new RegExp("(^|&)"+d+"=([^&]*)(&|$)");var f=window.location.search.substr(1).match(e);if(f!=null){return unescape(f[2]);}return null;},InputMask:{getCursor:function(j){var h=new Object();var k=0,d=0;if(b.browser.isIE){var f=j.createTextRange();var i=f.text;var g=document.selection.createRange();var e=g.text;g.moveStart("character",-j.value.length);k=j.value.length;d=e.length;}else{k=j.selectionStart;d=j.selectionEnd;}h.start=k;h.end=d;return h;}}});b.extend(b.fn,{cssNum:function(f,e){var d=parseFloat(this.css(f));return b.isNumeric(d)?d:(e||0);},destroy:function(){this.unbind();this.remove();},nextUntilFn:function(e,h){var f=this.nextAll(e);if(h){for(var g=0,d=f.length;g<d;g++){if(h.call(f[g])===false){f.length=g;break;}}}return f;},filterInput:function(f,e,d){if(!f){return this;}b.each(this,function(){var g=new RegExp("[^"+b.escapeRe(f)+"]");var h=new RegExp("["+b.escapeRe(f)+"]","g");var i,j;b(this).keypress(function(l){var m=String.fromCharCode((l.which||l.keyCode));m=e==YIUI.TEXTEDITOR_CASE.UPPER?m.toUpperCase():(e==YIUI.TEXTEDITOR_CASE.LOWER?m.toLowerCase():m);if(!g.test(m)){l.preventDefault();}var k="";if(b.browser.isIE){if(document.selection&&document.selection.createRange){k=document.selection.createRange().text;}}else{k=window.getSelection().toString();}if(!l.ctrlKey&&b(this).val().length>=d&&k.length==0){l.preventDefault();}}).keyup(function(k){var l=k.keyCode||k.which;if(l>=37&&l<=40){return;}b(this).val(b(this).val().replace(h,""));}).focus(function(l){var k=b(this);i=k.val();j=setInterval(function(){if(k.val()!=i){k.val(k.val().replace(h,""));i=k.val();}},100);}).blur(function(k){j&&clearInterval(j);});});return this;}});}(jQuery));(function(a){if(!Array.prototype.indexOf){Array.prototype.indexOf=function(c){for(var b=0;b<this.length;b++){if(this[b]==c){return b;}}return -1;};}if(!String.prototype.trim){String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"");};}if(!window.console){console={};console.log=function(){return;};}Date.prototype.Format=function(c){var d={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours()%12==0?12:this.getHours()%12,"H+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),"S":this.getMilliseconds()};if(/(y+)/.test(c)){c=c.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length));}for(var b in d){if(new RegExp("("+b+")").test(c)){c=c.replace(RegExp.$1,(RegExp.$1.length==1)?(d[b]):(("00"+d[b]).substr((""+d[b]).length)));}}return c;};})(jQuery);YIUI.ComponentMgr=function(){var c={};var b={};var a={register:function(d){c[d.id]=d;},unregister:function(d){c[d.id]=null;},get:function(d){return c[d];},all:c,isRegistered:function(d){return b[d]!==undefined;},registerType:function(e,d){b[e]=d;d.type=e;},eachType:function(e){if($.isFunction(e)){for(var d in b){e(d,b[d]);}}},create:function(d,e){if(!b[d.tagName]){YIUI.ViewException.throwException(YIUI.ViewException.NO_COMPONENT,d.tagName);}return d.render?d:new b[d.tagName||e](d);}};return a;}();YIUI.reg=YIUI.ComponentMgr.registerType;YIUI.create=YIUI.ComponentMgr.create;YIUI.get=YIUI.ComponentMgr.get;YIUI.Component=YIUI.extend({autoEl:"<div></div>",editable:true,enable:true,visible:true,width:-1,height:-1,required:false,format:null,listeners:null,error:null,errorInfo:{},active:null,buddyKey:null,metaObj:{},buddy:false,init:function(a){$.extend(this,a);this.getId();this.events=this.events||{};if(this.listeners){this.addListener(this.listeners);delete this.listeners;}this.lastSize={width:-1,height:-1};this.lastPosition={top:-1,left:-1};this.lastFontSize={fontSize:-1};},setWidth:function(b){if(!b||!$.isNumeric(b)||b<=0){return;}if(!this.rendered){this.width=b;return;}var a=this.lastSize;if(a.width!==b){a.width=b;this.onSetWidth(b);}},onSetWidth:function(a){this.el.css("width",a);},getWidth:function(){if(this.rendered){return this.getOuterEl().outerWidth();}return this.width;},setHeight:function(a){if(!a||!$.isNumeric(a)||a<=0){return;}if(!this.rendered){this.height=a;return;}var b=this.lastSize;if(b.height!==a){b.height=a;this.onSetHeight(a);}},onSetHeight:function(a){this.el.css("height",a);},getHeight:function(){if(this.rendered){return this.getOuterEl().outerHeight();}return this.height;},getInnerWidth:function(){return this.el.width();},getInnerHeight:function(){return this.el.height();},setLeft:function(b){if(!b||!$.isNumeric(b)||b<=0){return;}var a=this.lastPosition;if(a.left!==b){a.left=b;if(this.rendered){this.el.css("position","absolute");this.onSetLeft(b);}else{this.left=b;}}},onSetLeft:function(a){this.el.css("left",a);},setTop:function(b){if((!b&&b!=0)||b=="auto"){return;}var a=this.lastPosition;if(a.top!==b){a.top=b;if(this.rendered){this.el.css("position","absolute");this.onSetTop(b);}else{this.top=b;}}},onSetTop:function(a){this.el.css("top",a);},setPadding:function(a){this.el.css("padding",a);},setLeftPadding:function(a){this.el.css("padding-left",a);},setRightPadding:function(a){this.el.css("padding-right",a);},setTopPadding:function(a){this.el.css("padding-top",a);},setBottomPadding:function(a){this.el.css("padding-bottom",a);},setMargin:function(a){this.el.css("margin",a);},setLeftMargin:function(a){this.el.css("margin-left",a);},setRightMargin:function(a){this.el.css("margin-right",a);},setTopMargin:function(a){this.el.css("margin-top",a);},setBottomMargin:function(a){this.el.css("margin-bottom",a);},setBorderColor:function(a){this.el.css("border-color",a);},setBorderRadius:function(a){this.el.css("border-radius",a);},setVAlign:function(a){this.vAlign=a;switch(this.vAlign){case YIUI.HAlignment.TOP:this.el.css("vertical-align","top");break;case YIUI.VAlignment.CENTER:this.el.css("vertical-align","middle");break;case YIUI.VAlignment.BOTTOM:this.el.css("vertical-align","bottom");break;}},setHAlign:function(a){this.hAlign=a;},getId:function(){if(this.ofFormID){return this.id||(this.id=this.ofFormID+"_"+this.key);}else{return this.id||YIUI.allotId();}},setColumnKey:function(a){this.columnKey=a;},setTableKey:function(a){this.tableKey=a;},setDefaultFormulaValue:function(a){this.defaultFormulaValue=a;},getColumnKey:function(){return this.columnKey;},getTableKey:function(){return this.tableKey;},getDefaultFormulaValue:function(){return this.defaultFormulaValue;},dependedValueChange:$.noop,setEditable:function(a){this.editable=a;},setEnable:function(b){this.enable=b;var c=this.getEl(),a=this.getOuterEl();if(this.enable){c.removeAttr("readonly");a.removeClass("ui-readonly");}else{c.attr("readonly","readonly");a.addClass("ui-readonly");}},setFocusManager:function(a){this.focusManager=a;},setTabIndex:function(a){this.tabIndex=a;},getTabIndex:function(){return this.tabIndex;},isEditable:function(){return this.editable;},isEnable:function(){return this.enable;},setVisible:function(e){this.visible=e;var a=this.getOuterEl();if(this.getMetaObj().buddyKey){var c=YIUI.FormStack.getForm(this.ofFormID);var d=c.getComponent(this.getMetaObj().buddyKey);if(d){if(d.rendered){d.setVisible(e);}else{d.getMetaObj().visible=e;}}}if(this.visible){a.removeClass("ui-hidden");}else{a.addClass("ui-hidden");}var b=this.ownerCt;if(b){b.reduceVisible(e,this);}},isPanel:function(){return this.isPanel;},isVisible:function(){return this.visible;},setTip:function(a){if(this.getMetaObj().tip){a=this.getMetaObj().tip;}this.el.attr("title",a);},getEl:function(){return this.el;},getOuterEl:function(){return this.getEl();},needClean:function(){return true;},render:function(a){this.doRender(a);if(this.hasLayout){var e,c,d=this.container.width(),b=this.container.height();if(this.width==-1){e=$.getReal("100%",d);}else{e=$.getReal(this.width,d);}if(this.height==-1){c=$.getReal("100%",b);}else{c=$.getReal(this.height,b);}this.doLayout(e,c);}},doRender:function(a){if(!this.rendered&&this.beforeRender()!==false){this.rendered=true;this.container=a?$(a):(this.container?$(this.container):$.getBody());this.onRender(this.container);this.onRenderChildren();this.afterRender();this.install();}},beforeRender:$.noop,setError:function(b,d){this.errorInfo={error:b,msg:d};var c=this.getEl(),a=this.el;if(this.errorInfo.error){a.addClass("ui-error");$('<span class="error-icon" />').attr("title",d).appendTo(a);}else{a.removeClass("ui-error");$(".error-icon",a).remove();}},onRender:function(a){var b=this.el;if(b&&(!a||a.length==0)){this.container=a=$(b).parent();}if(!b&&this.autoEl){if($.isString(this.autoEl)){b=$(this.autoEl);}}if(b){if(!b.attr("id")){b.attr("id",this.getId());}this.el=$(b);if(this.el.parents("body")[0]!=$.getBody()[0]){a.append(this.el);}}if(this.errorInfo){this.setError(this.errorInfo.error,this.errorInfo.msg);}this.setColumnKey(this.getMetaObj().columnKey);this.setTableKey(this.getMetaObj().tableKey);if(this.getMetaObj().defaultFormulaValue){this.setDefaultFormulaValue(this.getMetaObj().defaultFormulaValue);}this.setKey(this.getMetaObj().key);this.getMetaObj().buddy&&this.setBuddy(this.getMetaObj().buddy);},setBuddy:function(a){this.buddy=a;},isBuddy:function(){return this.buddy;},onRenderChildren:$.noop,doLayout:$.noop,setKey:function(a){this.key=a;},setBackColor:function(a){this.backColor=a;this.getEl().css({"background-image":"none","background-color":a});},setForeColor:function(a){this.foreColor=a;this.getEl().css("color",a);},setStyle:function(b){var c={};if(b.vAlign>-1){c["vertical-align"]=YIUI.VAlignment.parse(b.vAlign);c["line-height"]="normal";}(b.hAlign>-1)&&(c["text-align"]=YIUI.HAlignment.parse(b.hAlign));var a=b.font;if(a){a.name&&(c["font-family"]=a.name);a.size&&(c["font-size"]=a.size);a.bold&&(c["font-weight"]="bold");a.italic&&(c["font-style"]="italic");}this.setFormatStyle(c);},setFormatStyle:function(a){this.getEl().css(a);},setRequired:function(a){this.required=a;if(a){this.getOuterEl().addClass("ui-required");}else{this.getOuterEl().removeClass("ui-required");}},isRequired:function(){return this.required;},setCssClass:function(a){this.el.addClass(a);},getMetaObj:function(){return this.metaObj;},setMetaObj:function(a){this.metaObj=a;},afterRender:function(){var a=this.getMetaObj();(a.enable!=undefined)&&this.setEnable(a.enable);(a.editable!=undefined)&&this.setEditable(a.editable);(a.visible!=undefined)&&this.setVisible(a.visible);a.backColor&&this.setBackColor(a.backColor);a.foreColor&&this.setForeColor(a.foreColor);this.format&&this.setStyle(this.format);this.setTip(a.tip);a.cssClass&&this.setCssClass(a.cssClass);a.padding&&this.setPadding(a.padding);a.leftPadding&&this.setLeftPadding(a.leftPadding);a.rightPadding&&this.setRightPadding(a.rightPadding);a.topPadding&&this.setTopPadding(a.topPadding);a.bottomPadding&&this.setBottomPadding(a.bottomPadding);this.setLeft(a.left);this.setTop(a.top);a.borderColor&&this.setBorderColor(a.borderColor);a.borderRadius&&this.setBorderRadius(a.borderRadius);a.vAlign&&this.setVAlign(a.vAlign);a.hAlign&&this.setHAlign(a.hAlign);},setBox:function(){var d=this.ownerCt,c,a;if(d){if((d.type==YIUI.CONTROLTYPE.TABPANEL&&d.items.length>=1)||(d.tagName=="tabcontainer"&&d.items.length>=1)||d.items.length==1){if(this.width==-1){this.width="100%";}if(this.height==-1){this.height="100%";}}}if(d){c=d.getValidWidth();a=d.getValidHeight();this.setWidth($.getReal(this.width,c));this.setHeight($.getReal(this.height,a));}else{var b=this.el.parent();c=b.width();a=b.height();this.setWidth(this.width);this.setHeight(this.height);}},focus:function(){this.el.focus();},needTip:function(){return true;},getShowText:function(){return this.caption;},install:function(){var a=this;},addListener:function(a,d,c){if($.isObject(a)){var b=a,g;for(var h in b){g=b[h];this.addListener(h,g.fn||g,g.scope);}}else{var f=this.events[a]=this.events[a]||new YIUI.Event(a,this);f.addListener(d,c);}},fireEvent:function(b){var c=this.events[b];if(c){var a=$.makeArray(arguments);a.shift();c.fire.apply(c,a);}},bind:function(a,b,d,c){c=c||this;var e=a?$(a,this.el):this.el;e.bind(b,function(f){d?d.call(c,f):c.fireEvent(b,f);});},destroy:function(){if(this.isDestroyed){return;}if(this.beforeDestroy()!==false){if(this.rendered){this.el.destroy();delete this.el;delete this.listeners;}this.afterDestroy();this.isDestroyed=true;}},beforeDestroy:$.noop,getNoTabOrderComps:$.noop,afterDestroy:function(){for(var a in this){if(this.hasOwnProperty(a)){delete this[a];}}},diff:function(a,b){this.doDiff=true;this.callAttrMethod(a,b);this.doDiff=false;},callAttrMethod:function(a,d){var b=[];var c=this;$.each(a,function(e,f){var g=c["set"+$.capitalizeFirst(e)];if(g){g.call(c,f);}else{if(d){d.call(c,e,f);}else{}}});},initDefaultValue:function(a){this.el=a.el;this.key=a.key;this.type=a.el.attr("xtype");this.container=a.container;this.ofFormID=a.formID;this.el.attr("id",this.id);}});YIUI.reg("component",YIUI.Component);YIUI.Event=function(b,a){this.name=b;this.owner=a;this.listeners=[];};YIUI.Event.prototype={addListener:function(b,a){var c={fn:b,scope:a||this.owner};this.listeners.push(c);},removeListener:function(c,b){var a=this.indexOfListener(c,b);if(a!=-1){this.listeners.splice(a,1);return true;}return false;},indexOfListener:function(d,c){var a=this.owner,b=-1;$.each(this.listeners,function(e){if(this.fn==d&&(this.scope==c||this.scope==a)){b=e;return false;}});return b;},fire:function(){var b=$.makeArray(arguments),a=this.owner;$.each(this.listeners,function(c){if(this.fn.apply(this.scope||window,b)===false){return false;}});}};YIUI.Control=YIUI.extend(YIUI.Component,{value:"",backupValue:"",text:"",checkRule:null,trigger:null,handler:YIUI.Handler,behavior:YIUI.BaseBehavior,listeners:{click:function(){this.handler&&this.handler.doOnClick(this);},change:function(){var a=this.getValue();this.handler&&this.handler.doValueChanged(this,a,true,true);}},isNull:function(){return(this.value==null||this.value==undefined||this.value==="")?true:false;},commitValue:function(){if(this.changing){if(this.handler){this.handler.doValueChanged(this,this.getValue(),true,true);}}this.changing=false;},rollbackValue:function(){this.changing=false;this.setValue(this.backupValue,false,false,true,false);},setValue:function(f,c,g,e,a){if(!this.behavior){return false;}this.backupValue=this.value;var d=this;var i={oldVal:this.value,newVal:f};i=this.getCheckOpts(i);var h=function(j){d.checkEnd(j);};var b=this.behavior.checkAndSet(i,h);if(b){this.doChanged(c,g,e,a);}return b;},getCheckOpts:function(a){a=$.extend((a||{}),this.getMetaObj());return a;},checkEnd:function(a){this.value=a;this.caption=a;},doChanged:function(d,c,b,a){if(!b&&this.handler){if(a){if(this.handler.validated(this,this.getValue())){this.handler.doValueChanged(this,this.getValue(),d,c);}else{if(this.handler.hasChanging(this)){this.changing=true;this.handler.changing(this,this.getValue());}else{this.rollbackValue();}}}else{this.handler.doValueChanged(this,this.getValue(),d,c);}}this.setTip(null);},getValue:function(){return this.value;},setText:function(a){this.setValue(a);},getText:function(){return this.getValue();},setRequired:function(a){this.base(a);if(a){this.getEl().placeholder("-必须填写-");var b=this;this.bind(null,"keyup",function(){if(b.isNull()){this.getOuterEl().addClass("ui-required");}else{this.getOuterEl().removeClass("ui-required");}});this.bind(null,"blur",function(){if(b.isNull()){this.getOuterEl().addClass("ui-required");}else{this.getOuterEl().removeClass("ui-required");}});}}});YIUI.reg("control",YIUI.Control);YIUI.EventHandler=(function(){var Return={doTreeClick:function(control,container){var path=control.path;var target=control.target;var node=$("[path='"+path+"']");var enable=node.attr("enable");if(enable!==undefined&&!YIUI.TypeConvertor.toBoolean(enable)){return;}if(node.length>0){var single=YIUI.TypeConvertor.toBoolean(node.attr("single"));if(single){var formKey=node.attr("formKey");var paras=node.attr("paras");var li=$("[formKey='"+formKey+"'][paras='"+paras+"']",container.el);if(li.length>0){li.click();return;}}}var data={};data.path=path;data.async=true;var success=function(jsonObj){var pFormID;var form=YIUI.FormBuilder.build(jsonObj,target);form.entryPath=path;form.entryParas=paras;if(form.target!=YIUI.FormTarget.MODAL){container.build(form);pFormID=form.formID;}if(form.getOperationState()==YIUI.Form_OperationState.New){form.resetUIStatus(YIUI.FormUIStatusMask.ENABLE|YIUI.FormUIStatusMask.VISIBLE|YIUI.FormUIStatusMask.OPERATION);form.getUIProcess().checkAll();form.initFirstFocus();}if(form.postShow){form.eval(form.postShow,{form:form});}};Svr.SvrMgr.doPureTreeEvent(data,success);},doCloseForm:function(control){var formID=control.ofFormID;var form=YIUI.FormStack.getForm(formID);form.fireClose();}};return Return;})();YIUI.Handler=(function(){var Return={formatDate:function(date,format){var o={"M+":date.getMonth()+1,"d+":date.getDate(),"h+":date.getHours(),"H+":date.getHours(),"m+":date.getMinutes(),"s+":date.getSeconds(),"q+":Math.floor((date.getMonth()+3)/3),"S":date.getMilliseconds()};if(/(y+)/.test(format)){format=format.replace(RegExp.$1,(date.getFullYear()+"").substr(4-RegExp.$1.length));for(var k in o){if(new RegExp("("+k+")").test(format)){format=format.replace(RegExp.$1,(RegExp.$1.length==1)?(o[k]):(("00"+o[k]).substr((""+o[k]).length)));}}return format;}},convertValue:function(value,type){var ret;switch(type){case DataType.STRING:if(value==null||value==undefined){ret="";}else{ret=""+value;}break;case DataType.INT:case DataType.LONG:case DataType.DOUBLE:case DataType.FLOAT:case DataType.NUMERIC:if(value==undefined||value==null||value==""){ret=0;}else{if(value.toString().toLowerCase()=="true"){value=1;}if(value.toString().toLowerCase()=="false"){value=0;}ret=new Decimal(value,10);}break;case DataType.BOOLEAN:ret=value?true:false;default:ret=value;}return ret;},doOnClick:function(control){var formID=control.ofFormID,form=YIUI.FormStack.getForm(formID),clickContent=control.clickContent;var cxt={form:form};if(clickContent){form.eval(clickContent,cxt,null);}},setValueToDocument:function(control,dataTable,columnKey,bookmark,newValue){if(dataTable.indexByKey(columnKey)==-1){return;}var type=control.type;var dataType=dataTable.cols[dataTable.indexByKey(columnKey)].type;bookmark==-1?dataTable.first():dataTable.setByBkmk(bookmark);if(newValue==undefined||newValue==null){newValue=Return.convertValue(newValue,dataType);dataTable.setByKey(columnKey,newValue);}else{switch(type){case YIUI.CONTROLTYPE.DICT:case YIUI.CONTROLTYPE.DYNAMICDICT:case YIUI.CONTROLTYPE.COMPDICT:if(control.multiSelect){if(newValue.length>0){var str="";for(var i=0;i<newValue.length;i++){str+=","+newValue[i].oid;}str=str.substring(1);dataTable.setByKey(columnKey,str);if(type==YIUI.CONTROLTYPE.DYNAMICDICT||type==YIUI.CONTROLTYPE.COMPDICT){dataTable.setByKey(columnKey+"ItemKey",newValue[0].itemKey);}}}else{dataTable.setByKey(columnKey,newValue.oid);if(type==YIUI.CONTROLTYPE.DYNAMICDICT||type==YIUI.CONTROLTYPE.COMPDICT){dataTable.setByKey(columnKey+"ItemKey",newValue.itemKey);}}break;case YIUI.CONTROLTYPE.DATEPICKER:if(newValue instanceof Date){newValue=newValue.getTime();}else{newValue=new Date(newValue).getTime();}dataTable.setByKey(columnKey,newValue);break;default:newValue=Return.convertValue(newValue,dataType);dataTable.setByKey(columnKey,newValue);}}},doValueChanged:function(control,newValue,commitValue,fireEvent){var formID=control.ofFormID,metaObj=control.getMetaObj(),form=YIUI.FormStack.getForm(formID),columnKey=metaObj.columnKey,tableKey=metaObj.tableKey,dataTable,document=form.getDocument();if(tableKey){dataTable=document.getByKey(tableKey);}if(commitValue){if(control.getMetaObj().isSubDetail){var cellKey=control.getMetaObj().bindingCellKey;var isToDo=(cellKey!==undefined&&cellKey.length>0);var grid=form.getComponent(control.getMetaObj().parentGridKey),row,colInfoes,colInfo,rowIndex=(grid==null?-1:grid.getFocusRowIndex());if(grid&&rowIndex>=0&&rowIndex<grid.dataModel.data.length){if(isToDo){colInfoes=grid.getColInfoByKey(cellKey);if(colInfoes!==null){for(var ci=0,clen=colInfoes.length;ci<clen;ci++){colInfo=colInfoes[ci];grid.setValueAt(rowIndex,colInfo.colIndex,newValue,true,fireEvent,true);}}}else{row=grid.dataModel.data[rowIndex];if(row&&row.isDetail&&row.bookmark!==undefined){if(dataTable){if(dataTable.tableMode==YIUI.TableMode.HEAD){this.setValueToDocument(control,dataTable,columnKey,-1,newValue);}else{this.setValueToDocument(control,dataTable,columnKey,row.bookmark,newValue);}}}}}else{if(grid&&rowIndex==-1&&isToDo){var lastRowIndex=grid.getLastDetailRowIndex();if(lastRowIndex!=-1){colInfoes=grid.getColInfoByKey(cellKey);if(colInfoes!==null){grid.setFocusRowIndex(lastRowIndex);grid.setCellFocus(lastRowIndex,grid.getCellIndexByKey(cellKey));for(var ci=0,clen=colInfoes.length;ci<clen;ci++){colInfo=colInfoes[ci];grid.setValueAt(lastRowIndex,colInfo.colIndex,newValue,true,fireEvent,true);}}}}}}else{if(dataTable){this.setValueToDocument(control,dataTable,columnKey,-1,newValue);}}form.getUIProcess().preFireValueChanged(metaObj.key);if(fireEvent){form.getUIProcess().doValueChanged(metaObj.key);}form.getUIProcess().postFireValueChanged(metaObj.key);}},validated:function(control){var passed=true;var validation=control.validation;if(validation){var formID=control.ofFormID,form=YIUI.FormStack.getForm(formID);passed=form.eval(validation,{form:form});}return passed;},hasChanging:function(control){var hasChanging=false;var changing=control.valueChanging;if(changing){hasChanging=true;}return hasChanging;},changing:function(control){var changing=control.valueChanging;if(changing){var formID=control.ofFormID,form=YIUI.FormStack.getForm(formID);form.eval(changing,{form:form});}}};return Return;})();YIUI.AttachmentHandler=(function(){var a={doDeleteAttachement:function(e,b,d){var c={fileID:b,formKey:d};Svr.SvrMgr.deleteAttachment(c);},preview:function(d,b,c){}};a=$.extend({},YIUI.Handler,a);return a;})();YIUI.ButtonHandler=(function(){var a={};a=$.extend({},YIUI.Handler,a);return a;})();YIUI.ComboBoxHandler=(function(){var Return={getComboboxItems:function(combobox,cxt){if(!combobox.needRebuild&&typeof(combobox.needRebuild)!="undefined"){return;}var items=[];var sourceType=combobox.sourceType,formID=combobox.ofFormID;switch(sourceType){case YIUI.COMBOBOX_SOURCETYPE.ITEMS:case YIUI.COMBOBOX_SOURCETYPE.STATUS:case YIUI.COMBOBOX_SOURCETYPE.PARAGROUP:combobox.needRebuild=false;break;case YIUI.COMBOBOX_SOURCETYPE.FORMULA:var form=YIUI.FormStack.getForm(formID);if(cxt==undefined){cxt={form:form};}if(combobox.formula){var rs=form.eval($.trim(combobox.formula),cxt,null);if($.isString(rs)){var item_Arr=rs.split(";");for(var i=0,len=item_Arr.length;i<len;i++){var item_obj=item_Arr[i].split(",");var i1=item_obj[0];var i2="";if(item_obj.length>1){i2=item_obj[1];}else{i2=i1;}var item={value:i1,caption:i2};items.push(item);}}else{if(rs instanceof DataDef.DataTable){rs.beforeFirst();if(rs.cols.length==1){var globalItems=combobox.globalItems;var pItems=form.eval($.trim(globalItems),cxt,null);while(rs.next()){var value=YIUI.TypeConvertor.toString(rs.get(0));var caption="";if(pItems&&pItems.length>0){for(var i=0,len=pItems.length;i<len;i++){var pItem=pItems[i];if(pItem.value==value){caption=pItem.caption;break;}}}caption=caption==""?value:caption;var item={value:value,caption:caption};items.push(item);}}else{if(rs.cols.length>1){while(rs.next()){var value=YIUI.TypeConvertor.toString(rs.get(0));var caption=YIUI.TypeConvertor.toString(rs.get(1));var item={value:value,caption:caption};items.push(item);}}}}else{if(rs!=null){items=items.concat(rs);}}}}combobox.setItems(items);break;case YIUI.COMBOBOX_SOURCETYPE.QUERY:var form=YIUI.FormStack.getForm(formID);var data={},type;var queryParas=combobox.queryParas;data.formID=formID;data.key=combobox.key;data.formKey=form.getFormKey();data.fieldKey=combobox.key;data.typeDefKey=combobox.typeDefKey;data.service="PureUIService";data.cmd="getQueryItems";var sourceType,value,paras=[];for(var i=0,len=queryParas.length;i<len;i++){sourceType=queryParas[i].sourceType;value=queryParas[i].value;switch(sourceType){case YIUI.COMBOBOX_PARAMETERSOURCETYPE.CONST:paras.push(value);break;case YIUI.COMBOBOX_PARAMETERSOURCETYPE.FORMULA:case YIUI.COMBOBOX_PARAMETERSOURCETYPE.FIELD:if(cxt==undefined){cxt={form:form};}paras.push(form.eval(value,cxt,null));break;}}data.paras=$.toJSON(paras);var success=function(result){if(result){var items=[];items=items.concat(result);combobox.setItems(items);combobox.checkItem(combobox.getValue());combobox.needRebuild=false;}};Svr.Request.getSyncData(Svr.SvrMgr.ServletURL,data,success);break;}},doSuggest:function(combobox,value){if($.isEmptyObject(value)){combobox.yesCombobox.$suggestView.empty().hide();return;}var sourceType=combobox.sourceType,formID=combobox.ofFormID,items,viewItems=[];var form=YIUI.FormStack.getForm(formID);switch(sourceType){case YIUI.COMBOBOX_SOURCETYPE.FORMULA:var cxt={form:form};if(combobox.formula){items=form.eval($.trim(combobox.formula),cxt,null);}for(var i=0,len=items.length;i<len;i++){if(items[i].caption.indexOf(value)>0){viewItems.push(items[i]);}if(viewItems.length==5){break;}}break;default:items=combobox.items;for(var i=0,len=items.length;i<len;i++){if(items[i].caption!=null){if(items[i].caption.indexOf(value)>=0){viewItems.push(items[i]);}}if(viewItems.length==5){break;}}break;}if(viewItems.length==0){combobox.yesCombobox.$suggestView.empty().hide();return;}var list=$("<ul/>"),_li;var view=combobox.yesCombobox.$suggestView.html(list);for(var i=0,len=viewItems.length;i<len;i++){_li=$('<li itemValue="'+viewItems[i].value+'">'+viewItems[i].caption+"</li>");list.append(_li);}var cityObj=$("input",combobox.el);var cityOffset=cityObj.offset();view.css({width:cityObj.outerWidth(),top:cityOffset.top+cityObj.outerHeight(),left:cityOffset.left});view.show();combobox.hasText=true;}};Return=$.extend({},YIUI.Handler,Return);return Return;})();YIUI.CheckBoxHandler=(function(){var a={};a=$.extend({},YIUI.Handler,a);return a;})();YIUI.DictHandler=(function(){var Return={setContext:function(cxt){this.cxt=cxt;},doLostFocus:function(control,extParas){},getFilter:function(form,fieldKey,itemFilters,itemKey){var filter=null;if(itemFilters){var itemFilter=itemFilters[itemKey];if(itemFilter!=null&&itemFilter!=undefined&&itemFilter.length>0){for(var i=0,len=itemFilter.length;i<len;i++){var cond=itemFilter[i].cond;if(cond&&cond.length>0){cxt={form:form};var ret=form.eval(cond,cxt,null);if(ret==true){filter=itemFilter[i];break;}}else{filter=itemFilter[i];break;}}}}return filter;},getDictFilter:function(form,fieldKey,itemFilters,itemKey){var filter=Return.getFilter(form,fieldKey,itemFilters,itemKey);if(filter){var filterVal,paras=[];if(filter.filterVals!==null&&filter.filterVals!==undefined&&filter.filterVals.length>0){for(var j in filter.filterVals){filterVal=filter.filterVals[j];switch(filterVal.type){case YIUI.FILTERVALUETYPE.CONST:paras.push(filterVal.refVal);break;case YIUI.FILTERVALUETYPE.FORMULA:case YIUI.FILTERVALUETYPE.FIELD:var cxt=this.cxt;if(!cxt){cxt={form:form};}paras.push(form.eval(filterVal.refVal,cxt,null));break;}}}var dictFilter={};dictFilter.itemKey=itemKey;dictFilter.formKey=form.formKey;dictFilter.fieldKey=fieldKey;dictFilter.filterIndex=filter.filterIndex;dictFilter.values=paras;dictFilter.dependency=filter.dependency;dictFilter.typeDefKey=filter.typeDefKey;return dictFilter;}else{return null;}},checkDict:function($this){if(!$this.needRebuild&&typeof($this.needRebuild)!="undefined"){return;}var oldItemKey=$this.getDictTree().itemKey;var formID=$this.ofFormID;var form=YIUI.FormStack.getForm(formID);var cxt=this.cxt;if(!cxt){cxt={form:form};}if($this.isDynamic){$this.itemKey=form.eval($this.refKey,cxt,null);}var rootItem={};if($this.root&&$this.root.length>=0){rootItem=form.getComponentValue($this.root,cxt);if(rootItem==null){rootItem={};rootItem.oid=0;rootItem.itemKey=$this.itemKey;}}else{rootItem.oid=0;rootItem.itemKey=$this.itemKey;}if($this.rootItemKey){rootItem.itemKey=$this.rootItemKey;}$this.getDictTree().dictFilter=Return.getDictFilter(form,$this.key,$this.itemFilters,$this.itemKey);var data={};data.itemKey=$this.itemKey;data.itemData=$.toJSON(rootItem);data.service="PureUIService";data.cmd="CheckDict";var success=function(result){if(result){var rootCaption=result.rootCaption;if($this.getDictTree().rootNode!=null){$this.getDictTree().rootNode.remove();}if(oldItemKey!=$this.itemKey){$this.getDictTree().fuzzyValue=null;$this.getDictTree().startRow=0;$this.getDictTree()._searchdiv.find(".findinput").val("");$this.getDictTree()._footdiv.find(".next").removeClass("disable");}$this.getDictTree().createRootNode(rootItem,rootCaption,rootItem.itemKey+"_"+rootItem.oid,result.secondaryType);$this.getDictTree().itemKey=$this.itemKey;$this.setSecondaryType(result.secondaryType);$this.needRebuild=false;var resultType=result.secondaryType;$this.secondaryType=result.secondaryType;if(resultType==5){$this.needRebuild=true;}}};Svr.Request.getSyncData(Svr.SvrMgr.ServletURL,data,success);},autoComplete:function($this,text){this.checkDict($this);var rootValue=null;if($this.getDictTree().rootNode!=null){rootValue=$this.getDictTree().getNodeValue($this.getDictTree().rootNode);}var ret=null;if(!$.isEmptyObject(text)){ret=YIUI.DictService.locate($this.itemKey,"Code",text,$this.getDictTree().dictFilter,rootValue,$this.stateMask);}if(ret){var value={oid:ret.oid,itemKey:ret.itemKey,caption:ret.caption};var mul_sel=$this.multiSelect;var change=false;if(mul_sel){var val=[];val.push(value);change=$this.setValue(val,true,true);}else{change=$this.setValue(value,true,true);}if(!change){$this.setText($this.text);}}else{if(mul_sel){$this.setValue(null,true,true);return;}var options={fuzzyValue:text,itemKey:$this.itemKey,caption:$this.caption,rootValue:rootValue,stateMask:$this.stateMask,dictFilter:$this.getDictTree().dictFilter,displayCols:$this.displayCols,startRow:0,maxRows:5,pageIndicatorCount:3,columns:$this.displayColumns,textInput:$("input",$this.el),callback:function(itemData){if(itemData){$this.setValue(itemData,true,true);$this.setText(itemData.caption);}else{$this.setText($this.text);}$this.isShowQuery=false;}};var dictquery=new YIUI.DictQuery(options);$this.isShowQuery=true;}},doSuggest:function($this,text){if($this.multiSelect){return;}if($.isEmptyObject(text)){$this.yesDict.$suggestView.empty().hide();return;}this.checkDict($this);var rootValue=null;if($this.getDictTree().rootNode!=null){rootValue=$this.getDictTree().getNodeValue($this.getDictTree().rootNode);}var viewItems=YIUI.DictService.getSuggestData($this.itemKey,text,$this.stateMask,$this.getDictTree().dictFilter,rootValue);if(viewItems.length==0){$this.yesDict.$suggestView.empty().hide();$this.hasSuggest=false;return;}$this.hasSuggest=true;var list=$("<ul/>"),_li;var view=$this.yesDict.$suggestView.html(list),item,_a;for(var i=0,len=viewItems.length;i<len;i++){item=viewItems[i];_li=$("<li oid="+item.oid+" itemkey = "+item.itemKey+"></li>");$("<div class='dt-wholerow'/>").appendTo(_li);_a=$("<a class='dt-anchor'></a>").appendTo(_li);_spanIcon=$("<span class='branch'></span>").appendTo(_a);if(item.NodeType==0){_spanIcon.addClass("p_node");}_spanText=$("<span class='b-txt'></span>").text(item.caption).appendTo(_a);list.append(_li);}var cityObj=$("input",$this.el);var cityOffset=cityObj.offset();view.css({width:cityObj.outerWidth(),top:cityOffset.top+cityObj.outerHeight(),left:cityOffset.left});view.show();$this.hasText=true;}};Return=$.extend({},YIUI.Handler,Return);return Return;})();YIUI.DatePickerHandler=(function(){var a={};a=$.extend({},YIUI.Handler,a);return a;})();YIUI.DropdownButtonHandler=(function(){var Return={doOnClick:function(control,btnKey){var formID=control.ofFormID,form=YIUI.FormStack.getForm(formID),clickContent;var items=control.dropdownItems;for(var i=0,len=items.length;i<len;i++){if(items[i].key==btnKey){clickContent=items[i].formula;break;}}var cxt={form:form};if(clickContent){form.eval(clickContent,cxt,null);}}};Return=$.extend({},YIUI.Handler,Return);return Return;})();YIUI.GridHandler=(function(){var Return={doOnCellClick:function(control,rowID,colIndex,value){var formID=control.ofFormID,form=YIUI.FormStack.getForm(formID),row=control.getRowDataByID(rowID),rowIndex=control.getRowIndexByID(rowID),cellKey=row.cellKeys[colIndex],editOpt=control.getColInfoByKey(cellKey)[0].cell;switch(editOpt.edittype){case"button":case"hyperLink":case"image":case"textButton":if(editOpt.editOptions.onclick){form.eval($.trim(editOpt.editOptions.onclick),{form:form,rowIndex:rowIndex},null);}break;case"checkBox":var oldV=control.getValueAt(rowIndex,colIndex);if(oldV!==value){control.setValueAt(rowIndex,colIndex,value,true,true);}break;}},doOnRowClick:function(control,rowID){var formID=control.ofFormID,form=YIUI.FormStack.getForm(formID),rowIndex=control.getRowIndexByID(rowID),clickContent=control.rowClick===undefined?"":$.trim(control.rowClick);var cxt={form:form,rowIndex:rowIndex};if(clickContent){form.eval(clickContent,cxt,null);}},doOnRowDblClick:function(control,rowID){var formID=control.ofFormID,form=YIUI.FormStack.getForm(formID),rowIndex=control.getRowIndexByID(rowID),clickContent=control.rowDblClick===undefined?"":$.trim(control.rowDblClick);var cxt={form:form,rowIndex:rowIndex};if(clickContent){form.eval(clickContent,cxt,null);}},doOnFocusRowChange:function(control,oldRowID,rowID){var formID=control.ofFormID,form=YIUI.FormStack.getForm(formID),rowIndex=control.getRowIndexByID(rowID),oldRowIndex=control.getRowIndexByID(oldRowID),clickContent=control.focusRowChanged===undefined?"":$.trim(control.focusRowChanged);var cxt={form:form,newRowIndex:rowIndex,oldRowIndex:oldRowIndex};if(clickContent){form.eval(clickContent,cxt,null);}YIUI.SubDetailUtil.showSubDetailData(control,rowIndex);},doOnSortClick:function(control,colIndex,sortType){if(control.hasGroupRow){alert("表格排序不支持行分组！");return;}var data=control.dataModel.data;data.sort(function(row1,row2){if(row1.rowType=="Fix"||row1.rowType=="Total"||row2.rowType=="Fix"||row2.rowType=="Total"){return row1.metaRowIndex-row2.metaRowIndex;}var value1=row1.data[colIndex][0],value2=row2.data[colIndex][0];if(row2.bookmark===undefined){return -1;}if(row1.bookmark===undefined){return 1;}if(value1==undefined&&value2==undefined){return 0;}if(value1!==undefined&&value2==undefined){return sortType==="asc"?-1:1;}if(value1==undefined&&value2!==undefined){return sortType==="asc"?1:-1;}var editOpt=control.dataModel.colModel.cells[row1.cellKeys[colIndex]];switch(editOpt.edittype){case"datePicker":case"numberEditor":return sortType==="asc"?value2-value1:value1-value2;case"textEditor":return sortType==="asc"?value2.localeCompare(value1):value1.localeCompare(value2);case"comboBox":case"dict":value1=row1.data[colIndex][1];value2=row2.data[colIndex][1];return sortType==="asc"?value2.localeCompare(value1):value1.localeCompare(value2);}return 1;});control.dataModel.data=data;control.refreshGrid();},doGridCellSelect:function(control,rowID,colIndex){},doShiftRow:function(control,rowIndex,isUp){var rowData=control.getRowDataAt(rowIndex);if(!rowData.isDetail||(rowData.isDetail&&rowData.bookmark==null)){return;}var preRowIndex=rowIndex-1,nextRowIndex=rowIndex+1;if((isUp&&preRowIndex<0)||(!isUp&&nextRowIndex>=control.getRowCount())){return;}var preRowData=control.getRowDataAt(preRowIndex),nextRowData=control.getRowDataAt(nextRowIndex);if(isUp&&(!preRowData.isDetail||(preRowData.isDetail&&preRowData.bookmark==null))){return;}if(!isUp&&(!nextRowData.isDetail||(nextRowData.isDetail&&nextRowData.bookmark==null))){return;}this.doExchangeRow(control,rowIndex,isUp?rowIndex-1:rowIndex+1);},doExchangeRow:function(control,rowIndex,excRowIndex){var formID=control.ofFormID,form=YIUI.FormStack.getForm(formID),row=control.getRowDataAt(rowIndex),excRow=control.getRowDataAt(excRowIndex);control.dataModel.data.splice(rowIndex,1,excRow);control.dataModel.data.splice(excRowIndex,1,row);control.el[0].deleteGridRow(rowIndex);control.el[0].insertGridRow(rowIndex,excRow);control.el[0].deleteGridRow(excRowIndex);control.el[0].insertGridRow(excRowIndex,row);$(control.el.getGridCellAt(excRowIndex+1,control.el[0].p.selectCell)).click();this.dealWithSequence(form,control);},doCellValueChanged:function(control,rowID,colIndex,newValue){var rowIndex=control.getRowIndexByID(rowID);control.setValueAt(rowIndex,colIndex,newValue,true,true,true);},doCellPast:function(control,bgRowID,bgColIndex,copyText){var rowInd=control.getRowIndexByID(bgRowID),rowV=copyText.split("\n");for(var i=0,len=rowV.length;i<len;i++){if(rowV[i]===""){continue;}var rowIndex=rowInd+i;var cellV=rowV[i].split("\t"),cellVObj;for(var j=0,clen=cellV.length;j<clen;j++){var iCol=bgColIndex+j,value=cellV[j];if(iCol>=control.dataModel.colModel.columns.length){continue;}control.setValueAt(rowIndex,iCol,value,true,true,false);}}},doAllChecked:function(control,colIndex,newValue){var len=control.dataModel.data.length;for(var i=0;i<len;i++){var rd=control.dataModel.data[i];if(rd.isDetail&&rd.bookmark!=undefined&&rd.bookmark!=null){control.setValueAt(i,colIndex,newValue,true,true,false);}}},doGoToPage:function(control,pageInfo){pageInfo=JSON.parse(pageInfo);var curPageIndex=control.pageInfo.currentPage,rowIndex=-1;if(pageInfo.optType=="firstPage"){control.pageInfo.currentPage=1;}else{if(pageInfo.optType=="prevPage"){control.pageInfo.currentPage=curPageIndex-1;}else{if(pageInfo.optType=="nextPage"){control.pageInfo.currentPage=curPageIndex+1;}else{if(pageInfo.optType=="lastPage"){control.pageInfo.currentPage=control.pageInfo.totalPage;}else{if(pageInfo.optType=="turnToPage"){control.pageInfo.currentPage=pageInfo.pageIndex;}}}}}if(control.pageInfo.pageLoadType=="UI"){control.reload();}else{var formID=control.ofFormID,form=YIUI.FormStack.getForm(formID),filterMap=form.getFilterMap(),startRi=(control.pageInfo.currentPage-1)*control.pageInfo.pageRowCount;filterMap.setOID(form.getDocument().oid==undefined?-1:form.getDocument().oid);filterMap.getTblFilter(control.tableKey).startRow=startRi;filterMap.getTblFilter(control.tableKey).maxRows=control.pageInfo.pageRowCount;var paras={formKey:form.formKey,cmd:"gridgotopage",filterMap:$.toJSON(filterMap),gridKey:control.key,condition:$.toJSON(form.getCondParas()),formOptState:form.getOperationState()};var result=JSON.parse(Svr.SvrMgr.doGoToPage(paras)),dataTable;if(result.dataTable){dataTable=YIUI.DataUtil.fromJSONDataTable(result.dataTable);form.getDocument().setByKey(control.tableKey,dataTable);}else{dataTable=form.getDocument().getByKey(control.tableKey);}var shadowTableKey=YIUI.DataUtil.getShadowTableKey(control.tableKey);var shadowTable=form.getDocument().getByKey(shadowTableKey);if(shadowTable&&control.pageInfo.pageLoadType=="DB"){var data=result.data,row;for(var i=0,len=result.data.length;i<len;i++){row=data[i];if(row.bookmark===undefined||row.bookmark==null){continue;}dataTable.setByBkmk(row.bookmark);var OID=dataTable.getByKey(YIUI.SystemField.OID_SYS_KEY),primaryKeys;if(OID!=null&&OID!=undefined){primaryKeys=[YIUI.SystemField.OID_SYS_KEY];}else{primaryKeys=control.primaryKeys;}var pos=YIUI.DataUtil.getPosByPrimaryKeys(dataTable,shadowTable,primaryKeys);if(pos!=-1){var v=shadowTable.getByKey(YIUI.DataUtil.System_SelectField_Key);row.data[control.selectFieldIndex][0]=v;}}}control.dataModel.data=result.data;control.errorInfoes=result.errorInfoes;control.pageInfo.totalPage=result.totalPage;control.rowIDMask=0;}control.initRowDatas();control.refreshGrid({needCalc:control.pageInfo.pageLoadType=="DB"});if(control.pageInfo.pageLoadType=="DB"){}},doGoToFirstPage:function(control,pageInfo){},doGoToLastPage:function(control,pageInfo){},doGoToPrevPage:function(control,pageInfo){},doGoToNextPage:function(control,pageInfo){},doInsertGridRow:function(control,rowID){var ri=control.getRowIndexByID(rowID),rd=control.getRowDataByID(rowID),bookmark=parseInt(rd.bookmark,10);if(!rd.isDetail||(isNaN(bookmark)&&ri==(control.dataModel.data.length-1))){return;}var form=YIUI.FormStack.getForm(control.ofFormID);YIUI.SubDetailUtil.clearSubDetailData(form,control);control.addGridRow(null,ri);var rowInsertContent=control.rowInsert===undefined?"":$.trim(control.rowInsert);var cxt={form:form,rowIndex:ri};if(rowInsertContent){form.eval(rowInsertContent,cxt,null);}},doDeleteGridRow:function(control,rowID){var ri=control.getRowIndexByID(rowID);var form=YIUI.FormStack.getForm(control.ofFormID);var callback=function(){control.clearAllSubDetailData(ri);var isDeleted=control.deleteGridRow(ri);if(isDeleted){form.getUIProcess().doPostDeleteRow(control,ri);var rowDeleteContent=control.rowDelete===undefined?"":$.trim(control.rowDelete);var cxt={form:form,rowIndex:ri};if(rowDeleteContent){form.eval(rowDeleteContent,cxt,null);}}};if(control.hasSubDetailData(ri)){var dialog=new YIUI.Yes_Dialog({msg:"清空子明细数据？",YesEvent:callback});dialog.show();var btns=$(".dlg-btn",dialog.el),btn;for(var i=0;i<btns.length;i++){btn=$(btns[i]);if(btn.attr("key")==YIUI.Dialog_Btn.STR_YES){btn.click(function(){callback();});}btn.click(function(){dialog.close();});}}else{callback();}},setCellValueToDocument:function(form,grid,rowIndex,colIndex,newValue){var row=grid.dataModel.data[rowIndex];switch(row.rowType){case"Fix":this.setFixValueToDoc(form,grid,rowIndex,colIndex,newValue);break;case"Detail":this.setDtlValueToDoc(form,grid,rowIndex,colIndex,newValue);break;}},setNewValue:function(colKey,cEditOpt,dataTable,newValue){if(dataTable==undefined||colKey==""){return;}var editOpts=cEditOpt.editOptions,dataType;switch(cEditOpt.edittype){case"dict":if(newValue==null||newValue==undefined){if(editOpts.multiSelect){dataTable.setByKey(colKey,null);}else{dataTable.setByKey(colKey,0);}break;}if(editOpts.multiSelect){var oids=[],itemKey="";if(editOpts.isCompDict){$.error($.ygrid.formatString($.ygrid.compDictNotDataBinding,cEditOpt.key));}for(var i=0,len=newValue.length;i<len;i++){oids.push(newValue[i].oid);oids.push(",");}if(oids&&oids.length>0){oids.pop();itemKey=newValue[0].itemKey;}dataTable.setByKey(colKey,oids.join(""));if(editOpts.isDynamic){dataTable.setByKey(colKey+"ItemKey",itemKey);}}else{dataTable.setByKey(colKey,newValue.oid);if(editOpts.isCompDict||editOpts.isDynamic){dataTable.setByKey(colKey+"ItemKey",newValue.itemKey);}}break;default:dataType=dataTable.cols[dataTable.indexByKey(colKey)].type;dataTable.setByKey(colKey,YIUI.Handler.convertValue(newValue,dataType));break;}},crossValKey:function(metaCell){var key=[];key.push(metaCell.columnArea);var crossValue=metaCell.crossValue;if(crossValue){for(var i=0;i<crossValue.values.length;i++){var node=crossValue.values[i];key.push(node.columnKey,node.dataType,node.value);}}return key.join("_");},newRow:function(form,grid,row,dataTable){var cm,editOpt,cellV,dataType;dataTable.addRow(true);for(var i=0,len=grid.dataModel.colModel.columns.length;i<len;i++){cm=grid.dataModel.colModel.columns[i];editOpt=grid.dataModel.colModel.cells[row.cellKeys[i]];if(editOpt==undefined||editOpt.columnKey===undefined||editOpt.columnKey===""){continue;}cellV=row.data[i][0];if(editOpt.edittype==="dict"&&cellV!==null){if(editOpt.editOptions.multiSelect){var realV=[];for(var n=0,clen=cellV.length;n<clen;n++){realV.push(cellV[n].oid);realV.push(",");}realV.pop();cellV=realV.join("");}else{cellV=cellV.oid;}}dataType=dataTable.cols[dataTable.indexByKey(editOpt.columnKey)].type;dataTable.setByKey(editOpt.columnKey,YIUI.Handler.convertValue(cellV,dataType));}return dataTable.getBkmk();},setFixValueToDoc:function(form,grid,rowIndex,colIndex,newValue){var row=grid.dataModel.data[rowIndex],cEditOpt=grid.dataModel.colModel.cells[row.cellKeys[colIndex]],doc=form.getDocument(),dataTable,dataType,tableKey=cEditOpt.tableKey,colKey=cEditOpt.columnKey;if(doc==undefined||doc==null){return;}if(tableKey==undefined||colKey==undefined){return;}dataTable=doc.getByKey(tableKey);if(dataTable==undefined||dataTable==null){return;}if(!dataTable.first()){dataTable.addRow();}this.setNewValue(colKey,cEditOpt,dataTable,newValue);},selectRow:function(form,grid,rowIndex,colIndex,newValue){var rd=grid.getRowDataAt(rowIndex),tableKey=grid.tableKey,doc=form.getDocument(),dataTable=doc.getByKey(tableKey),dataType=dataTable.cols[dataTable.indexByKey("SelectField")].type;if(rd.isDetail&&rd.bookmark==undefined||doc==undefined||dataTable==undefined){return;}if(grid.hasColExpand){for(var i=0,len=rd.bookmark.length;i<len;i++){var detailBkmk=rd.bookmark[i];dataTable.setByBkmk(detailBkmk);dataTable.setByKey(YIUI.DataUtil.System_SelectField_Key,YIUI.Handler.convertValue(newValue,dataType));}}else{if(grid.pageInfo.pageLoadType=="DB"){var shadowTableKey=YIUI.DataUtil.getShadowTableKey(tableKey);var shadowTable=doc.getByKey(shadowTableKey);if(shadowTable==null||shadowTable==undefined){shadowTable=YIUI.DataUtil.newShadowDataTable(dataTable);doc.add(shadowTableKey,shadowTable);}dataTable.setByBkmk(rd.bookmark);if(dataTable.allRows[dataTable.pos].state==DataDef.R_New){return;}var curOID=dataTable.getByKey(YIUI.DataUtil.System_OID_Key),primaryKeys;if(curOID!=null&&curOID!=undefined){primaryKeys=[YIUI.DataUtil.System_OID_Key];}else{primaryKeys=grid.primaryKeys;}var pos=YIUI.DataUtil.getPosByPrimaryKeys(dataTable,shadowTable,primaryKeys);if(YIUI.TypeConvertor.toBoolean(newValue)){if(pos!=-1){shadowTable.setPos(pos);}else{shadowTable.addRow();for(var j=0,clen=shadowTable.cols.length;j<clen;j++){shadowTable.set(j,dataTable.get(j));}}shadowTable.setByKey(YIUI.DataUtil.System_SelectField_Key,1);shadowTable.allRows[shadowTable.pos].state=dataTable.allRows[dataTable.pos].state;}else{if(pos!=-1){if(shadowTable.rows[pos].state==DataDef.R_Normal){shadowTable.rows[pos].state=DataDef.R_New;shadowTable.delRow(pos);}else{shadowTable.setByKey(YIUI.DataUtil.System_SelectField_Key,0);}}}}else{dataTable.setByBkmk(rd.bookmark);dataTable.setByKey(YIUI.DataUtil.System_SelectField_Key,YIUI.Handler.convertValue(newValue,dataType));}}},setDtlValueToDoc:function(form,grid,rowIndex,colIndex,newValue){var row=grid.dataModel.data[rowIndex],cEditOpt=grid.dataModel.colModel.cells[row.cellKeys[colIndex]],doc=form.getDocument(),dataTable,tableKey=cEditOpt.tableKey,colKey=cEditOpt.columnKey,dtlRowIndex=grid.metaRowInfo.dtlRowIndex,metaRow=grid.metaRowInfo.rows[dtlRowIndex],metaCell=metaRow.cells[colIndex];if(grid.selectFieldIndex!=-1&&grid.selectFieldIndex==colIndex){this.selectRow(form,grid,rowIndex,colIndex,newValue);}if(doc==undefined||doc==null){return;}if(tableKey==undefined||colKey==undefined){return;}dataTable=doc.getByKey(tableKey);if(dataTable==undefined||dataTable==null){return;}var oldTableSize=dataTable.getRowCount();if(row.isDetail&&row.bookmark==undefined){this.flushRow(form,grid,rowIndex);}else{if(grid.hasColExpand){if(metaCell.isColExpand){dataTable.setByBkmk(row.cellBkmks[colIndex]);this.setNewValue(colKey,cEditOpt,dataTable,newValue);}else{for(var i=0,len=row.bookmark.length;i<len;i++){dataTable.setByBkmk(row.bookmark[i]);this.setNewValue(colKey,cEditOpt,dataTable,newValue);}}}else{dataTable.setByBkmk(row.bookmark);this.setNewValue(colKey,cEditOpt,dataTable,newValue);}}if(oldTableSize!==dataTable.getRowCount()){this.dealWithSequence(form,grid);}},flushRow:function(form,grid,rowIndex){var row=grid.dataModel.data[rowIndex],tableKey=grid.tableKey,dtlRowIndex=grid.metaRowInfo.dtlRowIndex,metaRow=grid.metaRowInfo.rows[dtlRowIndex],doc=form.getDocument(),dataTable=doc.getByKey(tableKey),rowBkmk;if(doc==undefined||doc==null){return;}if(dataTable==undefined||dataTable==null){return;}if(grid.hasColExpand){rowBkmk=[];var cell,metaCell,newBkmk,cEditOpt,colExpandMap={};for(var i=0,len=row.data.length;i<len;i++){cell=row.data[i];metaCell=metaRow.cells[i];cEditOpt=grid.dataModel.colModel.cells[row.cellKeys[i]];if(metaCell.isColExpand){var key=this.crossValKey(metaCell);newBkmk=colExpandMap[key];if(newBkmk==undefined||newBkmk==null){newBkmk=this.newRow(form,grid,row,dataTable);rowBkmk.push(newBkmk);row.cellBkmks[i]=newBkmk;colExpandMap[key]=newBkmk;this.setNewValue(metaCell.columnKey,cEditOpt,dataTable,cell[0]);var expInfo=grid.expandModel[metaCell.columnArea];for(var k=0,cLen=metaCell.crossValue.values.length;k<cLen;k++){var node=metaCell.crossValue.values[k];var expKey=expInfo[k];if(expKey!==undefined&&expKey!==null&&expKey.length>0){dataTable.setByKey(expKey,node.value);}}}else{row.cellBkmks[i]=newBkmk;}}}for(var m=0,eLen=rowBkmk.length;m<eLen;m++){dataTable.setByBkmk(rowBkmk[m]);for(var n=0,nLen=row.data.length;n<nLen;n++){metaCell=metaRow.cells[n];cEditOpt=grid.dataModel.colModel.cells[row.cellKeys[n]];if(!metaCell.isColExpand&&metaCell.columnKey!=undefined&&metaCell.columnKey.length>0){this.setNewValue(metaCell.columnKey,cEditOpt,dataTable,row.data[n][0]);}}}}else{rowBkmk=this.newRow(form,grid,row,dataTable);dataTable.setByBkmk(rowBkmk);for(var j=0,jLen=row.data.length;j<jLen;j++){metaCell=metaRow.cells[j];cEditOpt=grid.dataModel.colModel.cells[row.cellKeys[j]];if(metaCell.columnKey!=undefined&&metaCell.columnKey.length>0){this.setNewValue(metaCell.columnKey,cEditOpt,dataTable,row.data[j][0]);}}if(grid.parentGrid&&grid.parentGrid.length>0){var parentGrid=form.getComponent(grid.parentGrid),pRowIndex=parentGrid.getFocusRowIndex(),pRow=parentGrid.dataModel.data[pRowIndex];dataTable.rows[dataTable.pos].parentBkmk=pRow.bookmark;}}row.bookmark=rowBkmk;YIUI.SubDetailUtil.showSubDetailData(grid,rowIndex);return row;},showDetailRowData:function(form,grid,rowIndex,calcRow){var document=form.getDocument();if(document==null){return;}var dataTable=document.getByKey(grid.tableKey);if(dataTable==null){return;}var gridData=grid.getRowDataAt(rowIndex),rowbkmk=gridData.bkmkRow,firstRow=rowbkmk,expandRowBkmk;if(rowbkmk instanceof YIUI.ExpandRowBkmk){expandRowBkmk=rowbkmk;firstRow=rowbkmk.getAt(0);}for(var i=0,len=gridData.data.length;i<len;i++){var metaCell=grid.getMetaObj().rows[gridData.metaRowIndex].cells[i],value;if(metaCell.hasDB){if(metaCell.isColExpand){var detailRowBkmk=expandRowBkmk.getAtArea(metaCell.columnArea,metaCell.crossValue);if(detailRowBkmk!=null){gridData.cellBkmks[i]=detailRowBkmk.getBookmark();dataTable.setByBkmk(detailRowBkmk.getBookmark());value=YIUI.UIUtil.getCompValue(metaCell,dataTable);gridData.data[i]=grid.getCellNeedValue(rowIndex,i,value,true);}}else{dataTable.setByBkmk(firstRow.getBookmark());value=YIUI.UIUtil.getCompValue(metaCell,dataTable);gridData.data[i]=grid.getCellNeedValue(rowIndex,i,value,true);}}else{if(metaCell.isSelect){}else{if(metaCell.cellType==YIUI.CONTROLTYPE.LABEL||metaCell.cellType==YIUI.CONTROLTYPE.BUTTON||metaCell.cellType==YIUI.CONTROLTYPE.HYPERLINK){gridData.data[i]=grid.getCellNeedValue(rowIndex,i,metaCell.caption,true);}}}}if(calcRow){form.getUIProcess().doPostInsertRow(grid,rowIndex);}},copyRow:function(form,grid,rowIndex,splitKeys,splitValues,layer){var dataTable=form.getDocument().getByKey(grid.tableKey),newRowIndex=rowIndex+1;if(dataTable==undefined){return -1;}var row=grid.getRowDataAt(rowIndex);if(row.isDetail&&row.bookmark==undefined){return -1;}var rd=grid.addGridRow(null,newRowIndex,false);if(rd.bookmark==undefined){rd=this.flushRow(form,grid,newRowIndex);}if(row.bookmark!==undefined){var values={},OID=-1,tCol,value;dataTable.setByBkmk(row.bookmark);for(var i=0,len=dataTable.cols.length;i<len;i++){tCol=dataTable.cols[i];value=dataTable.get(i);if(tCol.key.toLowerCase()=="oid"&&value!==null){OID=value;}values[tCol.key]=value;}dataTable.setByBkmk(rd.bookmark);for(var ci=0,clen=dataTable.cols.length;ci<clen;ci++){tCol=dataTable.cols[ci];if(splitKeys.indexOf(tCol.key)>=0){var dataType=dataTable.cols[dataTable.indexByKey(tCol.key)].type;dataTable.set(ci,YIUI.Handler.convertValue(splitValues[splitKeys.indexOf(tCol.key)],dataType));}else{dataTable.set(ci,values[tCol.key]);}if(tCol.key.toLowerCase()=="oid"){dataTable.set(ci,null);}if(tCol.key.toLowerCase()=="poid"){dataTable.set(ci,OID);}if(tCol.key.toLowerCase()=="sequence"){dataTable.set(ci,null);}}}if(layer!=-1){dataTable.setByKey("Layer",layer);}dataTable.beforeFirst();grid.showDetailRow(newRowIndex,false);this.dealWithSequence(form,grid);return newRowIndex;},fireCellChangeEvent:function(form,grid,rowIndex,colIndex){var row=grid.dataModel.data[rowIndex],cellKey=row.cellKeys[colIndex],editOpt=grid.dataModel.colModel.cells[cellKey];form.getViewDataMonitor().fireCellValueChanged(grid,rowIndex,colIndex,cellKey);YIUI.GridSumUtil.evalAffectSum(form,grid,rowIndex,colIndex);if(editOpt==undefined||editOpt.columnKey===undefined||editOpt.columnKey.length==0||!grid.isEnable()){return;}var nextRow=grid.dataModel.data[rowIndex+1];if(!row.isDetail){return;}var sr=grid.el[0].p.selectRow,sc=grid.el[0].p.selectCell;if((nextRow===undefined||!nextRow.isDetail)&&grid.newEmptyRow&&!grid.hasRowExpand&&(grid.treeColIndex==null||grid.treeColIndex==-1)){if(grid.hasGroupRow){if(row.inAutoGroup){var pRow,nRow;for(var i=rowIndex-1;i>=0;i--){pRow=grid.dataModel.data[i];if(!pRow.inAutoGroup){break;}pRow.inAutoGroup=false;}row.inAutoGroup=false;for(var ind=rowIndex+1,len=grid.dataModel.data.length;ind<len;ind++){nRow=grid.dataModel.data[ind];if(!nRow.inAutoGroup){break;}nRow.inAutoGroup=false;}grid.appendAutoRowAndGroup();}else{grid.addGridRow(null,rowIndex+1);}}else{grid.addGridRow();}}if(sr!==undefined&&sc!==undefined){grid.el.setGridParam({selectRow:sr,selectCell:sc});}},doPostCellChangeEvent:function(form,grid,rowIndex,colIndex){var row=grid.dataModel.data[rowIndex],cellKey=row.cellKeys[colIndex];form.uiProcess.doPostCellValueChanged(grid,rowIndex,colIndex,cellKey);},dealWithSequence:function(form,grid){var SYS_SEQUENCE="Sequence";if(grid.seqColumn==undefined){return;}var row,bkmk,seq,curSeq=0,dataTable=form.getDocument().getByKey(grid.tableKey);for(var i=0,len=grid.dataModel.data.length;i<len;i++){row=grid.dataModel.data[i];bkmk=row.bookmark;if(!row.isDetail||row.bookmark==undefined){continue;}if(grid.hasColExpand){dataTable.setByBkmk(bkmk[0]);seq=dataTable.getByKey(SYS_SEQUENCE);if(seq==undefined||seq==null||seq<=curSeq){seq=curSeq+1;for(var j=0,jlen=bkmk.length;j<jlen;j++){dataTable.setByBkmk(bkmk[j]);dataTable.setByKey(SYS_SEQUENCE,seq);}curSeq=parseInt(seq);}}else{dataTable.setByBkmk(bkmk);seq=dataTable.getByKey(SYS_SEQUENCE);if(seq==undefined||seq==null||seq<=curSeq){seq=curSeq+1;dataTable.setByKey(SYS_SEQUENCE,seq);}curSeq=parseInt(seq);}}},dependedValueChange:function(grid,targetField,dependencyField,value){var formID=grid.ofFormID,form=YIUI.FormStack.getForm(formID),cellLocation=form.getCellLocation(targetField);if(grid.treeColIndex==cellLocation.column||grid.rowExpandIndex==cellLocation.column){this.reloadGridByFilter(grid,form,dependencyField,value);}else{if(cellLocation.row==null||cellLocation.row==-1){for(var i=0,len=grid.getRowCount();i<len;i++){var row=grid.getRowDataAt(i);if(row.isDetail&&row.bookmark!=null){Return.dependedValueChangeAt(grid,i,dependencyField,targetField,value);}}}else{Return.dependedValueChangeAt(grid,cellLocation.row,dependencyField,targetField,value);}}},reloadGridByFilter:function(grid,form,dependencyField,value){if(value==null){value=form.getComponent(dependencyField).getValue();if(value instanceof YIUI.ItemData){value=value.oid;}}var jsonDoc=YIUI.DataUtil.toJSONDoc(form.getDocument());var params={service:"PureGridOpt",cmd:"ReloadGridByFilter",document:$.toJSON(jsonDoc),formKey:form.getFormKey(),dependencyField:dependencyField,dependencyFieldValue:value};var result=Svr.Request.getSyncData(Svr.SvrMgr.ServletURL,params);this.diffFromFormJson(grid,result.form);},diffFromFormJson:function(grid,formJson){var block=formJson.body.items[formJson.body.index_of_block];var getDiffJSON=function(items,gridKey){var item,result;for(var i=0,len=items.length;i<len;i++){item=items[i];if(item.metaObj!=null&&item.metaObj.key==gridKey){result=item;break;}else{if(item.items!=null&&item.items.length>0){result=getDiffJSON(item.items,gridKey);}if(result!=null){break;}}}return result;};var gridDiffJson=getDiffJSON(block.rootPanel.items,grid.key);grid.diff(gridDiffJson);},doPostCellValueChanged:function(grid,rowIndex,dependencyField,targetField,value){var formID=grid.ofFormID,form=YIUI.FormStack.getForm(formID),comp=form.getComponent(targetField);if(comp!=null){comp.dependedValueChange(dependencyField);}else{Return.dependedValueChangeAt(grid,rowIndex,dependencyField,targetField,value);}},dependedValueChangeAt:function(grid,rowIndex,dependencyField,targetField,value){var row=grid.getRowDataAt(rowIndex),metaRow=grid.metaRowInfo.rows[row.metaRowIndex];var updateDynamicCell=function(cell,cellTypeDef,editOpt,rowData,rowIndex,cellIndex){if(cellTypeDef.options.isAlwaysShow){var iRow=rowIndex+1,iCol=grid.showRowHead?cellIndex+1:cellIndex,cm=grid.dataModel.colModel[iCol],opt=$.extend({},editOpt.editOptions||{},{ri:rowIndex,key:cm.name,id:iRow+"_"+cm.name,name:cm.name}),gRow=grid.el.getGridRowAt(iRow);grid.alwaysShowCellEditor(cell,iRow,iCol,cm,[null,"",cell.enable],opt,gRow.offsetHeight);}};for(var i=0,len=metaRow.cells.length;i<len;i++){var metaCell=metaRow.cells[i],editOpt=grid.dataModel.colModel.cells[metaCell.key];if(metaCell.key==targetField){if(metaCell.cellType==YIUI.CONTROLTYPE.DYNAMIC){var cell=grid.el.getGridCellAt(rowIndex+1,grid.showRowHead?i+1:i),cellTypeDef=cell.cellTypeDef;if(cellTypeDef!=null){var newOpt=$.extend(true,{},editOpt),newOptions=$.extend(true,cellTypeDef.options,editOpt.editOptions);newOpt.editOptions=newOptions;Return.dependencyValueChangedByType(grid,cellTypeDef.type,newOpt,rowIndex,i,dependencyField,value);updateDynamicCell(cell,cellTypeDef,rowIndex,i);}}else{Return.dependencyValueChangedByType(grid,metaCell.cellType,editOpt,rowIndex,i,dependencyField,value);}}}},dependencyValueChangedByType:function(grid,cellType,editOpt,rowIndex,colIndex,dependencyField,value){var formID=grid.ofFormID,form=YIUI.FormStack.getForm(formID);if(cellType==YIUI.CONTROLTYPE.DICT||cellType==YIUI.CONTROLTYPE.COMPDICT||cellType==YIUI.CONTROLTYPE.DYNAMICDICT){if(editOpt.editOptions.isDynamic){var refKey=editOpt.editOptions.refKey;if(refKey==dependencyField){grid.setValueAt(rowIndex,colIndex,value,true,true,true);return;}}var root=editOpt.editOptions.root;if(root==dependencyField){grid.setValueAt(rowIndex,colIndex,value,true,true,true);return;}var dictFilter=editOpt.dictFilter;if(dictFilter!=null){var filterDependency=dictFilter.dependency;if(filterDependency!=null&&filterDependency.indexOf(dependencyField)>=0){grid.setValueAt(rowIndex,colIndex,value,true,true,true);editOpt.needRefreshFilter=true;}}else{var curFilter=YIUI.DictHandler.getFilter(form,editOpt.key,editOpt.editOptions.itemFilters,editOpt.editOptions.itemKey);if(curFilter!=null){grid.setValueAt(rowIndex,colIndex,value,true,true,true);}}}else{if(cellType==YIUI.CONTROLTYPE.COMBOBOX||cellType==YIUI.CONTROLTYPE.CHECKLISTBOX){var dependedFields=editOpt.editOptions.dependedFields;if(dependedFields.indexOf(dependencyField)>=0){grid.setValueAt(rowIndex,colIndex,value,true,true,true);editOpt.needRebuild=true;}}}}};Return=$.extend({},YIUI.Handler,Return);return Return;})();YIUI.HyperLinkHandler=(function(){var a={};a=$.extend({},YIUI.Handler,a);return a;})();YIUI.ImageHandler=(function(){var a={};a=$.extend({},YIUI.Handler,a);return a;})();YIUI.ListViewHandler=(function(){var Return={doGoToPage:function(control,pageIndex){var formID=control.ofFormID,metaObj=control.getMetaObj(),controlKey=metaObj.key,tableKey=metaObj.tableKey,startRow=pageIndex*metaObj.pageRowCount,form=YIUI.FormStack.getForm(formID);var filterMap=form.getFilterMap();filterMap.setOID(form.getDocument().oid);var formParas=form!=null?form.getParas():null;var paras={cmd:"pagination",compKey:controlKey,pageIndex:pageIndex,parameters:formParas.toJSON(),formKey:form.getFormKey(),form:form.toJSON()};var result=Svr.SvrMgr.doGoToPage(paras);var newForm=YIUI.FormBuilder.build(result);var listView=newForm.getComponent(controlKey);if(listView.totalRowCount<metaObj.pageRowCount){control._pagination.hidePagination();}else{if(listView.totalRowCount){control.totalRowCount=listView.totalRowCount;control._pagination.setTotalRowCount(control.totalRowCount,false);}}control.data=listView.data;control.clearDataRow();control.addDataRow(control.data);},doOnRowDblClick:function(control,rowIndex){var formID=control.ofFormID,form=YIUI.FormStack.getForm(formID),rowDblClick=control.rowDblClick;var cxt={form:form,rowIndex:rowIndex};if(rowDblClick){form.eval(rowDblClick,cxt,null);}},doOnRowClick:function(control,rowID){var formID=control.ofFormID,form=YIUI.FormStack.getForm(formID),rowClick=control.rowClick;var cxt={form:form,rowIndex:rowID};if(rowClick){form.eval(rowClick,cxt,null);}},doOnFocusRowChange:function(control,oldRowID,newRowID){var formID=control.ofFormID,form=YIUI.FormStack.getForm(formID),focusRowChanged=control.focusRowChanged;var cxt={form:form,rowIndex:newRowID};if(focusRowChanged){form.eval(focusRowChanged,cxt,null);}},doCellValueChanged:function(control,rowIndex,colIndex,newValue){var column=control.columnInfo[colIndex];var dbKey=column.key;control.data[rowIndex][dbKey].value=newValue;var valueChanged=column.valueChanged;if(valueChanged){var form=YIUI.FormStack.getForm(control.ofFormID);form.eval(valueChanged,{form:form});}},doOnCellClick:function(control,rowID,colKey){var formID=control.ofFormID,form=YIUI.FormStack.getForm(formID),columns=control.columnInfo,column;for(var i=0,len=columns.length;i<len;i++){column=columns[i];if(column.key==colKey){break;}}var clickCont=column.clickContent;if(clickCont){form.eval(clickCont,{form:form,rowIndex:rowID},null);}}};Return=$.extend({},YIUI.Handler,Return);return Return;})();YIUI.NumberEditorHandler=(function(){var a={};a=$.extend({},YIUI.Handler,a);return a;})();YIUI.PasswordEditorHandler=(function(){var a={};a=$.extend({},YIUI.Handler,a);return a;})();YIUI.RadioButtonHandler=(function(){var a={};a=$.extend({},YIUI.Handler,a);return a;})();YIUI.SplitButtonHandler=(function(){var Return={doOnClick:function(control,btnKey){var formID=control.ofFormID,form=YIUI.FormStack.getForm(formID),clickContent=control.clickContent;var items=control.dropdownItems;if(btnKey){for(var i=0,len=items.length;i<len;i++){if(items[i].key==btnKey){clickContent=items[i].formula;break;}}}var cxt={form:form};if(clickContent){form.eval(clickContent,cxt,null);}}};Return=$.extend({},YIUI.Handler,Return);return Return;})();YIUI.SearchBoxHandler=(function(){var Return={needRefresh:true,providerKey:null,getProviderKey:function(control){var metaObj=control.getMetaObj();var providerKey=this.providerKey;if(providerKey){return providerKey;}var formulaKey=metaObj.formulaKey;if(formulaKey){var o=form.eval(formulaKey,this.cxt,null);if(o){return o.toString();}}},setNeedRefresh:function(needRefresh){this.needRefresh=needRefresh;},popSearchDialog:function(control,text){var callParas={SearchContent:text};var params={formKey:control.popConfigKey,cmd:"PureShowForm",callParas:JSON.stringify(callParas)};var success=function(jsonObj){var newForm=YIUI.FormBuilder.build(jsonObj,YIUI.FormTarget.MODAL,control.ofFormID);newForm.regEvent(YIUI.FormEvent.Close,{doTask:function(form,paras){var o=form.getResult();if(!o){control.setValue(control.getValue(),true,false);}else{control.setValue(o,true,true);}}});};Svr.SvrMgr.dealWithPureForm(params,success);},doOnClick:function(control){var providerKey=this.providerKey;if(!providerKey||bNeedRefresh){providerKey=this.getProviderKey(control);this.needRefresh=false;}this.popSearchDialog(control,"");},autoComplete:function(control,value){var providerKey=this.providerKey;if(!providerKey||this.needRefresh){providerKey=this.getProviderKey(control);this.needRefresh=false;}var form=YIUI.FormStack.getForm(control.ofFormID);var data={cmd:"Locate",service:"SearchBoxProviderService",formKey:form.getFormKey(),value:value,providerKey:providerKey};var ret=Svr.Request.getSyncData(Svr.SvrMgr.ServletURL,data);if(ret){control.setValue(ret,true,true);return;}this.popSearchDialog(control,value);}};Return=$.extend({},YIUI.Handler,Return);return Return;})();YIUI.TextAreaHandler=(function(){var a={};a=$.extend({},YIUI.Handler,a);return a;})();YIUI.TextEditorHandler=(function(){var TextCase={CASETYPE_NONE:0,CASETYPE_LOWER:1,CASETYPE_UPPER:2};var Return={doEnterPress:function(control){var formID=control.ofFormID,form=YIUI.FormStack.getForm(formID),keyEnter=control.keyEnter;var cxt={form:form};if(keyEnter){form.eval(keyEnter,cxt,null);}}};Return=$.extend({},YIUI.Handler,Return);return Return;})();YIUI.ToolBarHandler=(function(){var Return={doOnClick:function(control){var formID=control.ofFormID;var item=control.item;if(item.formID){formID=item.formID;}var form=YIUI.FormStack.getForm(formID);var cxt={form:form,optKey:item.key};var excpAction=item.excpAction;try{var action=item.action;var preAction=item.preAction;if(preAction){form.eval(preAction,cxt,null);}if(action){form.eval(action,cxt,null);}var _form=YIUI.FormStack.getForm(control.ofFormID);if(_form!=null&&_form.getUIProcess()){_form.getUIProcess().resetUIStatus(YIUI.FormUIStatusMask.OPERATION);}}catch(e){if(excpAction){try{form.eval(excpAction,cxt);}catch(t){}}$.error(e.message);}}};Return=$.extend({},YIUI.Handler,Return);return Return;})();YIUI.TreeHandler=(function(){var a={doTreeClick:function(d,b){var e=d.nodeKey;var h=d.parameters;var g=d.formKey;var j={};j.nodeKey=e;j.eventType=Svr.SvrMgr.EventType.Click;j.formKey=d.formKey;j.entryParas=h;var i=Svr.SvrMgr.doPureTreeEvent(j);if(!i){var f=$("#tab_"+g+"_"+e);f.click();return;}var c=YIUI.FormBuilder.build(i);c.entryKey=e;b.add(c);}};a=$.extend({},YIUI.Handler,a);return a;})();YIUI.DialogHandler=(function(){var Return={doOnClick:function(control,opt){var callback=control.getEvent(opt);var excp=control.excp;control.dialog.close();if(callback){try{callback(opt);}catch(e){if(excp){try{var form=control.getOwner();form.eval(excp,{form:form});}catch(t){}}$.error(e.message);}}}};Return=$.extend({},YIUI.Handler,Return);return Return;})();YIUI.DictViewHandler=(function(){var Return={doOnRowClick:function(control,rowIndex,extParas){var formID=control.ofFormID,form=YIUI.FormStack.getForm(formID),rowClick=control.rowClick;var cxt={form:form};if(rowClick){form.eval(rowClick,cxt,null);}},doOnFocusRowChange:function(dictView,node){var formID=dictView.ofFormID;var form=YIUI.FormStack.getForm(formID);var content=dictView.focusRowChanged;var itemData=dictView.getNodeValue(node);var item=YIUI.DictService.getItem(itemData.itemKey,itemData.oid);dictView._selectItem=item;var cxt={form:form};if(content){form.eval(content,cxt,null);}},doOnRowDblClick:function(control,rowIndex,extParas){var formID=control.ofFormID,form=YIUI.FormStack.getForm(formID),clickContent=control.clickContent;if(control.type===YIUI.CONTROLTYPE.GRID){rowIndex=control.getRowIndexByID(rowIndex);clickContent=control.rowDblClick===undefined?"":$.trim(control.rowDblClick);}var cxt={form:form,rowIndex:rowIndex};if(clickContent){form.eval(clickContent,cxt,null);}},doExpand:function(dictView,pNode){var success=function(nodes){if(nodes){var len=nodes.length;if(len>0){var pId=pNode.attr("id")||0;nodes[len-1].islast=true;var prevId=null;for(var i=0,len=nodes.length;i<len;i++){nodes[i].id=nodes[i].itemKey+"_"+nodes[i].OID;nodes[i].pid=pId;if(dictView.dictType==YIUI.SECONDARYTYPE.COMPDICT){var path=pNode.attr("path");if(!path){path=pId+"_"+nodes[i].OID;}else{path+="_"+nodes[i].OID;}nodes[i].path=path;nodes[i].id=path;}if(prevId!=null){nodes[i].previd=prevId;}prevId=nodes[i].id;}dictView.addNodes(nodes);}}};YIUI.DictService.getDictChildren(dictView.itemKey,dictView.getNodeValue(pNode),dictView.dictFilter,null,success);},doCollapse:function(control,extParas){},doEnterPress:function(control,extParas){},doGoToPage:function(dictView,index,isResetPageNum){var itemKey=dictView.itemKey;var maxRows=dictView.pageRowCount;var pageIndicatorCount=dictView.pageIndicatorCount;var value=dictView.getQueryValue();var startRow=index<=0?0:dictView.pageRowCount*index;var success=function(result){if(result){dictView.isResetPageNum=isResetPageNum;$("tr:gt(1)",dictView._$table).remove();var nodes=result.data;var len=nodes.length;if(len>0){var pId=dictView.root.id;nodes[len-1].islast=true;var prevId=null;for(var i=0,len=nodes.length;i<len;i++){if(prevId!=null){nodes[i].previd=prevId;}nodes[i].id=nodes[i].itemKey+"_"+nodes[i].OID;prevId=nodes[i].id;nodes[i].pid=pId;}dictView.addNodes(nodes);dictView.setTotalRowCount(startRow+result.totalRowCount);dictView.focusNode(nodes[0].id);}else{dictView.setTotalRowCount(len);}}};YIUI.DictService.getQueryData(itemKey,startRow,maxRows,pageIndicatorCount,value,null,dictView.dictFilter,null,success);},doDictViewSearch:function(dictView){this.doGoToPage(dictView,0,true);},getDictFilter:function(dictview){var filter=null;var dictFilter=null;var formID=dictview.ofFormID;var form=YIUI.FormStack.getForm(formID);var cxt={form:form};if(dictview.itemFilters){var itemFilter=dictview.itemFilters[dictview.itemKey];for(var i in itemFilter){var cond=itemFilter[i].cond;if(cond&&cond.length>0){var ret=form.eval(cond,cxt,null);if(ret==true){filter=itemFilter[i];break;}}else{filter=itemFilter[i];break;}}}if(filter){var filterVal;var paras=[];for(var j in filter.filterVals){filterVal=filter.filterVals[j];switch(filterVal.type){case YIUI.FILTERVALUETYPE.CONST:paras.push(filterVal.refVal);break;case YIUI.FILTERVALUETYPE.FORMULA:case YIUI.FILTERVALUETYPE.FIELD:var cxt={form:form};paras.push(form.eval(filterVal.refVal,cxt,null));break;}}var dictFilter={};dictFilter.itemKey=dictview.itemKey;dictFilter.formKey=form.formKey;dictFilter.fieldKey=dictview.key;dictFilter.filterIndex=filter.filterIndex;dictFilter.values=paras;dictFilter.dependency=filter.dependency;dictFilter.typeDefKey=filter.typeDefKey;}return dictFilter;},refreshNode:function(dictview,id){var index=id.lastIndexOf("_");var itemKey=id.substring(0,index);var oid=id.substring(index+1);var item=YIUI.DictService.getItem(itemKey,oid);var $tr=$("#"+id,dictview._$table);if(item.nodeType==1){$tr.attr("haschild",true);}if(item.enable!=undefined){$tr.attr("enable",item.enable);$tr.removeClass("invalid").removeClass("disabled");switch(item.enable){case -1:$tr.addClass("invalid");break;case 0:$tr.addClass("disabled");break;case 1:break;}}var value;for(var j=0,len=dictview.colModel.length;j<len;j++){value=item.getValue(dictview.colModel[j].key);if(!value){value="";}var $td=$tr.children("td").eq(j);if($td.children().length>0){var child=$td.children();$td.empty();$td.append(child).append(value);}else{$td.html(value);}}}};Return=$.extend({},YIUI.Handler,Return);return Return;})();YIUI.FileChooserHandler=(function(){var a={};a=$.extend({},YIUI.Handler,a);return a;})();YIUI.MapDrawHandler=(function(){var a={};a=$.extend({},YIUI.Handler,a);return a;})();YIUI.BaseBehavior=(function(){var a={checkAndSet:function(d,e){var b=d.oldVal;var c=d.newVal;if(c instanceof Decimal){c=c.toString();}if(b==c){return false;}if($.isFunction(e)){e(c);}return true;}};return a;})();YIUI.ButtonBehavior=(function(){var a={};a=$.extend({},YIUI.BaseBehavior,a);return a;})();YIUI.CheckBoxBehavior=(function(){var a={checkAndSet:function(e,f){var c=e.oldVal;var d=e.newVal;if(c==d){return false;}var b=YIUI.TypeConvertor.toBoolean(d);if($.isFunction(f)){f(b);}return true;}};a=$.extend({},YIUI.BaseBehavior,a);return a;})();YIUI.ComboBoxBehavior=(function(){var a={};a=$.extend({},YIUI.BaseBehavior,a);return a;})();YIUI.DatePickerBehavior=(function(){var a={checkAndSet:function(e,f){var b=e.oldVal;var d=e.newVal;if(b instanceof Date&&$.isNumeric(d)){b=b.getTime();}if(b==d){return false;}var c;if(!(d==undefined||d==null||d.length==0)){if(d instanceof Date){c=d;}else{if($.isNumeric(d)){d=parseFloat(d);}else{d=d.replace(/-/g,"/");}c=new Date(d);}}if($.isFunction(f)){f(c);}return true;}};a=$.extend({},YIUI.BaseBehavior,a);return a;})();YIUI.DictBehavior=(function(){var a={isEqual:function(h,g){var f=true;if($.isArray(h)&&$.isArray(g)){if(h.length!=g.length){f=false;}else{for(var e=0,d=h.length;e<d;e++){for(var c=0,b=g.length;c<b;c++){if(h[e].oid!=g[e].oid){f=false;break;}}}}}else{if(h&&g){f=h.oid==g.oid;}else{f=h==g;}}return f;},checkAndSet:function(t,q){var o=t.oldVal;var d=t.newVal;if(d instanceof Decimal){d=d.toString();}var n=this.isEqual(o,d);if(n){return false;}if(d==null||d==""){if($.isFunction(q)){q(null);}return true;}var r="",b;if(t.dictCaption==null){t.dictCaption={};}if(t.multiSelect){var c=[];if($.isString(d)){c=d.split(",");var m=[],l=[];for(var g=0;g<c.length;g++){var f=parseFloat(c[g]);m.push(f);if(f!=0){var s=t.dictCaption[t.itemKey+"_"+f];if(s==null){s=YIUI.DictService.getCaption(t.itemKey,f);t.dictCaption[t.itemKey+"_"+f]=s;}}b={oid:f,itemKey:t.itemKey,caption:s};var e=new YIUI.ItemData(b);l.push(e);}d=l;}else{if($.isArray(d)){for(var h=0,k=d.length;h<k;h++){var p=d[h];var f=p.oid;if(f!=0&&!p.caption){var s=t.dictCaption[t.itemKey+"_"+f];if(s==null){s=YIUI.DictService.getCaption(t.itemKey,f);t.dictCaption[t.itemKey+"_"+f]=s;}p.caption=s;}else{break;}}}}}else{if(o&&d){if((o.itemKey+"_"+o.oid)==(d.itemKey+"_"+d.oid)){return false;}}if($.isNumeric(d)){if(parseFloat(d)!=0){r=t.dictCaption[t.itemKey+"_"+parseFloat(d)];if(r==null){r=YIUI.DictService.getCaption(t.itemKey,parseFloat(d));t.dictCaption[t.itemKey+"_"+f]=r;}}b={oid:d,itemKey:t.itemKey,caption:r};d=new YIUI.ItemData(b);}else{if(d){if(d.oid=="0"){}else{if(d.caption==null||d.caption==""){r=t.dictCaption[t.itemKey+"_"+parseFloat(d.oid)];if(r==null){r=YIUI.DictService.getCaption(t.itemKey,parseFloat(d.oid));t.dictCaption[t.itemKey+"_"+parseFloat(d.oid)]=r;}d.caption=r;}}}}}if($.isFunction(q)){q(d);}return true;}};a=$.extend({},YIUI.BaseBehavior,a);return a;})();YIUI.GridBehavior=(function(){var a={};a=$.extend({},YIUI.BaseBehavior,a);return a;})();YIUI.HyperLinkBehavior=(function(){var a={};a=$.extend({},YIUI.BaseBehavior,a);return a;})();YIUI.ImageBehavior=(function(){var a={};a=$.extend({},YIUI.BaseBehavior,a);return a;})();YIUI.ListViewBehavior=(function(){var a={};a=$.extend({},YIUI.BaseBehavior,a);return a;})();YIUI.NumberEditorBehavior=(function(){var a={checkAndSet:function(m,k){var i=m.oldVal;var c=m.newVal;var g=m.decScale;var b=m.roundingMode||YIUI.NUMBEREDITOR_ROUNDINGMODE.HALF_UP;var h=null,j=0,l="";if(c!=null){h=YIUI.TypeConvertor.toDecimal(c);j=h.toFormat(g,b);var e={aSep:m.useSep?m.sep:"",mRound:b,dGroup:m.groupingSize,aDec:m.decSep,mDec:g};l=YIUI.DecimalFormat.format(j,e);c=new Decimal(j);}else{c=new Decimal(0);}i=YIUI.TypeConvertor.toDecimal(i);var f=!i.eq(c);if(f&&$.isFunction(k)){k(c,l);}return f;}};a=$.extend({},YIUI.BaseBehavior,a);return a;})();YIUI.RadioButtonBehavior=(function(){var a={};a=$.extend({},YIUI.BaseBehavior,a);return a;})();YIUI.SplitButtonBehavior=(function(){var a={};a=$.extend({},YIUI.BaseBehavior,a);return a;})();YIUI.SearchBoxBehavior=(function(){var a={};a=$.extend({},YIUI.BaseBehavior,a);return a;})();YIUI.TextAreaBehavior=(function(){var a={};var a={checkAndSet:function(f,i){var c=f.oldVal;var e=f.newVal;if(c==e){return false;}var b=f.maxLength;var g={maxLength:f.maxLength};var d=YIUI.TextFormat.format(e,g);var h=(c!==d);if($.isFunction(i)){i(d);}return true;}};a=$.extend({},YIUI.BaseBehavior,a);return a;})();YIUI.TextEditorBehavior=(function(){var a={checkAndSet:function(l,j){var i=l.oldVal;var c=l.newVal;if(i===c){return false;}var d=l.trim;var k=l.textCase;var b=l.maxLength;var g=l.invalidChars;var e={trim:l.trim,textCase:l.textCase,maxLength:l.maxLength,invalidChars:l.invalidChars};var h=YIUI.TextFormat.format(c,e);var f=(i!==h);if($.isFunction(j)){j(h);}return true;}};a=$.extend({},YIUI.BaseBehavior,a);return a;})();YIUI.UTCDatePickerBehavior=(function(){var a={checkAndSet:function(d,f){var b=d.oldVal;var c=d.newVal;if(b==c){return false;}var e=YIUI.UTCDateFormat.format(c);if($.isFunction(f)){f(e);}return true;}};a=$.extend({},YIUI.BaseBehavior,a);return a;})();YIUI.DateFormat=(function(){var a={format:function(c,d){var e={formatStr:"yyyy-MM-dd HH:mm:ss",isOnlyDate:false};d=$.extend(e,d);var b=d.formatStr;var g=d.isOnlyDate;if(g){b=b.split(" ")[0];}var f="";if(c){f=c.Format(b);}return f;}};return a;})();YIUI.DecimalFormat=(function(){var a={checkEmpty:function(c,d,b){if(c===""||c===d.aNeg){return c;}return null;},format:function(c,f){var h={aSep:",",dGroup:"3",aDec:".",aSign:"",pSign:"",mDec:"2"};f=$.extend(h,f);c=YIUI.TypeConvertor.toString(c);var g=this.checkEmpty(c,f,true);if(g!==null){return g;}var b="";if(f.dGroup===2){b=/(\d)((\d)(\d{2}?)+)$/;}else{if(f.dGroup===4){b=/(\d)((\d{4}?)+)$/;}else{b=/(\d)((\d{3}?)+)$/;}}var e=c.split(f.aDec);var d=e[0];if(f.aSep){while(b.test(d)){d=d.replace(b,"$1"+f.aSep+"$2");}}if(f.mDec!==0){if(e.length==1){e[1]="000000000";}if(e[1].length>f.mDec){e[1]=e[1].substring(0,f.mDec);}c=d+f.aDec+e[1];}else{c=d;}if(f.aSign){c=f.pSign==="p"?f.aSign+c:c+f.aSign;}return c;}};return a;})();YIUI.UTCDateFormat=(function(){var a={format:function(d,b){var c={formatStr:"yyyy-MM-dd HH:mm:ss",isOnlyDate:true};b=$.extend(c,b);var e;if(!(d==undefined||d==null||d.length==0)){if(d instanceof Date){e=d.Format(b.formatStr)||"";e=e.replace(/(\W+)/g,"");}else{if($.isNumeric(d)){e=parseFloat(d);}else{e=d.replace(/(\W+)/g,"");}}}return e;},formatCaption:function(h,b,c){if(b){var f=parseInt(h/10000);var g=h%10000;var k=parseInt(g/100);g=g%100;var l=g;if(c&&!this.check(f,k,l,0,0,0)){throw new RuntimeException("错误的时间："+h);}if(k<10){k="0"+k;}if(l<10){l="0"+l;}text=f+"-"+k+"-"+l;}else{var f=parseInt(h/10000000000);var g=h%10000000000;var k=parseInt(g/100000000);g=g%100000000;var l=parseInt(g/1000000);g=g%1000000;var j=parseInt(g/10000);g=g%10000;var e=parseInt(g/100);g=g%100;var m=g;if(c&&!this.check(f,k,l,j,e,m)){throw new RuntimeException("错误的时间："+h);}if(k<10){k="0"+k;}if(l<10){l="0"+l;}if(j<10){j="0"+j;}if(e<10){e="0"+e;}if(m<10){m="0"+m;}text=f+"-"+k+"-"+l+" "+j+":"+e+":"+m;}return text;},check:function(h,g,b,d,e,c){if(h>9999){return false;}if(g>12){return false;}var f=30;switch(g){case 2:if((h%4==0&&h%100!=0)||h%400==0){f=29;}else{f=28;}break;case 1:case 3:case 5:case 7:case 8:case 10:case 12:f=31;break;}if(b>f){return false;}if(d>23){return false;}if(e>59||c>59){return false;}return true;}};return a;})();YIUI.TextFormat=(function(){var b={CASETYPE_NONE:0,CASETYPE_LOWER:1,CASETYPE_UPPER:2};var a={format:function(k,f){var d={maxLength:Number.MAX_VALUE,textCase:YIUI.TEXTEDITOR_CASE.DEFAULT,invalidChars:null,trim:true};f=$.extend(d,f);var e=f.trim;var m=f.textCase;var c=f.maxLength;var g=f.invalidChars;var l="";if(k!==undefined&&k!==null){l=k.toString();switch(m){case b.CASETYPE_LOWER:l=l.toLowerCase();break;case b.CASETYPE_UPPER:l=l.toUpperCase();break;}if(g!==undefined&&g!==null&&g!==""){var j="";for(var h=0;h<l.length;h++){if(g.indexOf(l.charAt(h))>=0){continue;}j+=l.charAt(h);}l=j;}if(c>=0&&c<l.length){l=l.substring(0,c);}if(e){l=$.trim(l);}}return l;}};return a;})();YIUI.EventHandler=(function(){var Return={doTreeClick:function(control,container){var path=control.path;var target=control.target;var node=$("[path='"+path+"']");var enable=node.attr("enable");if(enable!==undefined&&!YIUI.TypeConvertor.toBoolean(enable)){return;}if(node.length>0){var single=YIUI.TypeConvertor.toBoolean(node.attr("single"));if(single){var formKey=node.attr("formKey");var paras=node.attr("paras");var li=$("[formKey='"+formKey+"'][paras='"+paras+"']",container.el);if(li.length>0){li.click();return;}}}var data={};data.path=path;data.async=true;var success=function(jsonObj){var pFormID;var form=YIUI.FormBuilder.build(jsonObj,target);form.entryPath=path;form.entryParas=paras;if(form.target!=YIUI.FormTarget.MODAL){container.build(form);pFormID=form.formID;}if(form.getOperationState()==YIUI.Form_OperationState.New){form.resetUIStatus(YIUI.FormUIStatusMask.ENABLE|YIUI.FormUIStatusMask.VISIBLE|YIUI.FormUIStatusMask.OPERATION);form.getUIProcess().checkAll();form.initFirstFocus();}if(form.postShow){form.eval(form.postShow,{form:form});}};Svr.SvrMgr.doPureTreeEvent(data,success);},doCloseForm:function(control){var formID=control.ofFormID;var form=YIUI.FormStack.getForm(formID);form.fireClose();}};return Return;})();var FilterMap=FilterMap||{};(function(){FilterMap=function(b){var a={type:b["type"]||YIUI.DocumentType.DATAOBJECT,OID:b["OID"]||-1,needDocInfo:b["needDocInfo"]||true,filterMap:b["filterMap"]||new Array(),setOID:function(c){this.OID=c;},getOID:function(){return this.OID;},setType:function(c){this.type=c;},getType:function(){return this.type;},setNeedDocInfo:function(c){this.needDocInfo=c;},isNeedDocInfo:function(){return this.needDocInfo;},setFilterMap:function(c){this.filterMap=c;},getFilterMap:function(){return this.filterMap;},addTblDetail:function(c){this.filterMap.push(c);},setStartRow:function(c,d){this.getTblFilter(c).startRow=d;},setMaxRows:function(d,c){this.getTblFilter(d).maxRows=c;},getTblFilter:function(c){var d=this.get(c);if(d==null){d=new TableFilterDetail();d.setTableKey(c);this.addTblDetail(d);}return d;},get:function(e){var g=this.filterMap,f;for(var d=0,c=g.length;d<c;d++){f=g[d];if(f.tableKey==e){return f;}}return null;}};return a;};TableFilterDetail=function(){var a={tableKey:"",filter:"",startRow:0,maxRows:0,OID:-1,fieldValues:null,paraValues:null,SourceKey:"",setTableKey:function(b){this.tableKey=b;},setFilter:function(b){this.filter=b;},setStarRow:function(b){this.startRow=b;},setMaxRows:function(b){this.maxRows=b;},setFieldValues:function(b){this.fieldValues=b;},setParaValues:function(b){this.paraValues=b;},setSourceKey:function(b){this.SourceKey=b;}};return a;};})();(function(){YIUI.UICheckOpt=function(form){var Return={showError:function(errorMsg,type){if(type==YIUI.Dialog_Type.WARN){errorMsg=errorMsg.replace("Uncaught Error: ","");var dialog=$("<div></div>").attr("id","warn_dialog");dialog.modalDialog(errorMsg,{title:"警告",showClose:true,type:YIUI.Dialog_Type.WARN,height:200,width:400});}else{$.error(errorMsg);}},doOpt:function(){var self=this,result=true;if(form.errorInfo.error){this.showError("表单("+form.formKey+" "+form.formCaption+"):"+form.errorInfo.errorMsg);return false;}for(var i in form.getComponentList()){var er,ec,isBreak=false,comp=form.getComponentList()[i],rd;if(comp.type==YIUI.CONTROLTYPE.GRID){for(var m=0;m<comp.errorInfoes.rows.length;m++){er=comp.errorInfoes.rows[m];rd=comp.dataModel.data[er.rowIndex];if(rd==null||(rd.bookmark===undefined&&rd.isDetail)){continue;}self.showError("表格("+comp.key+" "+comp.caption+")第"+(er.rowIndex+1)+"行:"+er.errorMsg);result=false;isBreak=true;break;}if(isBreak){break;}for(var n=0;n<comp.errorInfoes.cells.length;n++){ec=comp.errorInfoes.cells[n];rd=comp.dataModel.data[ec.rowIndex];if(rd==null||(rd.bookmark===undefined&&rd.isDetail)){continue;}self.showError("表格("+comp.key+" "+comp.caption+")第"+(ec.rowIndex+1)+"行,第"+(ec.colIndex+(comp.showRowHead?1:0))+"列:"+ec.errorMsg);result=false;isBreak=true;break;}if(isBreak){break;}for(var ri=0,rlen=comp.getRowCount();ri<rlen;ri++){var rowData=comp.getRowDataAt(ri);if(rowData==null||(rowData.isDetail&&rowData.bookmark==null)){continue;}for(var ci=0,clen=comp.getColumnCount();ci<clen;ci++){var cellData=comp.getCellDataAt(ri,ci),cm=comp.dataModel.colModel.columns[ci];if(cellData[3]){self.showError("表格("+comp.key+" "+comp.caption+")\n第"+(ri+1)+"行,第"+(ci+(comp.showRowHead?1:0))+"列:"+cm.label+"为必填项");result=false;isBreak=true;break;}}}if(isBreak){break;}}else{if(!((comp.errorInfo&&comp.errorInfo.error)||comp.isRequired())){continue;}var parentGridKey=comp.getMetaObj().parentGridKey;if(comp.getMetaObj().isSubDetail&&parentGridKey!=null&&parentGridKey!=""){var grid=form.getComponent(parentGridKey);if(grid==null||grid.getFocusRowIndex()==-1){continue;}var pRowData=grid.getRowDataAt(grid.getFocusRowIndex());if(pRowData.isDetail&&pRowData.bookmark==null){continue;}}if(comp.errorInfo&&comp.errorInfo.error){self.showError("表单控件("+comp.key+" "+comp.caption+"):"+comp.errorInfo.msg);result=false;break;}else{if(comp.isRequired()){self.showError("表单控件("+comp.key+" "+comp.caption+")是必填项，当前未填值。");result=false;break;}}}}return result;}};return Return;};YIUI.EditOpt=function(form){var Return={doOpt:function(){form.setInitOperationState(YIUI.Form_OperationState.Edit);form.setOperationState(YIUI.Form_OperationState.Edit);form.resetUIStatus(YIUI.FormUIStatusMask.ENABLE|YIUI.FormUIStatusMask.VISIBLE|YIUI.FormUIStatusMask.OPERATION);form.initFirstFocus();}};return Return;};YIUI.SaveOpt=function(form){var Return={doOpt:function(){form.setOperationState(YIUI.Form_OperationState.Default);var paras={};paras.service="PureOpt";paras.cmd="GetOptScript";paras.formKey=form.formKey;paras.type=YIUI.OptScript.SAVE;var formula=Svr.Request.getSyncData(Svr.SvrMgr.ServletURL,paras);form.eval(formula,{form:form},null);}};return Return;};YIUI.LoadOpt=function(form){var Return={doOpt:function(){form.setOperationState(YIUI.Form_OperationState.Default);var paras={};paras.service="PureOpt";paras.cmd="GetOptScript";paras.formKey=form.formKey;paras.type=YIUI.OptScript.LOAD;var formula=Svr.Request.getSyncData(Svr.SvrMgr.ServletURL,paras);form.eval(formula,{form:form},null);}};return Return;};YIUI.NewOpt=function(form,refreshUI){var Return={doOpt:function(){var paras={};paras.service="PureOpt";paras.cmd="GetNewDocument";paras.formKey=form.formKey;paras.type=YIUI.OptScript.LOAD;var document=Svr.Request.getSyncData(Svr.SvrMgr.ServletURL,paras);form.setDocument(document);form.setInitOperationState(YIUI.Form_OperationState.New);form.setOperationState(YIUI.Form_OperationState.New);if(refreshUI){form.showDocument();form.resetUIStatus(YIUI.FormUIStatusMask.ENABLE|YIUI.FormUIStatusMask.VISIBLE|YIUI.FormUIStatusMask.OPERATION);}}};return Return;};YIUI.CopyNewOpt=function(form){var Return={doOpt:function(){var paras={};paras.service="PureOpt";paras.cmd="GetNewCopyDocument";paras.formKey=form.formKey;paras.type=YIUI.OptScript.LOAD;var docStr=YIUI.DataUtil.toJSONDoc(form.getDocument());paras.document=$.toJSON(docStr);var document=Svr.Request.getSyncData(Svr.SvrMgr.ServletURL,paras);if(document){form.setDocument(document);}form.setInitOperationState(YIUI.Form_OperationState.New);form.setOperationState(YIUI.Form_OperationState.New);form.showDocument();form.resetUIStatus(YIUI.FormUIStatusMask.ENABLE|YIUI.FormUIStatusMask.VISIBLE|YIUI.FormUIStatusMask.OPERATION);}};return Return;};})();(function(){YIUI.ShowData=function(b){var a={resetDocument:function(){var d=b.getDocument();if(d==null){return;}var f=null;for(var e=0,c=d.tbls.length;e<c;e++){f=d.tbls[e];f.first();}},loadHeader:function(f){var c=b.getDocument();var e=f.getMetaObj().tableKey;var d=e&&c.getByKey(e);if(!d){return;}var i=f.getMetaObj().columnKey,g="";if(d.getRowCount()>0){g=d.getByKey(i);if(f.type==YIUI.CONTROLTYPE.DYNAMICDICT){var h=d.getByKey(i+"ItemKey");f.itemKey=h;}}f.setValue(g);},loadListView:function(c){var d=new YIUI.ShowListView(b,c);d.load();},loadGrid:function(c){var d=new YIUI.ShowGridData(b,c);d.load();},show:function(){this.resetDocument();var c=b.getComponentList(),e;for(var d in c){e=c[d];if(e.getMetaObj().isSubDetail){continue;}switch(e.type){case YIUI.CONTROLTYPE.LISTVIEW:this.loadListView(e);break;case YIUI.CONTROLTYPE.GRID:e.rootGroupBkmk=null;this.loadGrid(e);break;case YIUI.CONTROLTYPE.CHART:break;default:if(e instanceof YIUI.Control){if(e.needClean()&&!e.condition){e.setValue(null,false,false);}this.loadHeader(e);}break;}}this.postShowData();},postShowData:function(){b.getUIProcess().doPostShowData(false);b.getUIProcess().calcToolBar();b.initFirstFocus();}};return a;};YIUI.ShowListView=function(c,a){var b={load:function(){a.clearAllRows();var s=c.getDocument();var r=a.getMetaObj().tableKey;if(!r){return;}var A=s.getByKey(r);if(!A){return;}a.totalRowCount=A.allRows.length;var o=[],n,l,F;for(var v=0,h=A.getRowCount();v<h;v++){n={};A.setPos(v);for(var u=0,p=a.columnInfo.length;u<p;u++){var g=a.columnInfo[u];var G=g.key;n[G]={};var F=a.columnInfo[u].columnKey;if(F){var B="",t=A.getByKey(F);switch(g.columnType){case YIUI.CONTROLTYPE.DATEPICKER:if(t){var E=new Date(parseInt(t));var y="yyyy-MM-dd";if(!g.onlyDate){y="yyyy-MM-dd HH:mm:ss";}B=E.Format(y);t=E.toString();}break;case YIUI.CONTROLTYPE.DICT:var z=g.itemKey;var e=YIUI.TypeConvertor.toInt(t);B=YIUI.DictService.getCaption(z,e);break;case YIUI.CONTROLTYPE.COMBOBOX:var q=g.items;for(var w=0,x=q.length,D;w<x;w++){var D=q[w];if(D.value==t){B=D.caption;break;}}break;case YIUI.CONTROLTYPE.NUMBEREDITOR:var k=g.decScale;var f=g.roundingMode;var C=null;if(t){C=YIUI.TypeConvertor.toDecimal(t);B=C.toFormat(k,f);}break;default:B=A.getByKey(F);break;}n[G].caption=B;n[G].value=t;}else{n[G].caption=g.caption;n[G].value=g.caption;}}o.push(n);}if(!a.getMetaObj().pageRowCount||a.totalRowCount<a.getMetaObj().pageRowCount){a._pagination.hidePagination();}else{if(a.totalRowCount){a._pagination.setTotalRowCount(a.totalRowCount,true);}}a.data=o;a.addDataRow(o);a.addEmptyRow();}};return b;};})();(function(){YIUI.DefaultStatusProxy=YIUI.extend({form:null,init:function(form){this.form=form;},validateEnable:function(key,content,context,formEnable){var result=false;if(content!=null&&content.length>0){result=YIUI.TypeConvertor.toBoolean(this.form.eval(content,context,null));}else{result=formEnable;}return this.checkAccessControl(context,key)?result:false;},validateEnableByTree:function(key,syntaxTree,context,formEnable){var result=false;if(syntaxTree!=null){result=YIUI.TypeConvertor.toBoolean(this.form.evalByTree(syntaxTree,context,null));}else{result=formEnable;}return this.checkAccessControl(context,key)?result:false;},validateVisible:function(key,content,context){if(content!=null&&content.length>0){return YIUI.TypeConvertor.toBoolean(this.form.eval(content,context,null));}return true;},validateVisibleByTree:function(key,syntaxTree,context){if(syntaxTree!=null){return YIUI.TypeConvertor.toBoolean(this.form.evalByTree(syntaxTree,context,null));}return true;},checkAccessControl:function(context,key){var cellLocation=this.form.getCellLocation(key),metaComp=this.form.getComponent(key),result=true,dataTable,value;if(cellLocation!=null&&context!=null){var grid=this.form.getComponent(cellLocation.key),metaCell=grid.getMetaCellByKey(key);if(metaCell!=null&&this.accessControl(this.form,metaCell)){if(cellLocation.row!=null&&cellLocation.row!=-1){dataTable=this.form.getDocument().getByKey(metaCell.tableKey);value=0;if(dataTable.first()){value=YIUI.TypeConvertor.toInt(dataTable.getByKey(metaCell.columnKey+"_CF"));}if((value&YIUI.FormUIStatusMask.ENABLE)!=0){result=false;}}else{if(context.rowIndex!=null&&context.rowIndex!=-1){dataTable=this.form.getDocument().getByKey(grid.tableKey);var rowData=grid.getRowDataAt(context.rowIndex);if(rowData.isDetail&&rowData.bookmark!=null){if(grid.hasColExpand){var rowBkmk=rowData.bookmark[0];dataTable.setByBkmk(rowBkmk);}else{dataTable.setByBkmk(rowData.bookmark);}value=YIUI.TypeConvertor.toInt(dataTable.getByKey(metaCell.columnKey+"_CF"));if((value&YIUI.FormUIStatusMask.ENABLE)!=0){result=false;}}}}}}else{if(metaComp!=null){if(this.accessControlByComp(this.form,metaComp)){dataTable=this.form.getDocument().getByKey(metaComp.tableKey);value=0;if(dataTable.first()){value=YIUI.TypeConvertor.toInt(dataTable.getByKey(metaComp.columnKey+"_CF"));}if((value&YIUI.FormUIStatusMask.ENABLE)!=0){result=false;}}}}return result;},accessControl:function(form,metaCell){if(metaCell&&metaCell.tableKey&&metaCell.columnKey){var doc=form.getDocument();if(doc){var dataTable=doc.getByKey(metaCell.tableKey);if(dataTable==null){return false;}var cellKey=metaCell.columnKey;if(cellKey==null||cellKey.length==0){return false;}return dataTable.getColByKey(cellKey).getAccessControl();}}return false;},accessControlByComp:function(form,comp){if(comp&&comp.tableKey&&comp.columnKey){var doc=form.getDocument();if(doc){var dataTable=doc.getByKey(comp.tableKey);if(dataTable==null){return false;}var cellKey=comp.columnKey;if(cellKey==null||cellKey.length==0){return false;}return dataTable.getColByKey(cellKey).getAccessControl();}}return false;}});YIUI.HostStatusProxy=YIUI.extend({info:null,init:function(info){this.info=info;},containsEnableKey:function(key){var enableList=this.info["enableList"];return enableList?$.inArray(key,enableList)!=-1:false;},containsUnVisibleKey:function(key){var unVisibleList=this.info["visibleList"];return unVisibleList?$.inArray(key,unVisibleList)!=-1:false;},containsOperationKey:function(key){var optList=this.info["optList"];return optList?$.inArray(key,optList)!=-1:false;}});})();(function(){YIUI.UIProcess=function(form){this.form=form;this.enableProcess=new YIUI.UIEnableProcess(form);this.visibleProcess=new YIUI.UIVisibleProcess(form);this.calcProcess=new YIUI.UICalcProcess(form);this.checkRuleProcess=new YIUI.UICheckRuleProcess(form);this.dependencyProcess=new YIUI.UIDependencyProcess(form);this.checkAll=function(){this.checkRuleProcess.checkAll();};this.resetUIStatus=function(mask){var calcEnable=(mask&YIUI.FormUIStatusMask.ENABLE)!=0;var calcVisible=(mask&YIUI.FormUIStatusMask.VISIBLE)!=0;var addOperation=(mask&YIUI.FormUIStatusMask.OPERATION)!=0;if(calcEnable){this.enableProcess.calcAll();}if(calcVisible){this.visibleProcess.calcAll();}if(addOperation){this.calcToolBar();}};this.calcToolBar=function(){var tblKey=form.defTbr,tbl=form.getComponent(tblKey);if(tbl&&!tbl.isDestroyed){var map={};for(var i=0,len=tbl.items.length;i<len;i++){var item=tbl.items[i];var visible,enable;var f=form;if(item.formID){f=YIUI.FormStack.getForm(item.formID);}var cxt={form:f};if(f){visible=item.visibleCont?f.eval(item.visibleCont,cxt,null):tbl.visible;enable=item.enableCont?f.eval(item.enableCont,cxt,null):tbl.enable;}else{visible=false;enable=false;item.needDelete=true;}item.visible=visible;item.enable=enable;if(item.items){for(var m=0,len2=item.items.length;m<len2;m++){visible=item.items[m].visibleCont?f.eval(item.items[m].visibleCont,cxt,null):tbl.visible;item.items[m].visible=visible;enable=item.items[m].enableCont?f.eval(item.items[m].enableCont,cxt,null):tbl.enable;item.items[m].enable=enable;}}map[item.key]=item;}var optMap=form.getOptMap();for(var key in map){if(map[key].needDelete){delete optMap[key];continue;}var opt=optMap[key];if(opt){opt.opt=map[key];}}tbl.repaint();}};this.doPostShowData=function(commitValue){this.calcProcess.calcAll(commitValue);this.enableProcess.calcAll();this.visibleProcess.calcAll();this.checkRuleProcess.checkAll();this.dependencyProcess.calcAll();};this.calcEmptyRow=function(grid,rowIndex){this.calcProcess.calcEmptyRow(grid,rowIndex);this.enableProcess.calcEmptyRow(grid,rowIndex);this.checkRuleProcess.calcEmptyRow(grid,rowIndex);this.dependencyProcess.calcEmptyRow(grid,rowIndex);};this.doValueChanged=function(key){this.calcProcess.valueChanged(key);var control=this.form.getComponent(key);if(control.valueChanged){this.form.eval(control.valueChanged,{form:this.form});}};this.doPostValueChanged=function(key){this.enableProcess.valueChanged(key);this.visibleProcess.valueChanged(key);this.checkRuleProcess.valueChanged(key);this.dependencyProcess.valueChanged(key);};this.doPreCellValueChanged=function(grid,rowIndex,colIndex,cellKey){this.dependencyProcess.cellValChanged(grid,rowIndex,colIndex,cellKey);};this.doCellValueChanged=function(grid,rowIndex,colIndex,cellKey){this.calcProcess.cellValChanged(grid,rowIndex,colIndex,cellKey);};this.doPostCellValueChanged=function(grid,rowIndex,colIndex,cellKey){this.enableProcess.cellValChanged(grid,rowIndex,colIndex,cellKey);this.visibleProcess.cellValChanged(grid,rowIndex,colIndex,cellKey);this.checkRuleProcess.cellValChanged(grid,rowIndex,colIndex,cellKey);};this.calcSubDetail=function(gridKey){this.calcProcess.calcSubDetail(gridKey);this.enableProcess.calcSubDetail(gridKey);this.visibleProcess.calcSubDetail(gridKey);this.checkRuleProcess.checkSubDetail(gridKey);};this.doPostInsertRow=function(grid,rowIndex){this.calcProcess.calcEmptyRow(grid,rowIndex);this.enableProcess.doAfterInsertRow(grid,rowIndex);this.checkRuleProcess.calcEmptyRow(grid,rowIndex);this.dependencyProcess.calcEmptyRow(grid,rowIndex);};this.doPostDeleteRow=function(grid,rowIndex){this.calcProcess.doAfterDeleteRow(grid,rowIndex);this.enableProcess.doAfterDeleteRow(grid,rowIndex);this.checkRuleProcess.doAfterDeleteRow(grid,rowIndex);};this.doPostClearAllRow=function(grid){this.enableProcess.doAfterDeleteRow(grid,-1);};this.preFireValueChanged=function(key){this.dependencyProcess.valueChanged(key);};this.postFireValueChanged=function(key){this.enableProcess.valueChanged(key);this.visibleProcess.valueChanged(key);this.checkRuleProcess.valueChanged(key);};};YIUI.UIEnableProcess=YIUI.extend(YIUI.AbstractUIProcess,{EnabltItemType:{Head:0,List:1,Column:2,Operation:3},init:function(form){this.base(form);},doAfterDeleteRow:function(grid,rowIndex){this.calcRowCountChange(grid,rowIndex);},doAfterInsertRow:function(grid,rowIndex){var items=this.form.dependency.enableTree.items;var i,expItem,len;for(i=0,len=items.length;i<len;i++){expItem=items[i];if(expItem.type==YIUI.ExprItem_Type.Set&&expItem.source==grid.key){this.calcExpItem(expItem);}}this.calcRowCountChange(grid,rowIndex);},calcRowCountChange:function(grid,rowIndex){var calcKey1=grid.key+":RowCount",calcKey2=grid.key+":RowIndex";var affectItems=this.form.dependency.enableTree.affectItems;var item,expItems,expItem;for(var i=0,len=affectItems.length;i<len;i++){item=affectItems[i];if(item.key==calcKey1||item.key==calcKey2){expItems=item.expItems;for(var j=0,length=expItems.length;j<length;j++){expItem=expItems[j];var isFinish=false;if(expItem.items!=null&&expItem.items.length>0){var subExpItem,sTrees=[];for(var ti=0,tlen=expItem.items.length;ti<tlen;ti++){subExpItem=expItem.items[ti];sTrees[ti]=this.form.getSyntaxTree(subExpItem.right);var cellLocation=this.form.getCellLocation(subExpItem.left);if(cellLocation!=null){if(cellLocation.key==grid.key){this.calcDetailRow(grid,subExpItem,sTrees,ti,rowIndex,this.getFormEnable());isFinish=true;}else{if(grid.parentGrid!=null&&grid.parentGrid==cellLocation.key){var targetGrid=this.form.getComponent(cellLocation.key);this.calcDetailRow(targetGrid,subExpItem,sTrees,ti,targetGrid.getFocusRowIndex(),this.getFormEnable());isFinish=true;}}}}}if(!isFinish){this.calcExpItem(expItem,true);}}}}},calcAll:function(){var items=this.form.dependency.enableTree.items;var i,expItem,len;for(i=0,len=items.length;i<len;i++){expItem=items[i];this.calcExpItem(expItem);}},valueChanged:function(key){var affectItems=this.form.dependency.enableTree.affectItems;var item,expItems,expItem;for(var i=0,len=affectItems.length;i<len;i++){item=affectItems[i];if(item.key==key){expItems=item.expItems;for(var j=0,length=expItems.length;j<length;j++){expItem=expItems[j];if(expItem.type==YIUI.EnableItem.Operation){if(YIUI.TypeConvertor.toBoolean(this.form.eval(expItem.right,{form:this.form},null))){this.form.setOperationEnable(expItem.left,true);}else{this.form.setOperationEnable(expItem.left,false);}}else{this.calcExpItem(expItem,true);}}}}},calcOptItem:function(expItem){var optInfo=this.form.getOptMap()[expItem.left];if(optInfo){var toolbar=this.form.getComponent(optInfo.barKey);var enable=this.form.eval(expItem.right,{form:this.form},null);if(enable==null){enable=this.getFormEnable();}toolbar.setItemEnable(expItem.left,enable);}},dealSubDetailComps:function(form,comp,cellKey,enable){var subDetailComps=form.getCellSubDtlComps(comp.key,cellKey);if(subDetailComps!=null){for(var si=0,slen=subDetailComps.length;si<slen;si++){var subDtlComp=subDetailComps[si];subDtlComp.setEnable(enable);}}},calcDetailRow:function(comp,subExpItem,sTrees,treeIndex,rowIndex,formEnable){var evalV=null,evalEnable;if(!comp.getRowDataAt(rowIndex).isDetail){return false;}evalV=this.calcEnableByTree(this.form,subExpItem.left,sTrees[treeIndex],formEnable,rowIndex,comp.getCellIndexByKey(subExpItem.left));evalEnable=(evalV===null?formEnable:evalV);if(subExpItem.left==""){return false;}comp.setCellEnable(rowIndex,subExpItem.left,evalEnable);this.dealSubDetailComps(this.form,comp,subExpItem.left,evalEnable);return true;},calcEnable:function(form,expItem,formEnable,rowIndex,colIndex){if(!this.hasEnableRights(expItem.left)){return false;}return form.defaultUIStatusProxy.validateEnable(expItem.left,expItem.right,{form:form,rowIndex:rowIndex,colIndex:colIndex},formEnable);},calcEnableByTree:function(form,key,syntaxTree,formEnable,rowIndex,colIndex){if(!this.hasEnableRights(key)){return false;}return form.defaultUIStatusProxy.validateEnableByTree(key,syntaxTree,{form:form,rowIndex:rowIndex,colIndex:colIndex},formEnable);},calcExpItem:function(expItem,needCalc,isCalcSubDetailComp){var comp=this.form.getComponent(expItem.source);if(comp==undefined){comp=this.form.getPanel(expItem.source);}if(comp===undefined){this.calcOptItem(expItem);return;}var enable=null;if(enable==null&&isCalcSubDetailComp&&comp.getMetaObj().bindingCellKey!=null){var parentGrid=YIUI.SubDetailUtil.getBindingGrid(this.form,comp),cellData=parentGrid.getCellDataByKey(parentGrid.getFocusRowIndex(),comp.getMetaObj().bindingCellKey);if(cellData!=null){enable=cellData[2];}}if(enable==null){enable=this.getFormEnable();}if(expItem.type!==this.EnabltItemType.List){enable=this.calcEnable(this.form,expItem,enable);}switch(expItem.type){case YIUI.ExprItem_Type.Item:if(comp.type==YIUI.CONTROLTYPE.GRID){comp.setGridEnable(enable);}else{comp.setEnable(enable);}var cell_key=comp.getMetaObj().bindingCellKey;if(needCalc&&cell_key!=null&&cell_key!=""){var grid=YIUI.SubDetailUtil.getBindingGrid(this.form,comp);if(grid!=null){grid.setCellEnable(grid.getFocusRowIndex(),cell_key,enable);}}break;case YIUI.ExprItem_Type.Set:if(comp.type==YIUI.CONTROLTYPE.LISTVIEW){$.each(comp.columnInfo,function(i,column){if(column.key==expItem.left){column.enable=enable;column.el&&comp.setColumnEnable(column.enable,column.el);}});}else{if(comp.type==YIUI.CONTROLTYPE.GRID){if(expItem.items==undefined){if(expItem.source==expItem.left){comp.setGridEnable(enable);}else{if(expItem.left!==""){var fixRowInfoes=comp.getFixRowInfoByCellKey(expItem.left);if(fixRowInfoes!==null){for(var n=0,nlen=fixRowInfoes.length;n<nlen;n++){evalV=this.calcEnable(this.form,expItem,enable,fixRowInfoes[n].rowIndex,fixRowInfoes[n].colIndex);evalEnable=(evalV===null?enable:evalV);comp.setCellEnable(fixRowInfoes[n].rowIndex,expItem.left,evalEnable);this.dealSubDetailComps(this.form,comp,expItem.left,evalEnable);}}}}}else{var subExpItem,evalV=null,evalEnable,sTrees=[];for(var ti=0,tlen=expItem.items.length;ti<tlen;ti++){subExpItem=expItem.items[ti];sTrees[ti]=this.form.getSyntaxTree(subExpItem.right);}for(var ind=0,ilen=expItem.items.length;ind<ilen;ind++){subExpItem=expItem.items[ind];if(subExpItem.type==this.EnabltItemType.Column){if(subExpItem.left==""){continue;}evalV=this.calcEnableByTree(this.form,subExpItem.left,sTrees[ind],enable);evalEnable=(evalV===null?enable:evalV);var colInfoes=comp.getFixRowInfoByCellKey(subExpItem.left);if(colInfoes==null){colInfoes=comp.getColInfoByKey(subExpItem.left);}if(colInfoes!==null){for(var ci=0,len=colInfoes.length;ci<len;ci++){comp.setColumnEnable(ci,evalEnable);}}}else{for(var i=0,clen=comp.getRowCount();i<clen;i++){this.calcDetailRow(comp,subExpItem,sTrees,ind,i,enable);}}}}comp.reShowCheckColumn();}}break;}},cellValChanged:function(grid,rowIndex,colIndex,cellKey){var affectItems=this.form.dependency.enableTree.affectItems;var item,expItems,enable,expItem,subItem,colInfoes;for(var i=0,len=affectItems.length;i<len;i++){item=affectItems[i];if(item.key.toLowerCase()==cellKey.toLowerCase()){expItems=item.expItems;for(var j=0,length=expItems.length;j<length;j++){expItem=expItems[j];if(expItem.items){for(var ind=0,elen=expItem.items.length;ind<elen;ind++){subItem=expItem.items[ind];if(subItem.left==""){continue;}colInfoes=grid.getColInfoByKey(subItem.left);if(colInfoes==null){continue;}for(var m=0,mlen=colInfoes.length;m<mlen;m++){enable=this.form.eval(subItem.right,{form:this.form,rowIndex:rowIndex,colIndex:colInfoes[m].colIndex},null);if(enable===null){enable=this.getFormEnable();}grid.setCellEnable(rowIndex,subItem.left,enable);this.dealSubDetailComps(this.form,grid,subItem.left,enable);}}}else{if(expItem.left==""){continue;}colInfoes=grid.getFixRowInfoByCellKey(expItem.left);if(colInfoes==null){continue;}for(var n=0,nlen=colInfoes.length;n<nlen;n++){enable=this.form.eval(expItem.right,{form:this.form,rowIndex:colInfoes[n].rowIndex,colIndex:colInfoes[n].colIndex},null);if(enable===null){enable=this.getFormEnable();}grid.setCellEnable(colInfoes[n].rowIndex,expItem.left,enable);this.dealSubDetailComps(this.form,grid,expItem.left,enable);}}}}}},calcEmptyRow:function(grid,rowIndex){var items=this.form.dependency.enableTree.items;var i,expItem,subItem,enable,len;for(i=0,len=items.length;i<len;i++){expItem=items[i];if(expItem.source===grid.key&&expItem.type===this.EnabltItemType.List){if(!expItem.items){continue;}for(var ind=0,elen=expItem.items.length;ind<elen;ind++){subItem=expItem.items[ind];if(subItem.type==this.EnabltItemType.Column){continue;}enable=this.form.eval(subItem.right,{form:this.form,rowIndex:rowIndex},null);if(enable===null){enable=this.getFormEnable();}if(subItem.left==""){continue;}grid.setCellEnable(rowIndex,subItem.left,enable);}}}this.calcRowCountChange(grid,rowIndex);},getFormEnable:function(){var operationState=this.form.getOperationState();return(operationState==YIUI.Form_OperationState.New||operationState==YIUI.Form_OperationState.Edit);},calcSubDetail:function(gridKey){var items=this.form.dependency.enableTree.items;var i,expItem,len,comp;for(i=0,len=items.length;i<len;i++){expItem=items[i];comp=this.form.getComponent(expItem.source);if(comp&&comp.getMetaObj().isSubDetail&&comp.getMetaObj().parentGridKey==gridKey){this.calcExpItem(expItem,false,true);}}}});YIUI.UIVisibleProcess=YIUI.extend(YIUI.AbstractUIProcess,{VisibleItemType:{Head:0,Column:1,Operation:2},init:function(form){this.base(form);},calcAll:function(){var items=this.form.dependency.visibleTree.items;var i,expItem,len;for(i=0,len=items.length;i<len;i++){expItem=items[i];this.calcExpItem(expItem);}},valueChanged:function(key){var affectItems=this.form.dependency.visibleTree.affectItems;var item,expItems,expItem;for(var i=0,len=affectItems.length;i<len;i++){item=affectItems[i];if(item.key.toLowerCase()==key.toLowerCase()){expItems=item.expItems;for(var j=0,length=expItems.length;j<length;j++){expItem=expItems[j];this.calcExpItem(expItem);}}}},cellValChanged:function(grid,rowIndex,colIndex,cellKey){var affectItems=this.form.dependency.visibleTree.affectItems;var item,expItems,expItem;for(var i=0,len=affectItems.length;i<len;i++){item=affectItems[i];if(item.key.toLowerCase()==cellKey.toLowerCase()){expItems=item.expItems;for(var j=0,length=expItems.length;j<length;j++){expItem=expItems[j];this.calcExpItem(expItem);}}}},calcOptItem:function(expItem){var optInfo=this.form.getOptMap()[expItem.left];if(optInfo){var toolbar=this.form.getComponent(optInfo.barKey);var visible=this.form.eval(expItem.right,{form:this.form},null);visible=(visible===null?true:visible);toolbar.setItemVisible(expItem.left,visible);}},calcVisible:function(form,expItem){if(!this.hasVisibleRights(expItem.left)){return false;}return form.defaultUIStatusProxy.validateVisible(expItem.left,expItem.right,{form:form});},calcExpItem:function(expItem){var comp=this.form.getComponent(expItem.source);if(comp==undefined){comp=this.form.getPanel(expItem.source);this.calcOptItem(expItem);return;}var visible=this.calcVisible(this.form,expItem);switch(expItem.type){case YIUI.ExprItem_Type.Item:if(comp.isBuddy()){return;}comp.setVisible(visible);if(!comp.isVisible()&&(comp.errorInfo.error||comp.isRequired())){if(!this.form.errorInfo.error){if(comp.isRequired()){this.form.setError(true,comp.key+"必填",comp.key);}else{this.form.setError(true,comp.errorInfo.msg,comp.key);}}}else{if(this.form.errorInfo.error&&this.form.errorInfo.errorSource!=null&&this.form.errorInfo.errorSource==comp.key){this.form.setError(false,null);}}var ownerCt=comp.ownerCt;if(ownerCt&&ownerCt.type==YIUI.CONTROLTYPE.FLUIDTABLELAYOUTPANEL){if(comp.visible==visible){return;}ownerCt.reLayout();}break;case YIUI.ExprItem_Type.Set:if(comp.type==YIUI.CONTROLTYPE.LISTVIEW){var i,column,len;for(i=0,len=comp.columnInfo.length;i<len;i++){column=comp.columnInfo[i];if(column.key===expItem.left){column.visible=visible;comp.setColumnVisible(column.key,visible);break;}}}else{if(comp.type==YIUI.CONTROLTYPE.GRID){if(expItem.type!==this.VisibleItemType.Column){return;}comp.setColumnVisible(expItem.left,visible);}}break;}},calcSubDetail:function(gridKey){var items=this.form.dependency.visibleTree.items;var i,expItem,comp,len;for(i=0,len=items.length;i<len;i++){expItem=items[i];comp=this.form.getComponent(expItem.source);if(comp&&comp.getMetaObj().isSubDetail&&comp.getMetaObj().parentGridKey==gridKey){this.calcExpItem(expItem);}}}});YIUI.UICalcProcess=function(form){this.CalcItemType={Head:0,List:1};this.form=form;this.doAfterDeleteRow=function(grid,rowIndex){var metaDtlRow=grid.metaRowInfo.rows[grid.metaRowInfo.dtlRowIndex];var affectItems=form.dependency.calcTree.affectItems;var item,expItems,expItem,needCalcItems=[];for(var i=0,len=metaDtlRow.cells.length;i<len;i++){var metaCell=metaDtlRow.cells[i];for(var ind=0,ilen=affectItems.length;ind<ilen;ind++){item=affectItems[ind];if(item.key.toLowerCase()==metaCell.key.toLowerCase()){if(item.expItems==null||item.expItems.length==0){needCalcItems.push(item);}else{for(var m=0,mlen=item.expItems.length;m<mlen;m++){expItem=item.expItems[m];var g=form.getComponent(expItem.source);if(YIUI.SubDetailUtil.isSubDetail(form,grid,g.key)){this.calcEmptyRow(g,g.getFocusRowIndex());}}}}}}needCalcItems.sort(function(item1,item2){return parseFloat(item1.order)-parseFloat(item2.order);});for(var k=0,kLen=needCalcItems.length;k<kLen;k++){this.calcExpItem(needCalcItems[k],true);}};this.calcAll=function(commitValue){switch(form.getOperationState()){case YIUI.Form_OperationState.New:this.calcAllItems(true,commitValue);break;case YIUI.Form_OperationState.Default:case YIUI.Form_OperationState.Edit:this.calcAllItems(false,commitValue);break;default:break;}};this.calcAllItems=function(calcAll,commitValue){var items=form.dependency.calcTree.items;var i,expItem,len;for(i=0,len=items.length;i<len;i++){expItem=items[i];this.calcExpItem(expItem,calcAll,commitValue);}};this.valueChanged=function(key){var affectItems=form.dependency.calcTree.affectItems;var item,expItems,expItem;for(var i=0,len=affectItems.length;i<len;i++){item=affectItems[i];if(item.key.toLowerCase()==key.toLowerCase()){expItems=item.expItems;for(var j=0,length=expItems.length;j<length;j++){expItem=expItems[j];this.calcExpItem(expItem,true);}}}};this.hasDefaultValue=function(expItem){return(expItem.formulaValue!==null&&expItem.formulaValue.length>0)||(expItem.defaultValue!==null&&expItem.defaultValue.length>0);};this.isNeedCalcDefaultValue=function(curGridKey,metaRow,rowIndex,cellIndex){var valueDependency=metaRow.cells[cellIndex].valueDependency,isNeedCalc=true;if(valueDependency!=null){var dependencyArray=valueDependency.split(",");for(var di=0,dlen=dependencyArray.length;di<dlen;di++){var dependency=dependencyArray[di],dpComp=form.getCellLocation(dependency);if(dpComp==null){dpComp=form.getComponent(dependency);}else{dpComp=form.getComponent(dpComp.key);}if(dpComp!=null&&dpComp.parentGrid!=null&&dpComp.parentGrid==curGridKey){var pGrid=form.getComponent(dpComp.parentGrid);if(pGrid!=null&&pGrid.getFocusRowIndex()!=rowIndex){isNeedCalc=false;}}}}return isNeedCalc;};this.getCalcValue=function(expItem,rowIndex,colIndex,gridKey,metaRow){var value,cxt={form:form};if(expItem.formulaValue!==null&&expItem.formulaValue.length>0){if((metaRow!=null&&this.isNeedCalcDefaultValue(gridKey,metaRow,rowIndex,colIndex))||metaRow==null){value=form.eval(expItem.formulaValue,{form:form,target:expItem.left,rowIndex:rowIndex,colIndex:colIndex},null);}}else{if(expItem.defaultValue!==null&&expItem.defaultValue.length>0){value=expItem.defaultValue;}}return value;};this.cellValChanged=function(grid,rowIndex,cellIndex,cellkey){var affectItems=form.dependency.calcTree.affectItems,self=this,item,expItems,expItem,value,colInfoes,comp,calcV,metaRow;for(var i=0,len=affectItems.length;i<len;i++){item=affectItems[i];if(item.key.toLowerCase()==cellkey.toLowerCase()){expItems=item.expItems;for(var j=0,length=expItems.length;j<length;j++){expItem=expItems[j];comp=form.getComponent(expItem.source);if(comp.type==YIUI.CONTROLTYPE.GRID){colInfoes=comp.getFixRowInfoByCellKey(expItem.left);if(colInfoes==null){colInfoes=comp.getColInfoByKey(expItem.left);if(colInfoes!==null){for(var m=0,mlen=colInfoes.length;m<mlen;m++){metaRow=comp.metaRowInfo.rows[comp.metaRowInfo.dtlRowIndex];calcV=self.getCalcValue(expItem,rowIndex,colInfoes[m].colIndex,grid.key,metaRow);if(calcV===undefined){continue;}comp.setValueAt(rowIndex,colInfoes[m].colIndex,calcV,true,false,true);}}}else{for(var n=0,nlen=colInfoes.length;n<nlen;n++){metaRow=comp.metaRowInfo.rows[colInfoes[n].metaRowIndex];calcV=self.getCalcValue(expItem,colInfoes[n].rowIndex,colInfoes[n].colIndex,grid.key,metaRow);if(calcV===undefined){continue;}comp.setValueAt(colInfoes[n].rowIndex,colInfoes[n].colIndex,calcV,true,false,true);}}YIUI.GridSumUtil.evalSum(form,comp);}else{value=this.getCalcValue(expItem);comp.setValue(value,true,false);}}}}};this.calcExpItem=function(expItem,calcAll,commitValue){var comp=form.getComponent(expItem.source),needCalc,calcV;if(comp===undefined){return;}switch(expItem.type){case YIUI.ExprItem_Type.Item:var hasData=(comp.tableKey!==undefined&&comp.tableKey.length!==0&&comp.columnKey!==undefined&&comp.columnKey.length!==0);if(calcAll){needCalc=true;}else{needCalc=!hasData&&(comp.getMetaObj().bindingCellkey==undefined||comp.getMetaObj().bindingCellkey.length==0);}if(needCalc){calcV=this.getCalcValue(expItem);if(calcV!==undefined){comp.setValue(calcV,true,false);}}break;case YIUI.ExprItem_Type.Set:if(comp.type==YIUI.CONTROLTYPE.LISTVIEW){var getColInfo=function(colKey){var colInfo;for(var ind=0,clen=comp.columnInfo.length;ind<clen;ind++){colInfo=comp.columnInfo[ind];if(colInfo.key===colKey){return{index:ind,col:colInfo};}}return null;};var colInfo=getColInfo(expItem.left);if(calcAll){needCalc=true;}else{needCalc=colInfo.col.columnKey===undefined||(colInfo.col.columnKey.length==0);}if(needCalc){for(var i=0,len=comp.data.length;i<len;i++){calcV=this.getCalcValue(expItem,i,colInfo.index);if(calcV!==undefined){comp.setValByIndex(i,colInfo.index,calcV);}}}}else{if(comp.type==YIUI.CONTROLTYPE.GRID){var rowData,self=this,cEditOpt,cInfoes=comp.getFixRowInfoByCellKey(expItem.left),cInfo,isNotDetail=true;var calcValue=function(colInfo,rowIndex,colIndex){cEditOpt=cInfo.cell;if(calcAll){needCalc=true;}else{needCalc=(cEditOpt.columnKey==undefined||cEditOpt.columnKey.length==0);}if(needCalc&&self.hasDefaultValue(expItem)){rowData=comp.getRowDataAt(rowIndex);var commit=!(rowData.isDetail&&rowData.bookmark==undefined)&&commitValue;calcV=self.getCalcValue(expItem,rowIndex,colIndex,comp.key,colInfo.metaRow);if(calcV!==undefined){comp.setValueAt(rowIndex,colIndex,calcV,commit,false,true);}}};if(cInfoes==null){cInfoes=comp.getColInfoByKey(expItem.left);isNotDetail=false;}if(cInfoes==null){return;}if(isNotDetail){for(var m=0,mlen=cInfoes.length;m<mlen;m++){cInfo=cInfoes[m];calcValue(cInfo,cInfo.rowIndex,cInfo.colIndex);}}else{for(var ind=0,dlen=comp.getRowCount();ind<dlen;ind++){rowData=comp.getRowDataAt(ind);if(rowData.isDetail){for(var n=0,nlen=cInfoes.length;n<nlen;n++){cInfo=cInfoes[n];calcValue(cInfo,ind,cInfo.colIndex);}}}}YIUI.GridSumUtil.evalSum(form,comp);}}break;}};this.calcEmptyRow=function(grid,rowIndex){var items=form.dependency.calcTree.items,rd=grid.getRowDataAt(rowIndex);if(!rd.isDetail){return;}var i,len,expItem,colInfoes,value,needCalc,calcV,rnct,colIndex;for(i=0,len=items.length;i<len;i++){expItem=items[i];if(expItem.source===grid.key&&expItem.type===this.CalcItemType.List){colInfoes=grid.getColInfoByKey(expItem.left);if(colInfoes==null){continue;}for(var j=0,jlen=colInfoes.length;j<jlen;j++){colIndex=colInfoes[j].colIndex;rnct=grid.showRowHead?1:0;calcV=this.getCalcValue(expItem,rowIndex,colIndex,grid.key,colInfoes[j].metaRow);if(calcV==undefined){continue;}grid.setValueAt(rowIndex,colIndex,calcV,false,true,true,true);value=null;}}}};this.calcSubDetail=function(gridKey){var items=form.dependency.calcTree.items;var i,expItem,len,comp;for(i=0,len=items.length;i<len;i++){expItem=items[i];comp=form.getComponent(expItem.source);if(comp&&comp.getMetaObj().isSubDetail&&comp.getMetaObj().parentGridKey==gridKey){this.calcExpItem(expItem);}}};};YIUI.UICheckRuleProcess=function(form){this.CheckRuleItemType={Head:0,List:1};this.form=form;this.checkAll=function(){var formState=form.getOperationState();var enableOnly=(formState==YIUI.Form_OperationState.New||formState==YIUI.Form_OperationState.Edit)?false:formState==YIUI.Form_OperationState.Default;this.checkGlobal();this.checkAllComponent(enableOnly);this.checkAllRowCheckRule();};this.checkGlobal=function(){if(!form.checkRules){return;}var i,len,checkRule,result=true;for(i=0,len=form.checkRules.length;i<len;i++){checkRule=form.checkRules[i];if(checkRule.content&&checkRule.content.length>0){result=form.eval($.trim(checkRule.content),{form:form},null);form.setError(!result,checkRule.errorMsg);if(!result){break;}}}};this.checkAllRowCheckRule=function(){var i,j,gridInfo,grid,len,dlen;for(i=0,len=form.getGridInfoMap().length;i<len;i++){gridInfo=form.getGridInfoMap()[i];grid=form.getComponent(gridInfo.key);grid.errorInfoes.rows=[];for(j=0,dlen=grid.getRowCount();j<dlen;j++){if(grid.getRowDataAt(j).isDetail){this.checkRow(grid,j);}}grid.setGridErrorRows(grid.errorInfoes.rows);}};this.checkRow=function(grid,rowIndex){if(rowIndex==-1||grid.rowCheckRules==null){return;}var k,len,rowCheckRule,result=true,metaRowIndex=grid.getRowDataAt(rowIndex).metaRowIndex,rowCheckRules;if(grid.rowCheckRules){rowCheckRules=grid.rowCheckRules[metaRowIndex];}if(!rowCheckRules){return;}for(k=0,len=rowCheckRules.length;k<len;k++){rowCheckRule=rowCheckRules[k];result=form.eval($.trim(rowCheckRule.content),{form:form,rowIndex:rowIndex},null);if(!result){var length=grid.errorInfoes.rows.length,errorRow,match=false;for(var m=0;m<length;m++){errorRow=grid.errorInfoes.rows[m];if(errorRow.rowIndex==rowIndex){match=true;break;}}if(!match){grid.errorInfoes.rows.push({rowIndex:rowIndex,errorMsg:rowCheckRule.errorMsg});}}else{var rlen=grid.errorInfoes.rows.length,errRow;for(var i=rlen-1;i>=0;i--){errRow=grid.errorInfoes.rows[i];if(errRow.rowIndex==rowIndex){grid.errorInfoes.rows.splice(i,1);}}}}};var impl_rowCountChanged=function(grid){var affectItems=form.dependency.checkRuleTree.affectItems;var item,expItems,expItem,colIndex,result;var key=grid.key+":RowCount";for(var i=0,len=affectItems.length;i<len;i++){item=affectItems[i];if(item.key.toLowerCase()!==key.toLowerCase()){continue;}expItems=item.expItems;for(var j=0,length=expItems.length;j<length;j++){expItem=expItems[j];var comp=form.getComponent(expItem.source);if(expItem.items&&comp.type==YIUI.CONTROLTYPE.GRID){for(var k=0,size=expItem.items.length;k<size;k++){var exp=expItem.items[i];var colInfoes=comp.getColInfoByKey(exp.left);if(!colInfoes){continue;}for(var k=0,len=colInfoes.length;k<len;k++){colIndex=colInfoes[j].colIndex;result=form.eval(exp.content,{form:form,rowIndex:comp.getFocusRowIndex(),colIndex:colIndex},null);comp.modifyCellErrors(comp.getFocusRowIndex(),colIndex,result,exp.errorMsg);}}}else{this.checkComponent(expItem,false,true);}}}};this.doAfterDeleteRow=function(grid,rowIndex){this.checkGlobal();impl_rowCountChanged.call(this,grid);};this.checkAllComponent=function(enableOnly){var items=form.dependency.checkRuleTree.items;var i,expItem,gridMap=form.getGridInfoMap(),len=gridMap.length,ilen=items.length;for(var j=0;j<len;j++){var grid=form.getComponent(gridMap[j].key);grid.errorInfoes.cells=[];}for(i=0;i<ilen;i++){expItem=items[i];this.checkComponent(expItem,enableOnly,false);}};this.checkComponent=function(expItem,enableOnly,needCheck){var comp=form.getComponent(expItem.source),result=true;if(comp===undefined||(enableOnly&&!comp.isEnable())){return;}if(comp.type==YIUI.CONTROLTYPE.GRID){if(expItem.items==undefined){if(expItem.content&&expItem.content.length>0){var fixRowInfoes=comp.getFixRowInfoByCellKey(expItem.left),fixRowInfo;if(fixRowInfoes==null){return;}for(var fi=0,flen=fixRowInfoes.length;fi<flen;fi++){fixRowInfo=fixRowInfoes[fi];result=form.eval($.trim(expItem.content),{form:form,rowIndex:fixRowInfo.rowIndex,colIndex:fixRowInfo.colIndex},null);comp.modifyCellErrors(fixRowInfo.rowIndex,fixRowInfo.colIndex,result,expItem.errorMsg);}}else{return;}}else{var subExpItem,colInfoes,rowData;for(var ind=0,len=expItem.items.length;ind<len;ind++){subExpItem=expItem.items[ind];if(!subExpItem.content||subExpItem.content.length==0){continue;}for(var i=0,dlen=comp.getRowCount();i<dlen;i++){rowData=comp.getRowDataAt(i);if(!rowData.isDetail){continue;}colInfoes=comp.getColInfoByKey(subExpItem.left);if(colInfoes==null){continue;}for(var ci=0,clen=colInfoes.length;ci<clen;ci++){result=form.eval(subExpItem.content,{form:form,rowIndex:i,colIndex:colInfoes[ci].colIndex},null);comp.modifyCellErrors(i,colInfoes[ci].colIndex,result,subExpItem.errorMsg);}}}}comp.setGridErrorCells(comp.errorInfoes.cells);}else{if(comp.type==YIUI.CONTROLTYPE.LISTVIEW){}else{var selfDefined=false,selfRequiredDefined=false,cellErrorInfo,cellData;if(comp.getMetaObj().required){comp.setRequired(comp.isNull());selfRequiredDefined=true;}if(expItem.content&&expItem.content.length>0){result=form.eval($.trim(expItem.content),{form:form},null);if(result){comp.setError(false,null);}else{comp.setError(true,expItem.errorMsg);}selfDefined=true;}cellErrorInfo=YIUI.SubDetailUtil.getBindingCellError(form,comp);cellData=YIUI.SubDetailUtil.getBindingCellData(form,comp);if(!selfDefined&&cellErrorInfo!=null){comp.setError(true,cellErrorInfo.errorMsg);}if(!selfRequiredDefined&&cellData!=null){comp.setRequired(cellData[3]);}if(!comp.isVisible()&&(comp.errorInfo.error||comp.isRequired())){if(!form.errorInfo.error){if(comp.isRequired()){form.setError(true,comp.key+"必填",comp.key);}else{form.setError(true,comp.errorInfo.msg,comp.key);}}}else{if(form.errorInfo.error&&form.errorInfo.errorSource!=null&&form.errorInfo.errorSource==comp.key){form.setError(false,null);}}if(needCheck&&comp.getMetaObj().bindingCellKey!=null){var grid=YIUI.SubDetailUtil.getBindingGrid(form,comp);var rowIndex=grid.getFocusRowIndex(),cellIndex=grid.getCellIndexByKey(comp.getMetaObj().bindingCellKey);if(rowIndex>-1&&cellIndex>-1){grid.modifyCellErrors(rowIndex,cellIndex,!comp.errorInfo.error,comp.errorInfo.msg);grid.setGridErrorCells(grid.errorInfoes.cells);grid.setCellRequired(rowIndex,cellIndex,comp.isRequired());}}}}};this.calcEmptyRow=function(grid,rowIndex){var items=form.dependency.checkRuleTree.items;var i,expItem,subExpItem,colInfoes,colIndex,result,len=items.length;for(i=0;i<len;i++){expItem=items[i];if(expItem.source===grid.key&&expItem.type===this.CheckRuleItemType.List){if(!expItem.items){continue;}for(var ind=0,elen=expItem.items.length;ind<elen;ind++){subExpItem=expItem.items[ind];if(!subExpItem.content||subExpItem.content.length==0){continue;}colInfoes=grid.getColInfoByKey(subExpItem.left);if(colInfoes!==null){for(var j=0,jlen=colInfoes.length;j<jlen;j++){colIndex=colInfoes[j].colIndex;result=form.eval(subExpItem.content,{form:form,rowIndex:rowIndex,colIndex:colIndex},null);grid.modifyCellErrors(rowIndex,colIndex,result,subExpItem.errorMsg);}}}}}impl_rowCountChanged.call(this,grid);grid.setGridErrorCells(grid.errorInfoes.cells);this.checkRow(grid,rowIndex);grid.setGridErrorRows(grid.errorInfoes.rows);};this.valueChanged=function(key){var formState=form.getOperationState();var enableOnly=(formState==YIUI.Form_OperationState.New||formState==YIUI.Form_OperationState.Edit)?false:formState==YIUI.Form_OperationState.Default;var comp=form.getComponent(key);if(comp.getMetaObj().required){comp.setRequired(comp.isNull());}var affectItems=form.dependency.checkRuleTree.affectItems;var item,expItems,expItem;for(var i=0,len=affectItems.length;i<len;i++){item=affectItems[i];if(item.key.toLowerCase()==key.toLowerCase()){expItems=item.expItems;for(var j=0,length=expItems.length;j<length;j++){expItem=expItems[j];this.checkComponent(expItem,enableOnly,false);}}}if(comp.getMetaObj().isSubDetail&&!enableOnly){var parentGrid=form.getComponent(comp.getMetaObj().parentGridKey);if(parentGrid){this.calcEmptyRow(parentGrid,parentGrid.getFocusRowIndex());}}this.checkGlobal();};this.cellValChanged=function(grid,rowIndex,colIndex,cellKey){var affectItems=form.dependency.checkRuleTree.affectItems;var item,expItems,expItem,subExpItem,result=false,colInfoes,colInfo;var dealSubDetailCompError=function(error,msg,isRequired){if(grid.getFocusRowIndex()==rowIndex){var cellSubDtlComps=form.getCellSubDtlComps(grid.key,cellKey);if(cellSubDtlComps!=null&&cellSubDtlComps.length>0){for(var csi=0,csLen=cellSubDtlComps.length;csi<csLen;csi++){var comp=cellSubDtlComps[csi];comp.setError(!error,msg);comp.setRequired(isRequired);}}}};for(var i=0,len=affectItems.length;i<len;i++){item=affectItems[i];if(item.key.toLowerCase()==cellKey.toLowerCase()){expItems=item.expItems;for(var j=0,length=expItems.length;j<length;j++){expItem=expItems[j];if(expItem.items==undefined){if(!expItem.content||expItem.content.length==0){continue;}colInfoes=grid.getFixRowInfoByCellKey(expItem.left);if(colInfoes==null){continue;}for(var m=0,mlen=colInfoes.length;m<mlen;m++){colInfo=colInfoes[m];result=form.eval($.trim(expItem.content),{form:form,rowIndex:colInfo.rowIndex,colIndex:colInfo.colIndex},null);grid.modifyCellErrors(colInfo.rowIndex,colInfo.colIndex,result,expItem.errorMsg);dealSubDetailCompError(result,expItem.errorMsg,colInfo.isRequired);}}else{for(var k=0,elen=expItem.items.length;k<elen;k++){subExpItem=expItem.items[k];if(!subExpItem.content||subExpItem.content.length==0){continue;}colInfoes=grid.getColInfoByKey(subExpItem.left);if(colInfoes==null){continue;}for(var n=0,nlen=colInfoes.length;n<nlen;n++){colInfo=colInfoes[n];result=form.eval($.trim(subExpItem.content),{form:form,rowIndex:rowIndex,colIndex:colInfo.colIndex},null);grid.modifyCellErrors(rowIndex,colInfo.colIndex,result,subExpItem.errorMsg);dealSubDetailCompError(result,expItem.errorMsg,colInfo.isRequired);}}}}}}grid.setGridErrorCells(grid.errorInfoes.cells);this.checkRow(grid,rowIndex);grid.setGridErrorRows(grid.errorInfoes.rows);this.checkGlobal();};this.checkSubDetail=function(gridKey){var formState=form.getOperationState();var enableOnly=(formState==YIUI.Form_OperationState.New||formState==YIUI.Form_OperationState.Edit)?false:formState==YIUI.Form_OperationState.Default;var items=form.dependency.checkRuleTree.items;var i,expItem,comp,len=items.length;for(i=0;i<len;i++){expItem=items[i];comp=form.getComponent(expItem.source);if(comp&&comp.getMetaObj().isSubDetail&&comp.getMetaObj().parentGridKey==gridKey){this.checkComponent(expItem,enableOnly,true);}}};};YIUI.UIDependencyProcess=function(form){this.form=form;this.calcAll=function(){};this.valueChanged=function(key){var relations=form.getRelations(),targetFields,targetField,targetComp,cellLocation,grid;if(relations==null){return;}for(var dependencyField in relations){if(dependencyField!=key){continue;}targetFields=relations[dependencyField];for(var i=0,len=targetFields.length;i<len;i++){targetField=targetFields[i];targetComp=this.form.getComponent(targetField);cellLocation=this.form.getCellLocation(targetField);if(targetComp!=null){targetComp.dependedValueChange(dependencyField);}else{if(cellLocation!=null){grid=this.form.getComponent(cellLocation.key);grid.dependedValueChange(targetField,dependencyField,null);}}}}};this.cellValChanged=function(grid,rowIndex,colIndex,cellKey){var relations=form.getRelations(),targetFields,targetField;if(relations==null){return;}for(var dependencyField in relations){if(dependencyField!=cellKey){continue;}targetFields=relations[dependencyField];for(var i=0,len=targetFields.length;i<len;i++){targetField=targetFields[i];grid.doPostCellValueChanged(rowIndex,dependencyField,targetField,null);}}};this.calcEmptyRow=function(grid,rowIndex){var gridRow=grid.getRowDataAt(rowIndex),metaRow=grid.metaRowInfo.rows[gridRow.metaRowIndex];for(var i=0,len=metaRow.cells.length;i<len;i++){var metaCell=metaRow.cells[i];if(metaCell.cellType==YIUI.CONTROLTYPE.DYNAMIC){}}};};})();(function(){YIUI.ViewDataMonitor=function(form){this.form=form;this.preFireCellValueChanged=function(grid,rowIndex,colIndex,cellKey){this.form.getUIProcess().doPreCellValueChanged(grid,rowIndex,colIndex,cellKey);};this.fireCellValueChanged=function(grid,rowIndex,colIndex,cellKey){var row=grid.dataModel.data[rowIndex],metaRow=grid.metaRowInfo.rows[row.metaRowIndex];this.form.getUIProcess().doCellValueChanged(grid,rowIndex,colIndex,cellKey);var valueChanged=metaRow.cells[colIndex].valueChanged;if(valueChanged!==undefined&&valueChanged.length>0){form.eval($.trim(valueChanged),{form:form,rowIndex:rowIndex},null);}};this.postFireCellValueChanged=function(grid,rowIndex,colIndex,cellKey){this.form.getUIProcess().doPostCellValueChanged(grid,rowIndex,colIndex,cellKey);};};})();(function(){YIUI.Paras=function(b){var a={map:{},mapType:{},put:function(c,d){this.map[c]=d;},get:function(c){return this.map[c];},getMap:function(){return this.map;},init:function(){if($.isEmptyObject(b)){return;}var d=b.items;for(var e=0,c=d.length;e<c;e++){var f=d[e];this.put(f.key,f.value);this.mapType[f.key]=f.type;}},toJSON:function(){var f={};if(!$.isEmptyObject(this.map)){var e=[];for(var c in this.map){var d=this.map[c];var g=this.mapType[c];if(!g||g==-1){if($.isNumeric(d)){g=YIUI.JavaDataType.USER_LONG;}else{if(d instanceof Decimal){g=YIUI.JavaDataType.USER_NUMERIC;d=d.toString();}else{if(typeof d=="boolean"){g=YIUI.JavaDataType.USER_BOOLEAN;}else{if(d instanceof Date){g=YIUI.JavaDataType.USER_DATETIME;d=d.getTime();}else{if(typeof d=="string"){g=YIUI.JavaDataType.USER_STRING;}}}}}}var h={key:c,value:d||null,type:g};e.push(h);}f.items=e;}return $.toJSON(f);}};a.init();return a;};})();(function(){YIUI.PPObject=function(b){var a={LONG:1,ARRAY:2,DATATABLE:3,type:-1,operatorID:-1,operatorList:[],complexOperatorTable:null,init:function(){if($.isNumeric(b)){this.type=this.LONG;this.operatorID=parseInt(b);}else{if(b instanceof Array){this.type=this.ARRAY;this.operatorList=b;}else{if(b instanceof DataDef.DataTable){this.type=this.DATATABLE;this.complexOperatorTable=b;}}}},toJSON:function(){var g={};g.Type=this.type;if(this.type==this.LONG){g.OperatorID=this.operatorID;}else{if(this.type==this.ARRAY){var f=[];for(var e=0,c=this.operatorList.length;e<c;e++){f.push(this.operatorList[e]);}g.OperatorList=f;}else{if(this.type==this.DATATABLE){var d=YIUI.DataUtil.toJSONDataTable(this.complexOperatorTable);g.ComplexOperatorTable=d;}}}return g;}};a.init();return a;};})();(function(){YIUI.PrintURLs={};YIUI.Print={print:function(a,d){var b=$("iframe[id='print_"+d+"']",document.body);if(b.length==0){b=$("<iframe src='"+a+"' style='display:none;'></iframe>").attr("id","print_"+d);b.appendTo($(document.body));}var c=b[0].contentWindow;if(!YIUI.PrintURLs[d]){YIUI.PrintURLs[d]=[];}YIUI.PrintURLs[d].push(a);c.print();},del:function(c){var b=YIUI.PrintURLs[c];if(b&&b.length>0){var a={};a.service="PrintService";a.cmd="DeletePDF";a.names=$.toJSON(b);Svr.Request.getSyncData(Svr.SvrMgr.ServletURL,a);b=[];}},delAll:function(){for(var a in YIUI.PrintURLs){YIUI.Print.del(a);}}};YIUI.PrintPreview=function(d){var c=$("<div/>");var b=d.url;var f=d.target;var e=d.formKey;var a={init:function(){if(!YIUI.PrintURLs[e]){YIUI.PrintURLs[e]=[];}YIUI.PrintURLs[e].push(b);if(f=="self"){c.modalDialog(null,{title:"预览",showClose:false,width:"80%",height:"80%"});c.dialogContent().attr("id","print-ct");var g=new PDFObject({url:b}).embed("print-ct");}else{window.open(b);}},setHeight:function(g){c.css("height",g);}};a.init();};})();YIUI.Form=YIUI.extend({init:function(g){this.operationState=g["operationState"]?g["operationState"]:YIUI.Form_OperationState.Default;this.initOperationState=g["initOperationState"]||YIUI.Form_OperationState.Default;this.type=g["type"];this.mergeOpt=g["mergeOpt"];this.options=g["options"];this.defTbr=g["defTbr"];this.OID=g["OID"]||-1;this.formID=g["formID"]||YIUI.Form_allocFormID();this.formKey=g["key"];this.formCaption=g["caption"];this.abbrCaption=g["abbrCaption"];this.target=g["target"];this.pFormID=g["parentID"];this.mainTableKey=g["mainTableKey"];var a=g["body"];var e=a["index_of_block"];var f=a["items"][e];var d=f["rootPanel"];d.topMargin=g["topMargin"];d.bottomMargin=g["bottomMargin"];d.leftMargin=g["leftMargin"];d.rightMargin=g["rightMargin"];d.abbrCaption=g["abbrCaption"];d.hAlign=g["hAlign"];d.height="100%";var c={formID:this.formID,rootPanelObj:d,defCtKey:g["defCtKey"]};this.formAdapt=new YIUI.FormAdapt(c);this.standalone=g["standalone"]||false;this.relations=g["relations"];this.macroMap=g["macroMap"];this.statusItems=g["statusItems"];this.paraGroups=g["paraGroups"];this.sysExpVals=g["sysExpVals"];this.filterMap=g["filterMap"]===undefined?null:new FilterMap(g["filterMap"]);this.dependency=g["dependency"];this.paras=new YIUI.Paras(g["parameters"]);this.callParas=new YIUI.Paras(g["callParameters"]);this.paraCollection=g["paraCollection"];this.checkRules=g["checkRules"];this.subDetailInfo=g["subDetailInfo"];this.mapGrids=g["mapGrids"];this.errorInfo={error:g["isError"],errorMsg:g["errorMsg"],errorSource:g["errorSource"]};this.dataObjectKey=g["dataObjectKey"]||null;this.refObjectKey=g["refObjectKey"]||null;this.refTableKey=g["refTableKey"]||null;this.postShow=g["postShow"]||null;this.parser=new View.Parser(this);this.uiProcess=new YIUI.UIProcess(this);this.viewDataMonitor=new YIUI.ViewDataMonitor(this);this.result=null;this.eventList={};this.timerTask=g["timerTask"];this.defaultUIStatusProxy=new YIUI.DefaultStatusProxy(this);var b=this.sysExpVals?this.sysExpVals[YIUI.BPMConstants.WORKITEM_INFO]:null;if(g["hostUIStatusProxy"]&&b!=null){this.hostUIStatusProxy=new YIUI.HostStatusProxy(b);}YIUI.FormStack.addForm(this);},getOID:function(){var a=this.getDocument();if(a){return a.oid;}else{return this.OID;}},setSysExpVals:function(a,b){if(!this.sysExpVals){this.sysExpVals={};}this.sysExpVals[a]=b;},getSysExpVals:function(a){if(this.sysExpVals){return this.sysExpVals[a];}return null;},isStandalone:function(){return this.standalone;},setResult:function(a){this.result=a;},getResult:function(){return this.result;},setAbbrCaption:function(a){this.abbrCaption=a;},getAbbrCaption:function(){return this.abbrCaption;},getFormAdapt:function(){return this.formAdapt;},addOpt:function(c,f,g){var b=f.items;for(var d=0,a=b.length;d<a;d++){var e=b[d];e.formID=f.formID;c.items.push(e);g[e.key]={barKey:this.defTbr,opt:e};}this.cFormID=f.formID;this.hasMerge=true;},delOpt:function(d,g,h){var c=g.items;var a=c.length;var b=d.items.length;d.items.splice(b-a,a);this.hasMerge=false;for(var e=0,a=c.length;e<a;e++){var f=c[e];delete h[f.key];}},getOptMap:function(){var f=this.formAdapt.getOptMap();var d=this.expOpts;if(this.mergeOpt){var b=this.defTbr;var a=this.getComponent(b);if(this.cFormID){var e=d.formID;var c=YIUI.FormStack.getForm(e);this.delOpt(a,d,f);if(!c){this.cFormID=null;}else{d.formID=c.formID;this.addOpt(a,d,f);}}else{if(!this.hasMerge){this.addOpt(a,d,f);}}}return f;},setError:function(a,b,c){this.errorInfo={error:a,errorMsg:b,errorSource:c};if(a){this.showErrMsg(b);}else{this.hideErrMsg();}},getCellSubDtlComps:function(a,d){var c=this.formAdapt.getCellSubDtlCompMap();if(c==null){return null;}var b=c[a];if(b==null){return null;}return b[d];},getGridInfoMap:function(){return this.formAdapt.getGridMap();},getGridInfoByTableKey:function(d){var e=this.getGridInfoMap(),c;for(var b=0,a=e.length;b<a;b++){c=e[b];if(c.tableKey==d){return c;}}},getGridInfoByKey:function(d){var e=this.getGridInfoMap(),c;for(var b=0,a=e.length;b<a;b++){c=e[b];if(c.key==d){return c;}}},getListView:function(a){return this.formAdapt.getListView(a);},diff:function(e){this.operationState=e["operationState"];var a=e["body"];var c=a["index_of_block"];var d=a["items"][c];var b=d["rootPanel"];this.sysExpVals=e.sysExpVals;this.getRoot().diff(b);this.setError(e["isError"],e["errorMsg"],e["errorSource"]);},getComponentList:function(){return this.formAdapt.getCompList();},getComponent:function(a){return this.formAdapt.getComp(a);},getPanel:function(a){return this.formAdapt.getPanel(a);},setFormKey:function(a){this.formKey=a;},getFormKey:function(){return this.formKey;},setFormCaption:function(a){this.formCaption=a;},getFormCaption:function(){return this.formCaption;},getDataObjectKey:function(){return this.dataObjectKey;},getRoot:function(){return this.formAdapt.getRoot();},setDocument:function(a){this.document=a;},getDocument:function(){return this.document;},showDocument:function(){var a=new YIUI.ShowData(this);return a.show();},setComponentValue:function(b,c,a){this.formAdapt.setCompValue(b,c,a);},setCellValByIndex:function(c,e,a,d,b){this.formAdapt.setCellValByIndex(c,e,a,d,b);},getCellValByIndex:function(b,c,a){return this.formAdapt.getCellValByIndex(b,c,a);},setCellValByKey:function(c,e,a,d,b){this.formAdapt.setCellValByKey(c,e,a,d,b);},getCellValByKey:function(b,c,a){return this.formAdapt.getCellValByKey(b,c,a);},getComponentValue:function(d,c){var b=this.formAdapt.getCellLocation(d);var a,f;if(b){if(c==null){return null;}a=this.formAdapt.getComp(b.key);if(a.type==YIUI.CONTROLTYPE.LISTVIEW){return a.getValue(c.rowIndex,b.column);}else{if(a.type==YIUI.CONTROLTYPE.GRID){return a.getValueAt(c.rowIndex,b.column);}}var e=this.getDocument().getByKey(b.tableKey);var g=c.rowIndex;e.setPos(g);return e.getByKey(b.columnKey);}else{a=this.formAdapt.getComp(d);if(a==undefined){YIUI.ViewException.throwException(YIUI.ViewException.NO_COMPONENT_KEY,d);}f=a.getValue();return f;}},getCellLocation:function(a){return this.formAdapt.getCellLocation(a);},setFilterMap:function(a){this.filterMap=a;},getFilterMap:function(){return this.filterMap;},getMainTableKey:function(){return this.mainTableKey;},setCondParas:function(a){this.conParas=a;},getCondParas:function(){return this.conParas==null?{}:this.conParas;},setInitOperationState:function(a){this.initOperationState=a;},getInitOperationState:function(){return this.initOperationState;},setOperationState:function(a){this.operationState=a;},getOperationState:function(){return this.operationState;},setOperationEnable:function(b,a){var c=this.getComponent(this.defTbr);if(!c){return;}c.setItemEnable(b,a);},resetUIStatus:function(a){this.uiProcess.resetUIStatus(a);},getUIProcess:function(){return this.uiProcess;},getViewDataMonitor:function(){return this.viewDataMonitor;},setDefContainer:function(a){this.formAdapt.setDefContainer(a);},getDefContainer:function(){return this.formAdapt.getDefContainer();},setContainer:function(a){var b=this;this.formAdapt.setContainer(a);b.initFirstFocus();},getContainer:function(){return this.formAdapt.getContainer();},newCxt:function(){return{form:this};},getRelations:function(){return this.relations;},setPara:function(a,b){this.paras.put(a,b);},getPara:function(a){return this.paras.get(a);},setCallPara:function(a,b){this.callParas.put(a,b);},getCallPara:function(a){return this.callParas.get(a);},getParaCollection:function(){return this.paraCollection;},getParas:function(){if(this.paras==undefined){this.paras={};}return this.paras;},getCallParas:function(){if(this.callParas==undefined){this.callParas={};}return this.callParas;},setErrDiv:function(b){this.errDiv=b;var a=this;window.setTimeout(function(){if(!a.isDestroyed){a.setError(a.errorInfo.error,a.errorInfo.errorMsg,a.errorInfo.errorSource);}},0);},showErrMsg:function(b){if(!this.errDiv||this.errDiv.css("display")=="block"){return;}$("label",this.errDiv).text(b);this.errDiv.show();var a=this.getRoot().getHeight()-this.errDiv.height();var c=this.getRoot().getWidth();this.getRoot().doLayout(c,a);},hideErrMsg:function(){if(!this.errDiv||this.errDiv.css("display")=="none"){return;}this.errDiv.hide();var a=this.getRoot().getHeight();var b=this.getRoot().getWidth();this.getRoot().doLayout(b,a);},reloadTable:function(d){var a=this.getDocument();var f=this.getFilterMap();f.setType(YIUI.DocumentType.DETAIL);var b=this.getCondParas();var c={};c.service="PureOpt";c.cmd="ReloadTable";c.tableKey=d;c.formKey=this.formKey;c.filterMap=$.toJSON(f);c.condParas=$.toJSON(b);var e=Svr.Request.getSyncData(Svr.SvrMgr.ServletURL,c);if(e){a.remove(d);a.add(d,e);}},initFirstFocus:function(){var h=this;var a=this.getContainer();var j;if(a){if(a[0]&&a[0].tagName){j=a;}else{j=a.container.el||a.container;}}else{j=this.getRoot().container.el;}var b=this.getTabCompList(),d=null;for(var c=0,e=b.length;c<e;c++){d=b[c];if(d==undefined||d==null){continue;}var f=$(d.el).parents(".ui-tabs-panel");var g=(f.length>0&&f[0].style.display!=="none")||(f.length==0);if(d.enable&&d.visible&&g){switch(d.type){case YIUI.CONTROLTYPE.GRID:d.initFirstFocus();break;default:d.focus();break;}break;}}},getParentForm:function(){return YIUI.FormStack.getForm(this.pFormID);},fireClose:function(){if(this.type!=YIUI.Form_Type.Entity){this.close();return true;}if(this.operationState==YIUI.Form_OperationState.Default||this.operationState==YIUI.Form_OperationState.Delete){this.close();return true;}var b={msg:"是否确定要关闭界面？",msgType:YIUI.Dialog_MsgType.YES_NO};var c=new YIUI.Control.Dialog(b);c.render();var a=this;c.regEvent(YIUI.Dialog_Btn.STR_YES,function(){a.close();});c.regEvent(YIUI.Dialog_Btn.STR_NO,function(){});},close:function(){var a=this.getEvent(YIUI.FormEvent.Close);if(a){a.doTask(this,null);}if(this.target==2){$("#"+this.formID).close();YIUI.FormStack.removeForm(this.formID);}else{this.getContainer().removeForm(this);}},eval:function(formula,context,callback){if(formula){return this.parser.eval(formula,context,callback);}return null;},eval2:function(d,c,b,a){if(d){return this.parser.eval2(d,c,b,a);}return null;},evalByTree:function(a,b,c){if(a!==null&&a!==undefined){return this.parser.evalByTree(a,b,c);}return null;},getSyntaxTree:function(a){if(a.length==0){return null;}else{return this.parser.getSyntaxTree(a);}},toJSON:function(){var b={};var a=this.formAdapt.toJSON();b.key=this.formKey;b.items=a;b.filterMap=this.getFilterMap();b.condParas=this.getCondParas();b.operationState=this.operationState;return $.toJSON(b);},destroy:function(){this.uiProcess=null;this.parser=null;this.document=null;this.dependency=null;this.isDestroyed=true;},regEvent:function(a,b){if(!this.eventList){this.eventList={};}this.eventList[a]=b;},getEvent:function(a){var b=null;if(this.eventList){b=this.eventList[a];}return b;},removeEvent:function(a){if(this.eventList){delete this.eventList[a];}},getTabCompList:function(){return this.tabCompList;},getFocusManager:function(){if(!this.focusManager){this.focusManager=new FocusPolicy(this);}return this.focusManager;},dealTabOrder:function(){this.tabCompList=[];var b;for(var d in this.getComponentList()){b=this.getComponentList()[d];b.setFocusManager(this.getFocusManager());if(b.getMetaObj().crFocus&&$.isNumeric(b.getMetaObj().tabOrder)&&b.getMetaObj().tabOrder!=-1){this.tabCompList.push(b);}}this.tabCompList.sort(function(g,f){return g.getMetaObj().tabOrder-f.getMetaObj().tabOrder;});var e=[];this.getRoot().getNoTabOrderComps(e);this.tabCompList=this.tabCompList.concat(e);for(var c=0,a=this.tabCompList.length;c<a;c++){b=this.tabCompList[c];if(b==undefined){continue;}b.setTabIndex(c);}}});var formID=1;YIUI.Form_allocFormID=function(){return formID++;};YIUI.MetaForm=function(a){};var FocusPolicy=FocusPolicy||{};(function(){FocusPolicy=function(b){var a={form:b,requestNextFocus:function(c){if(c==undefined||c==null){a.focusNextNode(0,a.form.getTabCompList().length);}else{a.doFocusNext(c.getTabIndex());}},doFocusNext:function(e){var d=e+1,c=a.form.getTabCompList().length;if(d<c){a.focusNextNode(d,c);}else{a.focusNextNode(0,c);}},focusNextNode:function(g,d){var f=false,e=g;var c=function(i){var h=a.form.getTabCompList()[i];var l=$(h.el).parents(".ui-tabs-panel");var k=(l.length>0&&l[0].style.display!=="none")||(l.length==0);if(h.enable&&h.visible&&k){if(h.type==YIUI.CONTROLTYPE.GRID){h.initFirstFocus();return true;}else{var j=h.el[0];if(j.getBoundingClientRect().top<document.documentElement.clientHeight&&j.getBoundingClientRect().left<document.documentElement.clientWidth){h.focus();return true;}}}return false;};while(e<d&&!f){f=c(e);e++;}if(!f){e=0;while(e<g&&!f){f=c(e);e++;}}}};return a;};})();(function(){YIUI.FormAdapt=function(b){var a={formID:-1,compList:{},cellMap:{},gridMap:[],cellSubDtlCompMap:{},LVMap:[],panelMap:[],optMap:{},rootPanel:null,defCtKey:null,init:function(c){if(!c){return;}this.rootPanel=YIUI.create(c);this.loadComp(this.compList,this.rootPanel);},loadComp:function(h,d){d.ofFormID=this.formID;d.id=d.ofFormID+"_"+d.getMetaObj().key;if(d.type==YIUI.CONTROLTYPE.LISTVIEW||d.type==YIUI.CONTROLTYPE.GRID){this.loadCellMap(this.cellMap,d);}if(d.items&&(d instanceof YIUI.Panel)){this.panelMap[d.getMetaObj().key]=d;for(var e=0;e<d.items.length;e++){this.loadComp(h,d.items[e]);}}else{if(d.type==YIUI.CONTROLTYPE.TOOLBAR){this.loadOptMap(this.optMap,d);}}h[d.getMetaObj().key]=d;var g=d.getMetaObj().bindingCellKey;var c=d.getMetaObj().parentGridKey;if(g!=null&&c!=null){var f=this.cellSubDtlCompMap[c];if(f==null){f={};this.cellSubDtlCompMap[c]=f;}if(f[g]==null){f[g]=[];}f[g].push(d);}},loadOptMap:function(l,e){for(var g=0,h,c=e.items.length;g<c;g++){h=e.items[g];l[h.key]={barKey:e.getMetaObj().key,opt:h};if(h.items){for(var f=0,k,d=h.items.length;f<d;f++){k=h.items[f];l[k.key]={barKey:e.getMetaObj().key,opt:k};}}}},loadCellMap:function(n,e){var k,l,j,r;if(e.type==YIUI.CONTROLTYPE.LISTVIEW){for(k=0,l=e.columnInfo.length;k<l;k++){var h=e.columnInfo[k];h.tableKey=e.getMetaObj().tableKey;r={};r.tableKey=e.getMetaObj().tableKey;r.key=e.getMetaObj().key;r.column=k;r.columnKey=h.columnKey;r.row=-1;this.addCellLocation(h.key,r);}this.LVMap.push(e);}else{if(e.type==YIUI.CONTROLTYPE.GRID){var c=e.dataModel.colModel.cells;var f={key:e.getMetaObj().key,tableKey:e.getMetaObj().tableKey};this.gridMap.push(f);for(var q in c){var o=c[q];if(o==undefined||o==null||o.length==0){continue;}r=this.getCellLocation(o.key);if(!r){r={};this.addCellLocation(o.key,r);}r.key=e.getMetaObj().key;r.column=o.colIndex;r.row=-1;r.tableKey=e.getMetaObj().tableKey;r.columnKey=o.columnKey;for(var g=0,d=e.metaRowInfo.rows.length;g<d;g++){var p=e.metaRowInfo.rows[g];if(p.cellKeys.indexOf(o.key)!=-1&&p.rowType!="Detail"){r.row=g;break;}}}}}},addCellLocation:function(d,c){this.cellMap[d]=c;},getOptMap:function(){return this.optMap;},getListView:function(d){if($.isNumeric(d)){var e=YIUI.TypeConvertor.toInt(d);return this.LVMap[e];}else{for(var f=0,c=this.LVMap.length;f<c;f++){var g=this.LVMap[f];if(g.getMetaObj().tableKey==d){return g;}}}},getPanel:function(c){return this.panelMap[c];},getCellSubDtlCompMap:function(){return this.cellSubDtlCompMap;},getGridMap:function(){return this.gridMap;},getCompList:function(){return this.compList;},getComp:function(c){return this.compList[c];},getRoot:function(){return this.rootPanel;},setRootPanel:function(c){this.rootPanel=c;},setCompValue:function(d,e,c){if(this.getComp(d)==undefined){YIUI.ViewException.throwException(YIUI.ViewException.NO_COMPONENT_KEY,d);}this.getComp(d).setValue(e,true,c);},setCellValByIndex:function(f,i,d,h,e){var c=this.getComp(f);var g=c==undefined?-1:c.type;switch(g){case YIUI.CONTROLTYPE.LISTVIEW:c.setValByIndex(i,d,h,true,e);break;case YIUI.CONTROLTYPE.GRID:if(c.getRowDataAt(i).isDetail){c.setValueAt(i,d,h,true,e,true);}break;default:YIUI.ViewException.throwException(YIUI.ViewException.NO_CELL_CANNOT_SET_VALUE);}},getCellValByIndex:function(e,h,d){var c=this.getComp(e);var f=c==undefined?-1:c.type,g;switch(f){case YIUI.CONTROLTYPE.LISTVIEW:g=c.getValue(h,d);break;case YIUI.CONTROLTYPE.GRID:g=c.getValueAt(h,d);break;default:YIUI.ViewException.throwException(YIUI.ViewException.CANNNOT_GET_NO_CELL_VALUE);}return g;},setCellValByKey:function(f,i,d,h,e){var c=this.getComp(f);var g=c==undefined?-1:c.type;switch(g){case YIUI.CONTROLTYPE.LISTVIEW:c.setValByKey(i,d,h,true,e);break;case YIUI.CONTROLTYPE.GRID:if(i!=-1&&c.getRowDataAt(i).isDetail){c.setValueByKey(i,d,h,true,e);}break;default:YIUI.ViewException.throwException(YIUI.ViewException.NO_CELL_CANNOT_SET_VALUE);}},getCellValByKey:function(e,h,d){var c=this.getComp(e);var f=c==undefined?-1:c.type,g;switch(f){case YIUI.CONTROLTYPE.LISTVIEW:g=c.getValByKey(h,d);break;case YIUI.CONTROLTYPE.GRID:g=c.getValueByKey(h,d);break;default:YIUI.ViewException.throwException(YIUI.ViewException.CANNNOT_GET_NO_CELL_VALUE);}return g;},getCellLocation:function(c){return this.cellMap[c];},setDefContainer:function(c){this.defContainer=c;},getDefContainer:function(){if(this.defCtKey){return this.getComp(this.defCtKey);}return null;},setContainer:function(c){this.container=c;},getContainer:function(){return this.container;},toJSON:function(){var c=[],d=this.rootPanel;this.compToJson(d,c);return c;},compToJson:function(d,j){var f=d.items,h,e;for(var g=0,c=f.length;g<c;g++){h=f[g];if(h instanceof YIUI.Panel){this.compToJson(h,j);}else{if(!(h.type==YIUI.CONTROLTYPE.LISTVIEW||h.type==YIUI.CONTROLTYPE.GRID)){e={};e.key=h.getMetaObj().key;if(h.type==YIUI.CONTROLTYPE.DATEPICKER){if(h.getValue()){e.value=h.getValue().getTime();}else{e.value=null;}}else{e.value=h.getValue();}e.caption=h.caption;j.push(e);}}}}};a=$.extend(a,b);a.init(a.rootPanelObj);return a;};})();YIUI.FormBuilder=(function(){var a={build:function(q,k,e,d,b){var o=q.form,c=new YIUI.Form(o),l=q.document,p,j=q.dictCaption;c.dealTabOrder();if(l){p=YIUI.DataUtil.fromJSONDoc(l);c.setDocument(p);}if(j){c.dictCaption=j;}c.target=k||c.target;c.pFormID=e||c.parentID;if(k==YIUI.FormTarget.MODAL||c.target==YIUI.FormTarget.MODAL){var i=o.popHeight||"60%";var h=o.popWidth||"40%";var g=c.formID;var n=$("<div id="+g+"></div>");var f={title:c.formCaption,showClose:false,width:h,height:i};var m=c.getRoot();f.resizeCallback=function(){var r=n.dialogContent();if(m.hasLayout){m.doLayout(r.width(),r.height());}else{m.setWidth(r.width());m.setHeight(r.height());}};n.modalDialog(null,f);c.getRoot().render(n.dialogContent());}return c;},diff:function(d,f){var c=f.form,b=f.document,e;if(b){e=YIUI.DataUtil.fromJSONDoc(b);d.setDocument(e);}d.diff(c);return d;}};return a;})();YIUI.FormStack=(function(){var a={addForm:function(b){if(typeof this.formList=="undefined"){this.formList=new Array();}this.formList.push(b);},getForm:function(c){for(var b=0;b<this.formList.length;b++){if(c==this.formList[b].formID){return this.formList[b];}}return null;},removeForm:function(c){for(var b=0;b<this.formList.length;b++){if(c==this.formList[b].formID){this.formList[b].destroy();this.formList.splice(b,1);}}},removeAll:function(){if(!this.formList){return;}for(var b=0;b<this.formList.length;b++){this.formList[b].destroy();}this.formList=[];}};return a;})();(function(){YIUI.FileChooser=function(c,b){var a={init:function(){this.$input=$("<input type='file' name='file' data-url='upload' class='opt upbtn' />").appendTo($(document.body)).hide();},upload:function(d,e){this.options=d||{};this.callback=e;this.$input.click();},install:function(){var d=this;this.$input.change(function(){var e=$.extend({cmd:b,service:c,mode:1},d.options);$.ajaxFileUpload({url:Svr.SvrMgr.AttachURL,secureuri:false,fileElement:d.$input,data:e,type:"post",success:function(h,f,k){h=JSON.parse(h);if(h.success==false){var g=h.error;var j=g.error_info;var i=g.error_code;if(i!=-1){i=(parseInt(i,10)>>>0).toString(16).toLocaleUpperCase();j=i+"<br/>"+j;}$.error(j);}else{if($.isFunction(d.callback)){d.callback(h);}}},error:function(g,f,h){alert(h);}});});}};a.init();a.install();return a;};})();
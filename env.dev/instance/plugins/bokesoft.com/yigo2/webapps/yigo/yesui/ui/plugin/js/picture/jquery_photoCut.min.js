(function($){$.fn.photoCut=function(opts){var defaults={ImgType:["gif","jpeg","jpg","bmp","png"],headWidth:150,headHeight:150,width:400,height:300,isCut:true,maxSize:10,proportion:0.1,backfile:null};var options=$.extend(defaults,opts);var _this=$(this);var _self=$(this)[0];var style="";var photo={};photo.dom={};photo.src=null;photo.widthInitial=null;photo.heightInitial=null;photo.widthShow=null;photo.heightShow=null;photo.size=1;photo.controlWidth=null;photo.sliderWidth=null;photo.choiceCentralX=(options.width-options.headWidth)/2;photo.choiceCentralY=(options.height-options.headHeight)/2;photo.timer=null;photo.backX1=null;photo.backY1=null;photo.backWidth=null;photo.backHeight=null;photo.minLeft=null;photo.minsize=null;if(options.headWidth>options.width||options.headHeight+50>options.height){alert("显示框的宽不能小于头像框，高至少大于头像框高50px");return}var mask='<div id="mask"></div>';var photoMain='<div id="photo_photoMain">';photoMain+='<div id="photo_showBox">';photoMain+='<div id="photo_imgBox">';photoMain+='<img id="photo_ImgPr">';photoMain+="</div>";photoMain+="</div>";photoMain+='<div id="photo_controlBox">';photoMain+='<div id="photo_btn1">-</div>';photoMain+='<div id="photo_control">';photoMain+='<div id="photo_slider"></div>';photoMain+="</div>";photoMain+='<div id="photo_btn2">+</div>';photoMain+="</div>";photoMain+='<div id="photo_imgBox1">';photoMain+='<div id="photo_posBox">';photoMain+='<div id="photo_imgsmallBox">';photoMain+='<img id="photo_ImgPr2">';photoMain+="</div>";photoMain+="</div>";photoMain+="</div>";photoMain+="</div>";$("body").append(photoMain,mask);if(options.isCut==true){var photoChoiceBox='<div id="photo_choiceBox">';photoChoiceBox+='<div id="photo_choiceCentral">';photoChoiceBox+='<div class="photo_lineTop"></div>';photoChoiceBox+='<div class="photo_lineBottom"></div>';photoChoiceBox+='<div class="photo_lineLeft"></div>';photoChoiceBox+='<div class="photo_lineRight"></div>';photoChoiceBox+="</div>";photoChoiceBox+='<div id="photo_choiceLeft"></div>';photoChoiceBox+='<div id="photo_choiceRight"></div>';photoChoiceBox+='<div id="photo_choiceTop"></div>';photoChoiceBox+='<div id="photo_choiceBottom"></div>';photoChoiceBox+="</div>";$("#photo_showBox").append(photoChoiceBox);$("#photo_choiceBox").width(options.width).height(options.height);$("#photo_choiceCentral").css({width:options.headWidth,height:options.headHeight,left:photo.choiceCentralX,top:photo.choiceCentralY});$("#photo_choiceLeft").css({width:(options.width-options.headWidth)/2,height:options.height,left:0,top:0});$("#photo_choiceRight").css({width:(options.width-options.headWidth)/2,height:options.height,right:0,top:0});$("#photo_choiceTop").css({width:options.headWidth,height:(options.height-options.headHeight)/2,left:(options.width-options.headWidth)/2,top:0});$("#photo_choiceBottom").css({width:options.headWidth,height:(options.height-options.headHeight)/2,left:(options.width-options.headWidth)/2,bottom:0});$(".photo_lineTop,.photo_lineBottom").width(options.headWidth);$(".photo_lineLeft,.photo_lineRight").height(options.headHeight)}photo.dom.showBox=$("#photo_showBox");photo.dom.imgBox1=$("#photo_imgBox1");photo.dom.control=$("#photo_control");photo.dom.slider=$("#photo_slider");photo.dom.imgBox=$("#photo_imgBox");photo.dom.imgsmallBox=$("#photo_imgsmallBox");photo.dom.ImgPr=$("#photo_ImgPr");photo.dom.ImgPr2=$("#photo_ImgPr2");photo.dom.showBox.width(options.width).height(options.height);photo.dom.imgBox1.width(options.headWidth).height(options.headHeight);$("#photo_posBox").css({width:options.width,height:options.height,marginTop:-photo.choiceCentralY,marginLeft:-photo.choiceCentralX});$("#photo_photoMain").css({width:options.width+options.headWidth+50,height:options.height,left:($(window).width()-options.width-options.headWidth)/2,top:($(window).height()-options.height)/2});$("#photo_controlBox").css({width:options.headWidth,top:options.headHeight+50});photo.dom.control.css({width:options.headWidth-50});photo.controlWidth=photo.dom.control.width();photo.sliderWidth=photo.dom.slider.width();function getObjectURL(file){var url=null;if(window.createObjectURL!=undefined){url=window.createObjectURL(file)}else{if(window.URL!=undefined){url=window.URL.createObjectURL(file)}else{if(window.webkitURL!=undefined){url=window.webkitURL.createObjectURL(file)}}}return url}if(_self.value){if(!RegExp(".("+options.ImgType.join("|")+")$","i").test(_self.value.toLowerCase())){alert("选择文件错误,图片类型必须是"+options.ImgType.join("，")+"中的一种");_self.value="";return false}if(navigator.userAgent.indexOf("MSIE")>-1){try{$("#photo_ImgPr,#photo_ImgPr2").attr("src",getObjectURL(_self.files[0]))}catch(e){var src="";_self.select();if(top!=self){window.parent.document.body.focus()}else{_this.blur()}src=document.selection.createRange().text;photo.src=_this.val();document.selection.empty();$("#photo_ImgPr,#photo_ImgPr2").hide();style="ie";function progidFn(obj){obj.style.filter='progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod="image" , src ="'+photo.src+'" )';obj.style.width="100%";obj.style.height="100%"}progidFn($("#photo_imgBox")[0]);progidFn($("#photo_imgsmallBox")[0])}}else{$("#photo_ImgPr,#photo_ImgPr2").attr("src",getObjectURL(_self.files[0]))}showPhoto()}function showCalculation(obj){var proportion=photo.widthInitial/photo.heightInitial;if(obj.width()>=options.width||obj.height()>=options.height){if(proportion>=1){if(options.width/proportion>options.height){if(options.height*proportion<options.headWidth){obj.width(options.headWidth).height(options.headWidth/proportion)}else{obj.width(options.height*proportion).height(options.height)}}else{if(options.width/proportion<options.headHeight){obj.width(options.headHeight*proportion).height(options.headHeight)}else{obj.width(options.width).height(options.width/proportion)}}}else{if(options.height*proportion>options.width){obj.width(options.width).height(options.width/proportion)}else{if(options.height*proportion<options.headWidth){obj.height(options.headWidth/proportion).width(options.headWidth)}else{obj.height(options.height).width(options.height*proportion)}}}}else{if(style=="ie"){obj.height(photo.heightInitial).width(photo.widthInitial)}}if(obj.width()<=options.headWidth||obj.height()<=options.headHeight){if(proportion>=1){obj.width(options.headHeight*proportion).height(options.headHeight)}else{obj.width(options.headWidth).height(options.headWidth/proportion)}}}function showBox(obj){photo.dom.imgBox.css({visibility:"visible"});photo.widthInitial=obj.width();photo.heightInitial=obj.height();showCalculation(obj);photo.widthShow=obj.width();photo.heightShow=obj.height();photo.size=1;photo.dom.slider.css({left:photo.size*(photo.controlWidth-photo.sliderWidth)/options.maxSize});photo.minsize=photo.widthShow<=photo.heightShow?options.headWidth/photo.widthShow:options.headHeight/photo.heightShow;photo.minLeft=photo.minsize*(photo.size*(photo.controlWidth-photo.sliderWidth)/options.maxSize)}function imgCenter(obj){obj.css({left:(options.width-obj.width())/2,top:(options.height-obj.height())/2})}function showPhoto(){photo.dom.imgsmallBox.css({visibility:"visible"});$("#mask").show();$("#photo_photoMain").fadeIn();if(style=="ie"){setTimeout(function(){photo.widthInitial=photo.dom.imgBox.width();photo.heightInitial=photo.dom.imgBox.height();$("#photo_imgBox,#photo_imgsmallBox").css({width:photo.widthInitial,height:photo.heightInitial,filter:"progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod=scale)"});photo.dom.imgBox[0].filters.item("DXImageTransform.Microsoft.AlphaImageLoader").src=photo.src;photo.dom.imgsmallBox[0].filters.item("DXImageTransform.Microsoft.AlphaImageLoader").src=photo.src;showBox(photo.dom.imgBox);imgCenter(photo.dom.imgBox);showCalculation(photo.dom.imgsmallBox);imgCenter(photo.dom.imgsmallBox)},1000)}else{photo.dom.ImgPr.load(function(){photo.dom.ImgPr.removeAttr("style");showBox(photo.dom.ImgPr);imgCenter(photo.dom.imgBox)});photo.dom.ImgPr2.load(function(){photo.dom.ImgPr2.removeAttr("style");photo.dom.imgsmallBox.css({visibility:"visible"});showCalculation(photo.dom.ImgPr2);imgCenter(photo.dom.imgsmallBox)})}}function imgChange(){var oWidth=photo.widthShow*photo.size;var oHeight=photo.heightShow*photo.size;if(style=="ie"){if((parseFloat(photo.dom.imgBox.css("left"))+photo.widthShow*photo.size)<(photo.choiceCentralX+options.headWidth)){var l=photo.choiceCentralX+options.headWidth-photo.widthShow*photo.size;photo.dom.imgBox.css({left:l});photo.dom.imgsmallBox.css({left:l})}if((parseFloat(photo.dom.imgBox.css("top"))+photo.heightShow*photo.size)<(photo.choiceCentralY+options.headHeight)){var t=photo.choiceCentralY+options.headHeight-photo.heightShow*photo.size;photo.dom.imgBox.css({top:t});photo.dom.imgsmallBox.css({top:t})}photo.dom.imgBox.width(oWidth).height(oHeight);photo.dom.imgsmallBox.width(oWidth).height(oHeight)}else{if((parseFloat(photo.dom.imgBox.css("left"))+photo.widthShow*photo.size)<(photo.choiceCentralX+options.headWidth)){var l1=photo.choiceCentralX+options.headWidth-photo.widthShow*photo.size;photo.dom.imgBox.css({left:l1});photo.dom.imgsmallBox.css({left:l1})}if((parseFloat(photo.dom.imgBox.css("top"))+photo.heightShow*photo.size)<(photo.choiceCentralY+options.headHeight)){var t1=photo.choiceCentralY+options.headHeight-photo.heightShow*photo.size;photo.dom.imgBox.css({top:t1});photo.dom.imgsmallBox.css({top:t1})}photo.dom.ImgPr.width(oWidth).height(oHeight);photo.dom.ImgPr2.width(oWidth).height(oHeight)}}function photoAmplification(){photo.size+=options.proportion;if(photo.size>=options.maxSize){photo.size=options.maxSize}imgChange();photo.dom.slider.css({left:photo.size*(photo.controlWidth-photo.sliderWidth)/options.maxSize})}function photoNarrow(){photo.size-=options.proportion;if(photo.size<=photo.minsize){photo.size=photo.minsize}imgChange();photo.dom.slider.css({left:photo.size*(photo.controlWidth-photo.sliderWidth)/options.maxSize})}function fnData(obj){photo.backX1=(photo.choiceCentralX-parseInt(photo.dom.imgBox.css("left")))*(photo.widthInitial/obj.width());photo.backY1=(photo.choiceCentralY-parseInt(photo.dom.imgBox.css("top")))*(photo.heightInitial/obj.height());photo.backWidth=options.headWidth*photo.widthInitial/obj.width();photo.backHeight=options.headHeight*photo.heightInitial/obj.height()}function backstageData(){if(style=="ie"){fnData(photo.dom.imgBox)}else{fnData(photo.dom.ImgPr)}}$("#photo_btn1").mousedown(function(){clearInterval(photo.timer);photo.timer=setInterval(function(){photoNarrow();backstageData()},50);$(document).mouseup(function(){clearInterval(photo.timer)})});$("#photo_btn2").mousedown(function(){clearInterval(photo.timer);photo.timer=setInterval(function(){photoAmplification();backstageData()},50);$(document).mouseup(function(){clearInterval(photo.timer)})});photo.dom.slider.mousedown(function(e){var n,m;var w=photo.controlWidth-photo.sliderWidth;n=e.pageX-photo.dom.slider.offset().left;m=photo.dom.control.offset().left;photo.dom.slider[0].setCapture&&photo.dom.slider[0].setCapture();$(document).bind("mousemove",sliderMove).bind("mouseup",sliderUp);function sliderMove(e){var x=e.pageX-n-m;if(x<=photo.minLeft){x=photo.minLeft}else{if(x>=w){x=w}}photo.dom.slider.css({left:x});photo.size=x/(w)*options.maxSize;imgChange()}function sliderUp(){$(document).unbind("mousemove",sliderMove).unbind("mouseup",sliderUp);photo.dom.slider[0].releaseCapture&&photo.dom.slider[0].releaseCapture();backstageData()}return false});mousescroll();function mousescroll(){if(photo.dom.showBox[0].addEventListener){photo.dom.showBox[0].addEventListener("DOMMouseScroll",fn,false)}photo.dom.showBox[0].onmousewheel=fn;function fn(e){var ev=e||event,dis;if(ev.wheelDelta){dis=ev.wheelDelta>0?"up":"down"}else{dis=ev.detail>0?"down":"up"}if(dis==="up"){photoAmplification()}else{if(dis==="down"){photoNarrow()}}backstageData();if(ev.preventDefault){ev.preventDefault()}return false}}photo.dom.showBox.mousedown(function(e){var x=e.pageX;var y=e.pageY;photo.dom.showBox[0].setCapture&&photo.dom.showBox[0].setCapture();function photoMove(e){var oLeft=parseInt(photo.dom.imgBox.css("left"))+e.pageX-x;var oTop=parseInt(photo.dom.imgBox.css("top"))+e.pageY-y;var oRighr=photo.choiceCentralX+options.headWidth-photo.dom.imgBox.width();var oBottom=photo.choiceCentralY+options.headHeight-photo.dom.imgBox.height();if(oLeft>photo.choiceCentralX){oLeft=photo.choiceCentralX}if(oLeft<oRighr){oLeft=oRighr}if(oTop>photo.choiceCentralY){oTop=photo.choiceCentralY}if(oTop<oBottom){oTop=oBottom}photo.dom.imgBox.css({left:oLeft,top:oTop});photo.dom.imgsmallBox.css({left:oLeft,top:oTop});x=e.pageX;y=e.pageY}function photoUp(){backstageData();$(document).unbind("mousemove",photoMove).unbind("mouseup",photoUp);photo.dom.showBox[0].releaseCapture&&photo.dom.showBox[0].releaseCapture()}$(document).bind("mousemove",photoMove).bind("mouseup",photoUp);return false});photo.dom.showBox.dblclick(function(){var paras={needCut:true,imgType:options.type,x:photo.backX1,y:photo.backY1,newWidth:photo.backWidth,newHeight:photo.backHeight,width:photo.widthInitial,height:photo.heightInitial};options.callback(paras);$("#mask,#photo_photoMain").remove();resetFile();return false});function resetFile(){if(style=="ie"){with(_self.parentNode.insertBefore(document.createElement("form"),_self)){appendChild(_self);reset();removeNode(false)}}else{_this.val("")}}$("#mask").click(function(){$("#photo_photoMain,#mask").remove();resetFile()});$(window).resize(function(){$("#photo_photoMain").css({left:($(window).width()-options.width-options.headWidth)/2,top:($(window).height()-options.height)/2})});return this}})(jQuery);
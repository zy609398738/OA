{
  "response": [
    {
      "text": "记录更新本地银行付款单中间表与核销表接口日志",
      "description": "记录更新本地银行付款单中间表与核销表接口日志",
      "scriptContent": "String expMsg = \"\";\nMap rsmap = new HashMap();\nif (message.getExceptionPayload() != null)\n{\n    message.setOutboundProperty(\"http.status\", 200);\n    expMsg = message.getExceptionPayload().getRootException().getMessage();\n    if (expMsg.length() > 3500)\n    {\n        expMsg = expMsg.substring(0, 3000);\n    }\n    message.setExceptionPayload(null);\n    rsmap.put(\"code\", \"e\");\n    rsmap.put(\"msg\", \"更新失败！\");\n}\nelse\n{\n    rsmap.put(\"code\", \"s\");\n    rsmap.put(\"msg\", \"更新成功！\");\n    rsmap.put(\"data\", payload);\n}\nMap logmap = message.getInboundProperty(\"logmap\");\nObject[] o = new Object[10];\no[0] = logmap.get(\"flow\");\no[1] = logmap.get(\"node\");\no[2] = logmap.get(\"billkey\");\no[3] = logmap.get(\"oid\");\no[4] = logmap.get(\"begintime\");\no[5] = new java.text.SimpleDateFormat(\"yyyyMMdd HH:mm:ss.SSS\").format(new java.sql.Timestamp(java.lang.System.currentTimeMillis()));\no[6] = \"\";\no[7] = \"\";\no[8] = expMsg;\no[9] = \"BPM_Update_BankPayment_Amount\";\ndbop.saveOrUpdate(\"insert into TRINA_SL_INTERFACE_LOG(id,flow,node,billkey,oid,starttime,endtime,request_data,response_data,EXCEPTION,interface_type)values(Trina_SL_Interface_Log_ID_SEQ.Nextval,?,?,?,?,?,?,?,?,?,?)\", o, false);\nreturn com.bokesoft.dee.mule.util.json.JSONUtil.toJson(rsmap);",
      "smallType": "GroovyScriptWithDS",
      "className": "com.bokesoft.exchange.transformer.ScriptWithDSTransformer",
      "enable": "true",
      "parentId": "8aab8dfa5f50f282015f515480ff0022",
      "bigType": "transformer_au",
      "simpleMpLog": "false",
      "ds": "2c9081d05be7e572015be80fcb64000f",
      "isRef": "false",
      "id": "8aaae0fb5f52393c015f527070080032"
    }
  ],
  "normal": [
    {
      "text": "更新本地银行付款单中间表核销表入口",
      "description": "更新本地银行付款单中间表核销表入口",
      "address": "vm://BPM_Update_BankPayment_Amount",
      "exchange_pattern": "request-response",
      "smallType": "VM",
      "className": "",
      "enable": "true",
      "parentId": "8aab8dfa5f50f282015f515480ff0022",
      "bigType": "inbound",
      "simpleMpLog": "false",
      "encoding": "UTF-8",
      "isRef": "false",
      "id": "8aab8dfa5f50f282015f51561c220027"
    },
    {
      "text": "启动JDBC事务",
      "description": "启动数据库事务",
      "smallType": "StartTxTransformer",
      "className": "com.bokesoft.dee.transport.transaction.StartTxTransformer",
      "enable": "true",
      "parentId": "8aab8dfa5f50f282015f515480ff0022",
      "bigType": "GGPZTransformer",
      "isRef": "true",
      "id": "8aaae0fb5f52393c015f52669cc10029"
    },
    {
      "text": "记录更新本地银行付款单中间表核销表的开始时间",
      "description": "记录更新本地银行付款单中间表核销表的开始时间",
      "scriptContent": "String begintime = new java.text.SimpleDateFormat(\"yyyyMMdd HH:mm:ss.SSS\").format(new java.sql.Timestamp(java.lang.System.currentTimeMillis()));\nMap logmap = new HashMap();\nlogmap.put(\"begintime\", begintime);\nlogmap.put(\"flow\", payload.get(\"flow\"));\nlogmap.put(\"node\", payload.get(\"node\"));\nlogmap.put(\"oid\", payload.get(\"oid\"));\nlogmap.put(\"billkey\", payload.get(\"billkey\"));\nlogmap.put(\"request_data\", payload.get(\"json\"));\nmessage.setInboundProperty(\"logmap\", logmap);\ncom.bokesoft.InterfaceOperator.checkTransaction(dbop, \"BPM_Update_BankPayment_Amount\");\nreturn payload;",
      "className": "com.bokesoft.exchange.transformer.ScriptWithDSTransformer",
      "smallType": "GroovyScriptWithDS",
      "enable": "true",
      "parentId": "8aab8dfa5f50f282015f515480ff0022",
      "bigType": "transformer_au",
      "simpleMpLog": "false",
      "ds": "2c9081d05be7e572015be80fcb64000f",
      "isRef": "false",
      "id": "8aaae0fb5f52393c015f526db2240030"
    },
    {
      "text": "本地银行付款单中间表查询非期初导入的发票信息",
      "description": "本地银行付款单中间表查询非期初导入的发票信息",
      "scriptContent": "List < Map > data = dbop.select(\" select invoice_id,sum(amount) as a_amount,sum(invoice_amount) as a_invoice_amount from bank_payment_tmp_mid  where item_type not like '%期初导入%' group by invoice_id\", message);\nreturn data;",
      "className": "com.bokesoft.exchange.transformer.ScriptWithDSTransformer",
      "smallType": "GroovyScriptWithDS",
      "enable": "true",
      "parentId": "8aab8dfa5f50f282015f515480ff0022",
      "bigType": "transformer_au",
      "simpleMpLog": "false",
      "ds": "2c9081d05be7e572015be80fcb64000f",
      "isRef": "false",
      "id": "8aaae0fb5f52393c015f523cf3b80018"
    },
    {
      "text": "根据本地查询结果筛选ERP核销信息并合并数据",
      "description": "根据本地查询结果筛选ERP核销信息并合并数据",
      "scriptContent": "Map m = new HashMap();\nm = com.bokesoft.GetSqlStr.sqlinconnect(payload);\nString s = m.get(\"sql\");\nObject[] o = m.get(\"object\");\nList < Map > data1 = dbop.select(\"select invoice_id,sum(amount) as b_amount,sum(invoice_amount) as b_invoice_amount from apps.cux3_eflow_ap_prepay_v where 1=1\" + s + \" group by invoice_id \", o);\nList < Map > dt1 = com.bokesoft.PooledData.pooleddata(payload, data1);\nreturn dt1;",
      "smallType": "GroovyScriptWithDS",
      "className": "com.bokesoft.exchange.transformer.ScriptWithDSTransformer",
      "enable": "true",
      "parentId": "8aab8dfa5f50f282015f515480ff0022",
      "bigType": "transformer_au",
      "simpleMpLog": "false",
      "ds": "8aaae09b5bf03e9f015bf17bc58e061f",
      "isRef": "false",
      "id": "8aaae0fb5f52393c015f523ebb5b0019"
    },
    {
      "text": "根据本地查询结果筛选本地核销核销信息并合并数据",
      "description": "根据本地查询结果筛选本地核销核销信息并合并数据",
      "scriptContent": "Map m = new HashMap();\nm = com.bokesoft.GetSqlStr.sqlinconnect(payload);\nString s = m.get(\"sql\");\nObject[] o = m.get(\"object\");\nList < Map > data2 = dbop.select(\"select invoice_id, sum(amount) as c_amount,sum(invoice_amount) as c_invoice_amount from bank_payment_result_mid where  1=1\" + s + \" group by invoice_id \", o);\nList < Map > dt2 = com.bokesoft.PooledDataList.pooleddata(payload, data2);\nreturn dt2;",
      "className": "com.bokesoft.exchange.transformer.ScriptWithDSTransformer",
      "smallType": "GroovyScriptWithDS",
      "enable": "true",
      "parentId": "8aab8dfa5f50f282015f515480ff0022",
      "bigType": "transformer_au",
      "simpleMpLog": "false",
      "ds": "2c9081d05be7e572015be80fcb64000f",
      "isRef": "false",
      "id": "8aaae0fb5f52393c015f524248da001a"
    },
    {
      "text": "计算金额合计与发票金额合计",
      "description": "计算金额合计与发票金额合计",
      "scriptContent": "List < Map > dt = com.bokesoft.ComputationalData.computationaldata(payload);\nreturn dt;",
      "className": "org.mule.module.scripting.transformer.ScriptTransformer",
      "smallType": "GroovyScriptTransformer",
      "enable": "true",
      "parentId": "8aab8dfa5f50f282015f515480ff0022",
      "bigType": "transformer_au",
      "simpleMpLog": "false",
      "isRef": "false",
      "id": "8aaae0fb5f52393c015f52503a780020"
    },
    {
      "ignoreSQLError": "false",
      "text": "更新本地银行付款单中间表发票金额",
      "description": "更新本地银行付款单中间表发票金额",
      "smallType": "ExecuteSQLSimpleTransformer",
      "className": "com.bokesoft.dee.transport.jdbc.transformer.ExecuteSQLSimpleTransformer",
      "enable": "true",
      "queries": "[{\"value\":\"update bank_payment_tmp_mid set amount = #[map-payload:abc_amount],invoice_amount=#[map-payload:abc_invoice_amount] where invoice_id =#[map-payload:invoice_id]\"}]",
      "parentId": "8aab8dfa5f50f282015f515480ff0022",
      "bigType": "transformer_au",
      "simpleMpLog": "false",
      "resultIndexOf": 0,
      "isRef": "false",
      "id": "8aaae0d05f5bc8b8015f5cc531d60112",
      "ds": "2c9081d05be7e572015be80fcb64000f"
    },
    {
      "ignoreSQLError": "false",
      "text": "更新或新增本地核销表发票信息",
      "description": "更新或新增本地核销表发票信息",
      "className": "com.bokesoft.dee.transport.jdbc.transformer.ExecuteSQLSaveOrUpdateTransformer",
      "smallType": "ExecuteSQLSaveOrUpdateTransformer",
      "updateQuery": "update bank_payment_result_mid set amount = #[map-payload:bc_amount],invoice_amount = #[map-payload:bc_invoice_amount] where invoice_id =#[map-payload:invoice_id]",
      "enable": "true",
      "parentId": "8aab8dfa5f50f282015f515480ff0022",
      "bigType": "transformer_au",
      "simpleMpLog": "false",
      "ds": "2c9081d05be7e572015be80fcb64000f",
      "isRef": "false",
      "id": "8aaae0fb5f52393c015f524c6e3f001f",
      "insertQuery": "insert into bank_payment_result_mid (invoice_id,item_type,amount,invoice_amount) values (#[map-payload:invoice_id],'预付款核销',#[map-payload:bc_amount],#[map-payload:bc_invoice_amount])"
    },
    {
      "text": "提交或者回滚JDBC事务",
      "description": "提交或者回滚数据库事务",
      "className": "com.bokesoft.dee.transport.transaction.FinishTxTransformer",
      "smallType": "FinishTxTransformer",
      "enable": "true",
      "parentId": "8aab8dfa5f50f282015f515480ff0022",
      "bigType": "GGPZTransformer",
      "isRef": "true",
      "id": "8aaae0fb5f52393c015f5266f099002a"
    }
  ],
  "exception": [
    {
      "text": "提交或者回滚JDBC事务",
      "description": "提交或者回滚数据库事务",
      "className": "com.bokesoft.dee.transport.transaction.FinishTxTransformer",
      "smallType": "FinishTxTransformer",
      "enable": "true",
      "parentId": "8aab8dfa5f50f282015f515480ff0022",
      "bigType": "GGPZTransformer",
      "isRef": "true",
      "id": "8aaae0d05f5bc8b8015f5c89e7a20088"
    },
    {
      "text": "把异常对象转换为文本",
      "description": "把异常对象转换为文本",
      "className": "com.bokesoft.exchange.transformer.ExceptionMessageTransformer",
      "smallType": "ExceptionMessageTransformer",
      "enable": "true",
      "parentId": "8aab8dfa5f50f282015f515480ff0022",
      "bigType": "GGPZTransformer",
      "isRef": "true",
      "id": "8aab8dfa5f50f282015f5154812c0023"
    },
    {
      "path": "${bokedee.logpath.runtimeLog}/ERP_BankPayment_TO_BPM",
      "text": "记录错误日志到文件_BPM_BankPayment_Tmp_MID",
      "description": "",
      "className": "",
      "smallType": "File",
      "enable": "true",
      "outputPattern": "#[function:datestamp:yyyyMMddHHmmss]-#[message:id].xml",
      "parentId": "8aab8dfa5f50f282015f515480ff0022",
      "bigType": "outbound",
      "file_subdir": "#[context:serviceName]/#[function:datestamp:yyyyMMdd]",
      "isRef": "false",
      "id": "8aab8dfa5f50f282015f5154819e0024"
    },
    {
      "text": "把异常信息替换换行符_BPM_BankPayment_Tmp_MID",
      "description": "把异常信息替换换行符",
      "scriptContent": "String exceptionContent = message.getPayload();String exception = exceptionContent.replace(\"\\n\", \"<br/>\");message.setPayload(exception);return message;",
      "smallType": "GroovyScriptTransformer",
      "className": "org.mule.module.scripting.transformer.ScriptTransformer",
      "enable": "false",
      "parentId": "8aab8dfa5f50f282015f515480ff0022",
      "bigType": "transformer_au",
      "simpleMpLog": "false",
      "isRef": "false",
      "id": "8aab8dfa5f50f282015f5154822c0025"
    },
    {
      "text": "把异常信息通过邮件发送_BPM_BankPayment_Tmp_MID",
      "description": "把异常信息通过邮件发送",
      "connector_ref": "bokedee_default_smtp_connector",
      "subject": "ERP_BankPayment_TO_BPM",
      "className": "",
      "smallType": "SMTP",
      "enable": "false",
      "parentId": "8aab8dfa5f50f282015f515480ff0022",
      "bigType": "outbound",
      "encoding": "UTF-8",
      "isRef": "false",
      "id": "8aab8dfa5f50f282015f5154829f0026"
    }
  ]
}
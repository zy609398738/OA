{
  "response": [
    {
      "text": "更新日志表",
      "description": "",
      "scriptContent": "String expMsg = \"\";\nMap rsmap = new HashMap();\nif (message.getExceptionPayload() != null)\n{\n    message.setOutboundProperty(\"http.status\", 200);\n    expMsg = message.getExceptionPayload().getRootException().getMessage();\n    if (expMsg.length() > 3500)\n    {\n        expMsg = expMsg.substring(0, 3000);\n    }\n    message.setExceptionPayload(null);\n    rsmap.put(\"code\", \"e\");\n    rsmap.put(\"msg\", \"同步失败！\");\n}\nelse\n{\n    rsmap.put(\"code\", \"s\");\n    rsmap.put(\"msg\", \"同步成功！\");\n    rsmap.put(\"data\", payload);\n}\nMap logmap = message.getInboundProperty(\"logmap\");\nObject[] o = new Object[10];\no[0] = logmap.get(\"flow\");\no[1] = logmap.get(\"node\");\no[2] = logmap.get(\"billkey\");\no[3] = logmap.get(\"oid\");\no[4] = logmap.get(\"begintime\");\no[5] = new java.text.SimpleDateFormat(\"yyyyMMdd HH:mm:ss.SSS\").format(new java.sql.Timestamp(java.lang.System.currentTimeMillis()));\no[6] = \"\";\no[7] = \"\";\no[8] = expMsg;\no[9] = \"interface_1\";\ndbop.saveOrUpdate(\"insert into TRINA_SL_INTERFACE_LOG(id,flow,node,billkey,oid,starttime,endtime,request_data,response_data,EXCEPTION,interface_type)values(Trina_SL_Interface_Log_ID_SEQ.Nextval,?,?,?,?,?,?,?,?,?,?)\", o, false);\nreturn com.bokesoft.dee.mule.util.json.JSONUtil.toJson(rsmap);",
      "smallType": "GroovyScriptWithDS",
      "className": "com.bokesoft.exchange.transformer.ScriptWithDSTransformer",
      "enable": "true",
      "parentId": "8aaae09b5bec52cb015bec564e490008",
      "bigType": "transformer_au",
      "simpleMpLog": "false",
      "ds": "2c9081d05be7e572015be80fcb64000f",
      "isRef": "false",
      "id": "8aaae09b5bf03e9f015bf11818b20249"
    }
  ],
  "normal": [
    {
      "text": "接收触发请求",
      "description": "",
      "address": "vm://PS_Operator_TO_BPM",
      "exchange_pattern": "request-response",
      "className": "",
      "smallType": "VM",
      "enable": "true",
      "parentId": "8aaae09b5bec52cb015bec564e490008",
      "bigType": "inbound",
      "simpleMpLog": "false",
      "encoding": "UTF-8",
      "isRef": "false",
      "id": "8aaae09b5bec52cb015bec571d3c000d"
    },
    {
      "text": "启动JDBC事务",
      "description": "启动数据库事务",
      "className": "com.bokesoft.dee.transport.transaction.StartTxTransformer",
      "smallType": "StartTxTransformer",
      "enable": "true",
      "parentId": "8aaae09b5bfa4119015bfa441f560007",
      "bigType": "GGPZTransformer",
      "isRef": "true",
      "id": "4028ab665da580fd015da590523a0012"
    },
    {
      "text": "记录起始时间",
      "description": "",
      "scriptContent": "String begintime = new java.text.SimpleDateFormat(\"yyyyMMdd HH:mm:ss.SSS\").format(new java.sql.Timestamp(java.lang.System.currentTimeMillis()));\nMap logmap = new HashMap();\nlogmap.put(\"begintime\", begintime);\nlogmap.put(\"flow\", payload.get(\"flow\"));\nlogmap.put(\"node\", payload.get(\"node\"));\nlogmap.put(\"oid\", payload.get(\"oid\"));\nlogmap.put(\"billkey\", payload.get(\"billkey\"));\nlogmap.put(\"request_data\", payload.get(\"json\"));\nmessage.setInboundProperty(\"logmap\", logmap);\ncom.bokesoft.InterfaceOperator.checkTransaction(dbop, \"PS_Operator_TO_BPM\");\nreturn payload;",
      "smallType": "GroovyScriptWithDS",
      "className": "com.bokesoft.exchange.transformer.ScriptWithDSTransformer",
      "enable": "true",
      "parentId": "8aaae09b5bec52cb015bec564e490008",
      "bigType": "transformer_au",
      "simpleMpLog": "false",
      "ds": "2c9081d05be7e572015be80fcb64000f",
      "isRef": "false",
      "id": "8aaae09b5bec52cb015bec58cd35000e"
    },
    {
      "text": "查询数据",
      "description": "",
      "scriptContent": "List < Map > data = dbop.select(\"Select b.USER_HRID,b.USER_NAME,b.USER_HRID,b.USER_NAME,b.USER_SEX,b.USER_SORT,b.HIRE_DT,b.USER_ACCESSIONSTATE,b.GRADE,b.JOB_INDICATOR,b.USER_SHIYONG_FLAG,b.NATIONALITY,b.USER_GROUP_ID,c.GROUP_NAME,b.COMPANY,b.COMPANY_DESCR,b.ACCOUNT_EC_ID,d.CC_NAME_APPROVE,d.CC_CODE_APPROVE,d.BU, 'trinasolar\\\\' || a.SAMACCOUNTNAME   As adaccount,a.SAMACCOUNTNAME || '@trinasolar.com' As email,a.displayname,b.LASTUPDDTTM,b.EFFDT,b.JOB_EFFDT,b.JOB_LASTUPDATE,b.ESTABID,b.ESTAB_NAME,b.GRADEID,b.POSITION_DESCR,b.POSITION_DESCR_ENG,b.COUNTRY,b.GHXX,b.XLATLONGNAME,b.POSITION_DESC,b.POSITION_DESC_ENG,b.LOCATION,b.LOCATION_DESCR,b.BANK_NAME,b.ACCOUNT_NAME,b.BIRTHDATE,b.TERMINATION_DT, e.Operation_ID, e.Operation_Name From ad_to_bpm_user_mid a Join ps_to_bpm_user_mid b On b.USER_HRID = a.EMPLOYEENUMBER And (b.USER_ACCESSIONSTATE = '在职' And a.ENABLED = 1) Join ps_to_bpm_group_mid c On b.USER_GROUP_ID = c.UNITID  left  Join (Select Case ps_to_bpm_dept_mid.REG_TEMP When 'S' Then '管理人员' When 'D' Then '直接生产人员' When 'I' Then '间接生产人员' End As sort,COMPANY,DEPTID,DEPT_NAME,BU,CC_CODE_APPROVE,CC_NAME_APPROVE From ps_to_bpm_dept_mid) d On b.USER_SORT = d.sort And (b.COMPANY = d.COMPANY And c.UNITID = d.DEPTID) left  join OU e on e.PS_Company_ID=b.COMPANY and (e.bu=d.bu) \", message);\nreturn data;",
      "smallType": "GroovyScriptWithDS",
      "className": "com.bokesoft.exchange.transformer.ScriptWithDSTransformer",
      "enable": "true",
      "parentId": "8aaae09b5bec52cb015bec564e490008",
      "bigType": "transformer_au",
      "simpleMpLog": "false",
      "ds": "2c9081d05be7e572015be80fcb64000f",
      "isRef": "false",
      "id": "8aaae09b5bec52cb015bec5c0f52000f"
    },
    {
      "fixFields": "[{\"key\":\"mule.adapter.thing-name\",\"value\":\"Dict_Employee\"},{\"key\":\"mule.adapter.formKey\",\"value\":\"Dict_Employee\"},{\"key\":\"mule.adapter.op-plan\",\"value\":\"insert-or-update\"},{\"key\":\"mule.adapter.id-fields\",\"value\":\"Code\"}]",
      "description": "",
      "text": "设置单据固定值",
      "tablePath": "OA_Employee_H",
      "className": "com.bokesoft.dee.mule.dataimport.FixFieldsAddTransformerForYigo2",
      "smallType": "FixFieldsAddTransformerForYigo2",
      "enable": "true",
      "parentId": "8aaae09b5bec52cb015bec564e490008",
      "bigType": "transformer_au",
      "simpleMpLog": "false",
      "isRef": "false",
      "rowNumColumn": "norowno",
      "id": "8aaae09b5bec52cb015bec6f480b0019"
    },
    {
      "text": "查询人员对应部门信息",
      "description": "",
      "tablePath": "OA_Employee_H",
      "className": "com.bokesoft.dee.mule.dataimport.MutiFieldValueLookUpWithDsTransformer",
      "smallType": "MutiFieldValueLookUpWithDsTransformer",
      "firstRecode": "true",
      "enable": "true",
      "parentId": "8aaae09b5bfa4119015bfa441f560007",
      "queries": "[{\"value\":\"select oid as DeptID from Oa_Department_h where code=#[map-payload:USER_GROUP_ID?]\"}]",
      "bigType": "transformer_au",
      "simpleMpLog": "false",
      "ds": "2c9081d05be7e572015be80fcb64000f",
      "isRef": "false",
      "id": "ff8080815c37d627015c3999a21301e2"
    },
    {
      "isInTransaction": "true",
      "id": "8aaae09b5bec52cb015bec7e24e7001e",
      "text": "设置映射关系",
      "description": "",
      "connectTimeout": "3000",
      "isThrowException": "true",
      "smallType": "MapKeyMapping",
      "className": "com.bokesoft.dee.mule.yigo2.transformer.MapKeyMapping",
      "fieldExpression": "[{\"one\":\"user_hrid\",\"two\":\"Code\",\"three\":\"0\",\"four\":\"1\",\"five\":\"user_hrid\"},{\"one\":\"user_name\",\"two\":\"Name\",\"three\":\"0\",\"four\":\"1\",\"five\":\"user_name\"},{\"one\":\"user_hrid\",\"two\":\"User_HRID\",\"three\":\"0\",\"four\":\"1\",\"five\":\"user_hrid\"},{\"one\":\"user_name\",\"two\":\"User_Name\",\"three\":\"0\",\"four\":\"1\",\"five\":\"user_name\"},{\"one\":\"user_sex\",\"two\":\"Sex\",\"three\":\"0\",\"four\":\"1\",\"five\":\"user_sex\"},{\"one\":\"user_sort\",\"two\":\"User_Sort\",\"three\":\"0\",\"four\":\"1\",\"five\":\"user_sort\"},{\"one\":\"hire_dt\",\"two\":\"HIRE_DT\",\"three\":\"0\",\"four\":\"1\",\"five\":\"hire_dt\"},{\"one\":\"user_accessionstate\",\"two\":\"User_AccessionState\",\"three\":\"0\",\"four\":\"1\",\"five\":\"user_accessionstate\"},{\"one\":\"grade\",\"two\":\"Grade\",\"three\":\"0\",\"four\":\"1\",\"five\":\"grade\"},{\"one\":\"job_indicator\",\"two\":\"Job_Indicator\",\"three\":\"0\",\"four\":\"1\",\"five\":\"job_indicator\"},{\"one\":\"user_shiyong_flag\",\"two\":\"User_shiyong_Flag\",\"three\":\"0\",\"four\":\"1\",\"five\":\"user_shiyong_flag\"},{\"one\":\"nationality\",\"two\":\"Nativeplace\",\"three\":\"0\",\"four\":\"1\",\"five\":\"nationality\"},{\"one\":\"user_group_id\",\"two\":\"User_Group_ID\",\"three\":\"0\",\"four\":\"1\",\"five\":\"user_group_id\"},{\"one\":\"group_name\",\"two\":\"Group_Name\",\"three\":\"0\",\"four\":\"1\",\"five\":\"group_name\"},{\"one\":\"company\",\"two\":\"Company\",\"three\":\"0\",\"four\":\"1\",\"five\":\"company\"},{\"one\":\"company_descr\",\"two\":\"Company_Descr\",\"three\":\"0\",\"four\":\"1\",\"five\":\"company_descr\"},{\"one\":\"account_ec_id\",\"two\":\"Account_EC_ID\",\"three\":\"0\",\"four\":\"1\",\"five\":\"account_ec_id\"},{\"one\":\"cc_name_approve\",\"two\":\"CC_Name_Approve\",\"three\":\"0\",\"four\":\"1\",\"five\":\"cc_name_approve\"},{\"one\":\"cc_code_approve\",\"two\":\"CC_Code_Approve\",\"three\":\"0\",\"four\":\"1\",\"five\":\"cc_code_approve\"},{\"one\":\"bu\",\"two\":\"BU\",\"three\":\"0\",\"four\":\"1\",\"five\":\"bu\"},{\"one\":\"adaccount\",\"two\":\"ADAccount\",\"three\":\"0\",\"four\":\"1\",\"five\":\"adaccount\"},{\"one\":\"email\",\"two\":\"Email\",\"three\":\"0\",\"four\":\"1\",\"five\":\"email\"},{\"one\":\"lastupddttm\",\"two\":\"Lastupddttm\",\"three\":\"0\",\"four\":\"1\",\"five\":\"lastupddttm\"},{\"one\":\"effdt\",\"two\":\"Effdt\",\"three\":\"0\",\"four\":\"1\",\"five\":\"effdt\"},{\"one\":\"job_effdt\",\"two\":\"Job_Effdt\",\"three\":\"0\",\"four\":\"1\",\"five\":\"job_effdt\"},{\"one\":\"job_lastupdate\",\"two\":\"Job_LastUpdate\",\"three\":\"0\",\"four\":\"1\",\"five\":\"job_lastupdate\"},{\"one\":\"estabid\",\"two\":\"EstabID\",\"three\":\"0\",\"four\":\"1\",\"five\":\"estabid\"},{\"one\":\"estab_name\",\"two\":\"Estab_Name\",\"three\":\"0\",\"four\":\"否\",\"five\":\"estab_name\"},{\"one\":\"gradeid\",\"two\":\"GradeID\",\"three\":\"0\",\"four\":\"1\",\"five\":\"gradeid\"},{\"one\":\"position_descr\",\"two\":\"Position_Descr\",\"three\":\"0\",\"four\":\"1\",\"five\":\"position_descr\"},{\"one\":\"position_descr_eng\",\"two\":\"Position_Descr_Eng\",\"three\":\"0\",\"four\":\"1\",\"five\":\"position_descr_eng\"},{\"one\":\"country\",\"two\":\"Country\",\"three\":\"0\",\"four\":\"1\",\"five\":\"country\"},{\"one\":\"ghxx\",\"two\":\"Ghxx\",\"three\":\"0\",\"four\":\"1\",\"five\":\"ghxx\"},{\"one\":\"xlatlongname\",\"two\":\"XlatlongName\",\"three\":\"0\",\"four\":\"1\",\"five\":\"xlatlongname\"},{\"one\":\"position_desc\",\"two\":\"Position_Desc\",\"three\":\"0\",\"four\":\"1\",\"five\":\"position_desc\"},{\"one\":\"position_desc_eng\",\"two\":\"Position_Desc_Eng\",\"three\":\"0\",\"four\":\"1\",\"five\":\"position_desc_eng\"},{\"one\":\"location\",\"two\":\"Location\",\"three\":\"0\",\"four\":\"1\",\"five\":\"location\"},{\"one\":\"location_descr\",\"two\":\"Location_Descr\",\"three\":\"0\",\"four\":\"1\",\"five\":\"location_descr\"},{\"one\":\"bank_name\",\"two\":\"Bank_Name\",\"three\":\"0\",\"four\":\"1\",\"five\":\"bank_name\"},{\"one\":\"account_name\",\"two\":\"Account_Name\",\"three\":\"0\",\"four\":\"1\",\"five\":\"account_name\"},{\"one\":\"birthdate\",\"two\":\"BirthDate\",\"three\":\"0\",\"four\":\"1\",\"five\":\"birthdate\"},{\"one\":\"termination_dt\",\"two\":\"Termination_dt\",\"three\":\"0\",\"four\":\"1\",\"five\":\"termination_dt\"},{\"one\":\"deptid\",\"two\":\"DeptID\",\"three\":\"0\",\"four\":\"1\",\"five\":\"deptid\"},{\"one\":\"operation_id\",\"two\":\"Operation_ID\",\"three\":\"0\",\"four\":\"1\",\"five\":\"operation_id\"},{\"one\":\"operation_name\",\"two\":\"Operation_Name\",\"three\":\"0\",\"four\":\"1\",\"five\":\"operation_name\"},{\"one\":\"displayname\",\"two\":\"DisplayName\",\"three\":\"0\",\"four\":\"1\",\"five\":\"displayname\"}]",
      "enable": "true",
      "parentId": "8aaae09b5bec52cb015bec564e490008",
      "bigType": "transformer_au",
      "simpleMpLog": "false",
      "readTimeout": "30000",
      "yigoUrl": "BD{yigo_url}",
      "isRef": "false"
    },
    {
      "isInTransaction": "true",
      "yigoUrl": "BD{YIGO2_URL}",
      "text": "导入数据到YIGO系统",
      "description": "导入数据到YIGO系统",
      "connectTimeout": 6000,
      "id": "ff8080815e32a3a2015e32b055490019",
      "className": "",
      "smallType": "YIGO2.0",
      "enable": "true",
      "parentId": "8aaae09b5bfa4119015bfa441f560007",
      "bigType": "outbound",
      "simpleMpLog": "false",
      "readTimeout": 60000,
      "isRef": "false",
      "isThrowException": "true"
    },
    {
      "text": "提交或者回滚JDBC事务",
      "description": "提交或者回滚数据库事务",
      "smallType": "FinishTxTransformer",
      "className": "com.bokesoft.dee.transport.transaction.FinishTxTransformer",
      "enable": "true",
      "parentId": "8aaae09b5bfa4119015bfa441f560007",
      "bigType": "GGPZTransformer",
      "isRef": "true",
      "id": "4028ab665da580fd015da5907fbb0013"
    }
  ],
  "exception": [
    {
      "text": "提交或者回滚JDBC事务",
      "description": "提交或者回滚数据库事务",
      "className": "com.bokesoft.dee.transport.transaction.FinishTxTransformer",
      "smallType": "FinishTxTransformer",
      "enable": "true",
      "parentId": "8aaae09b5bfa4119015bfa441f560007",
      "bigType": "GGPZTransformer",
      "isRef": "true",
      "id": "4028ab665da580fd015da590b74d0014"
    },
    {
      "text": "把异常对象转换为文本",
      "description": "把异常对象转换为文本",
      "smallType": "ExceptionMessageTransformer",
      "className": "com.bokesoft.exchange.transformer.ExceptionMessageTransformer",
      "enable": "true",
      "parentId": "8aaae09b5bec52cb015bec564e490008",
      "bigType": "GGPZTransformer",
      "isRef": "true",
      "id": "8aaae09b5bec52cb015bec564e6c0009"
    },
    {
      "path": "${bokedee.logpath.runtimeLog}/PS_Operator_TO_BPM.copy",
      "text": "记录错误日志到文件",
      "description": "",
      "smallType": "File",
      "className": "",
      "enable": "true",
      "outputPattern": "#[function:datestamp:yyyyMMddHHmmss]-#[message:id].xml",
      "parentId": "8aaae09b5bec52cb015bec564e490008",
      "bigType": "outbound",
      "file_subdir": "#[context:serviceName]/#[function:datestamp:yyyyMMdd]",
      "simpleMpLog": "false",
      "isRef": "false",
      "id": "8aaae09b5bec52cb015bec564ec6000a"
    },
    {
      "text": "把异常信息替换换行符",
      "description": "把异常信息替换换行符",
      "scriptContent": "String exceptionContent = message.getPayload();String exception = exceptionContent.replace(\"\\n\", \"<br/>\");message.setPayload(exception);return message;",
      "className": "org.mule.module.scripting.transformer.ScriptTransformer",
      "smallType": "GroovyScriptTransformer",
      "enable": "false",
      "parentId": "8aaae09b5bec52cb015bec564e490008",
      "bigType": "transformer_au",
      "simpleMpLog": "false",
      "isRef": "false",
      "id": "8aaae09b5bec52cb015bec564f21000b"
    },
    {
      "text": "把异常信息通过邮件发送",
      "description": "把异常信息通过邮件发送",
      "connector_ref": "bokedee_default_smtp_connector",
      "subject": "TimeSyctoYigo",
      "className": "",
      "smallType": "SMTP",
      "enable": "false",
      "parentId": "8aaae09b5bec52cb015bec564e490008",
      "bigType": "outbound",
      "simpleMpLog": "false",
      "encoding": "UTF-8",
      "isRef": "false",
      "id": "8aaae09b5bec52cb015bec564f85000c"
    }
  ]
}